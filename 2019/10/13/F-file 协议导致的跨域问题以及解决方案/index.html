<!-- build time:Sun Nov 24 2019 12:28:46 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>PureBlue</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third party/pace-theme-flash.css"><link rel="icon" href="/images/me.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">PureBlue</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">file 协议导致的跨域问题以及解决方案</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2019-10-13&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp833&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp3 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/file%20%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/file%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-0.webp" alt=""></p><a id="more"></a><p>问题复现：<br>学习 ES6 模块化的时候，写了这段代码：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./aaa.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./bbb.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./aaa2.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>结果跑到 chrome 下面一看，报错了：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/file%20%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/file%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-1.png" alt=""></p><p>看起来是跨域问题，也就是只支持 <code>http</code>，<code>https</code> 等这种类型的跨域请求，不支持 <code>file</code> 协议类型的（直接本地打开文件）。解决方案如下：</p><p>1.给 chrome 快捷方式添加参数：<br><code>–allow-file-access-from-files</code><br>实测无效。貌似还得重启电脑，太麻烦了，遂放弃。</p><p>2.换浏览器。经过测试，Edge 可以正常显示，但 FireFox 还是报跨域错误：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/file%20%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/file%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-2.png" alt=""></p><p>3.用 IDE。像 Webstrom 这类型的 IDE 是内置 http 服务器的，这样可以不通过 <code>file</code> 协议打开文件，不过这个还是有点麻烦，我没尝试。</p><p>4.使用热更新插件。刚好想起编辑器里安装了 live server 这个插件，这个其实是做同步刷新用的，但是由于它可以在本地开启一个服务器，所以可以利用这一点（localhost 访问）。尝试之后发现确实不报错了。</p><p>5.Node 开一个服务器</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// server.js</span>
<span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>root<span class="token punctuation">:</span>__dirname<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8203</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>问题是解决了，但总觉得心里不踏实，所以开始了艰苦的 google 之旅，最后算是找到了问题的根源。但我还是想从同源策略开始解释：</p><blockquote><p>同源策略（Same origin policy），是出于安全而诞生的一种约定，规定了只能在本域内进行资源访问。所谓同源是指”协议+域名+端口”三者相同。</p></blockquote><p>不同源之间进行资源访问，就需要跨域。特殊地，有三个标签默认是允许跨域加载资源的：</p><ul><li><code>&lt;img src=&quot;xxx&quot;&gt;</code></li><li><code>&lt;link href=&quot;xxx&quot;&gt;</code></li><li><code>&lt;script src=&quot;xxx&quot;&gt;</code></li></ul><p>关键来了，ES6 使用模块的时候要在标签中声明 <code>type=&quot;module&quot;</code>，而这类<strong>使用了模块的 <code>script</code> 是受限于同源策略的</strong>。我们尝试改动之前的代码如下：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./aaa.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">defer</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>defer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./bbb.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">defer</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>defer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./ccc.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">defer</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>defer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/file%20%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/file%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-3.png" alt=""></p><p>可以看到，前面两个 <code>script</code> 使用了模块，<code>Sec-Fetch-Mode</code> 都是 <code>cors</code>，而最后一个就是常规的引入脚本，不受同源策略影响，因此是 <code>no-cors</code>。</p><p>我们可以理解为前两个 <code>scirpt</code> 发送了 Cors 跨域资源请求，而这种请求要求 request header 的 origin 必须合法 —— 也就是必须带有 <code>http</code>，<code>https</code> 等，以用来表明请求源。</p><p>但是别忘了，我们现在是在本地打开文件，使用的不是 <code>http</code> 协议，而是 <code>file</code> 协议，它根本就没有跨域请求需要的 <code>origin</code>（注意看上图，<code>origin</code> 是空的）。所以，这种情况就要报错了。其实从报错信息中也能读出这一点。</p><p>那么，我们现在用 live server 在本地开启服务器，再看一下控制台：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/file%20%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/file%E5%8D%8F%E8%AE%AE%E5%AF%BC%E8%87%B4%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-4.png" alt=""></p><p>可以看到，因为这次不是用 <code>file</code> 协议访问了，所以一切正常。</p><p>参考：<br><a href="https://www.sitepoint.com/understanding-es6-modules/" target="_blank" rel="noopener">Understanding ES6 Modules</a><br><a href="https://stackoverflow.com/questions/46992463/es6-module-support-in-chrome-62-chrome-canary-64-does-not-work-locally-cors-er" target="_blank" rel="noopener">ES6 module support in Chrome 62/Chrome Canary 64, does not work locally, CORS error</a><br><a href="https://stackoverflow.com/questions/41965066/access-to-image-from-origin-null-has-been-blocked-by-cors-policy" target="_blank" rel="noopener">Access to Image from origin ‘null’ has been blocked by CORS policy</a></p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2019/10/18/F-前端模块化/" rel="prev" title="前端模块化"><i class="fa fa-angle-double-left"></i>&nbsp前端模块化</a></div><div class="post-nav-next"><a href="/2019/10/10/Trs-一个案例搞懂 Vue.js 的作用域插槽/" rel="next" title="「译」一个案例搞懂 Vue.js 的作用域插槽">「译」一个案例搞懂 Vue.js 的作用域插槽&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - 2019 My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->