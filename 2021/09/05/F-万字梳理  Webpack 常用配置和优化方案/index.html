<!-- build time:Sun Nov 28 2021 10:22:26 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">万字梳理 Webpack 常用配置和优化方案</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2021-09-05&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp10.9k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp44 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Webpack%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/webpack%E5%AD%A6%E4%B9%A0-0-1.png"></div><span id="more"></span><p>以下是本文的思维导图：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/8.png"></div><blockquote><p>环境： webpack v4.46.0，Nodejs v16.6.2</p></blockquote><h2 id="安装">安装</h2><p>新建项目文件夹并安装 webpack 和 webpack-cli：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> project
<span class="token builtin class-name">cd</span> project
<span class="token function">npm</span> init -y
<span class="token function">npm</span> <span class="token function">install</span> webpack@4.46.0 webpack-cli@3.3.2 --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在项目根目录下新建 <code>webpack.config.js</code>，作为 webpack 的默认配置文件。</p><h2 id="核心概念">核心概念</h2><h3 id="modulechunk-和-bundle">module、chunk 和 bundle</h3><p>用一张图来方便理解：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/1.png"></div><p>简单地说，module 是任何通过 import 或者 require 导入的代码，包括 js、css、图片资源等；多个 module 可以组成一个 chunk，每个 chunk 经过处理后会输出一个 bundle 文件</p><h3 id="entry-和-output">entry 和 output</h3><p><strong>1）单入口单出口</strong></p><p>以 src 目录下的 <code>index.js</code> 作为入口文件，打包输出文件 <code>bundle.js</code> 到 dist 目录下</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'bundle.js'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种配置一般用于单页应用，最终只会产生一个 chunk。</p><p><strong>2）多入口单出口</strong></p><p>对应的 <code>entry</code> 改用数组：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/index1.js'</span><span class="token punctuation">,</span><span class="token string">'./src/index2.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'bundle.js'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种配置一般用于多页应用，但最终也只会产生一个 chunk。</p><p><strong>3）多入口多出口</strong></p><p>对应的 <code>enrty</code> 改用对象，key 表示打包后输出文件的名字，<code>output.filename</code> 中用占位符表示这个名字：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        bundle1<span class="token operator">:</span> <span class="token string">'./src/index1.js'</span><span class="token punctuation">,</span>
        bundle2<span class="token operator">:</span> <span class="token string">'./src/index2.js'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'[name].js'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种配置一般用于多页应用，且最终会产生多个 chunk。</p><h3 id="mode">mode</h3><p>指定 webpack 进行打包构建的环境是开发环境还是生产环境 —— 根据环境的不同，webpack 会默认开启不同的优化选项。</p><h3 id="loader">loader</h3><p>loader 相当于是一个转换器。webpack 默认只能解析 js / json 文件，对于其他类型的文件需要借助 loader 进行转换，之后才能解析。</p><h3 id="plugin">plugin</h3><p>webpack 执行打包构建的生命周期中会触发很多事件，plugin 监听某些事件并执行那些 loader 做不了的特定任务。</p><h2 id="易混淆的配置项">易混淆的配置项</h2><h3 id="filename-和-chunkfilename">filename 和 chunkFilename</h3><p>filename 很好理解，就是 entry 入口文件对应输出文件的名字，而 chunkFilename 指的是没有被列入 entry 中，但<strong>在某些情况下</strong>又不得不单独打包输出的文件的名字。</p><p>典型的例子就是动态加载模块，比如说入口文件 index.js 如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 注意这里使用了魔法注释指定了 chunk 名</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'/* webpackChunkName: "test"*/ ./test.js'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>webpack 的配置如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        index<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    	path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>
        chunkFilename<span class="token operator">:</span> <span class="token string">'[name].chunk.js'</span>    
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打包后，entry 入口文件会对应产生一个叫做 index 的 chunk，同时输出一个叫做 index.js 的 bundle 文件。而 test.js 是动态加载的，它会被单独打包到另一个叫做 test （通过魔法注释指定）的 chunk 中，同时输出一个叫做 test.chunk.js 的文件。</p><h3 id="path-和-publicpath">path 和 publicPath</h3><p>path 很好理解，就是 entry 入口文件对应输出文件的路径，而 publicPath 指的是引用静态资源时的固定前缀。项目上线后通常可以配置 publicPath 为一个 cdn 地址，这样就可以引用部署到 cdn 上的静态资源了。</p><h3 id="hashcontenthash-和-chunkhash">hash、contenthash 和 chunkhash</h3><p>配置 bundle 文件名的时候，通常可以使用 <code>xxx.[hash].js</code> 这样的命名形式，这里的占位符可以使用 hash、chunkhash 以及 contenthash。</p><p>这三个 hash 通常和 CDN 缓存有关，代码改变触发文件 hash 改变，hash 改变导致资源引用的 URL 改变，从而触发 CDN 回源从服务器重新拉取最新的资源。</p><p>以多页面应用为例，假设有 A、B 两个页面。</p><ul><li>hash：是项目编译层面的 hash，全局一致，任何文件的修改都会导致它发生改变。这意味着 A 页面文件的改变会导致整体 hash 改变，从而影响采用了 hash 命名的 B 页面文件，这样是无法实现静态资源缓存的</li><li>chunkhash：是 chunk 层面的 hash，每个入口页面对应一个 chunk，其产生的相关 bundle 共用同一个 chunkhash。修改 A 页面文件只会影响 chunk A，不会影响 chunk B</li><li>contenthash：是单文件层面的 hash，粒度要更精细。假设 A 页面中的 js 引用了 css，那么 js 文件改变所导致的 chunkhash 改变也会作用到 css 文件上，因此这时候的做法是利用 plugin 抽离出 css，并采用 contenthash 命名，标志每一个单独的文件</li></ul><p>PS：另外需要注意的是，chunkhash/contenthash 和 HMR 热更新不能一起使用。因为热更新针对的是开发环境，chunkhash 以及 contenthash 针对的是生产环境（涉及到 CDN 缓存）。</p><h2 id="资源解析">资源解析</h2><h3 id="解析-es6-语法">解析 ES6 语法</h3><p>安装 babel 相关依赖（<code>preset-env</code> 对应的是 ES6 的 preset）：</p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">cd project
npm install babel-loader @babel&#x2F;core @babel&#x2F;preset-env --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>项目根目录下增加 <code>.babelrc</code> 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span>
    <span class="token string">"presets"</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token string">"@babel/preset-env"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加 <code>module.rules</code> 项，配置 loader：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span><span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>test<span class="token operator">:</span> <span class="token string">'/\.js$/'</span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="解析-css-和-lesssassstylus">解析 CSS 和 LESS/SASS/Stylus</h3><p>以加载和解析 less 文件为例。less-loader 将 less 文件解析为 css 文件，css-loader 解析 css 文件，style-loader 将 css 文件中的样式注入到 style 标签中。</p><p>安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 注意 <span class="token function">less</span> 属于 less-loader 的 peerDependencies，npm 会自动安装
<span class="token function">npm</span> i less-loader css-loader style-loader -D<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">,</span>
                <span class="token comment">// 注意要按照从右到左依赖的顺序编写</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">,</span><span class="token string">'less-loader'</span><span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="解析图片和字体">解析图片和字体</h3><p>解析图片或者字体需要用到 file-loader：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span><span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|gif|svg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token string">'file-loader'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>url-loader 是对 file-loader 的封装，可以提供 <code>limit</code> 参数：当图片体积小于 limit 参数的时候，使用 url-loader 进行处理，会用 base64 对图片进行编码，通过 dataUrl 引用图片；否则使用 file-loader 进行处理。注意这里一定要设置 <code>esModule: false</code>，否则图片和字体默认会被视为 ES 模块，无法在页面中正常引用。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span><span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|svg|jpg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
                    loader<span class="token operator">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>
                    options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                        limit<span class="token operator">:</span> <span class="token number">4000</span><span class="token punctuation">,</span>
                        esModule<span class="token operator">:</span> <span class="token boolean">false</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="资源内联">资源内联</h2><p>资源内联可以提高项目文件的可维护程度，并减少请求数量。以多页面应用为例，假如每个页面都有公用的 meta 信息，不可能每个 <code>.html</code> 文件都去写一遍，这时候就可以把 meta 信息集中到一个 <code>meta.html</code> 中，在需要用到的页面内联进去即可。</p><h3 id="源文件内联html-和-js">源文件内联：HTML 和 JS</h3><p>内联 HTML 和 JS 可以使用 raw-loader@0.5.1。</p><p><code>inline.html</code> 文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>我是内联 HTML 文件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>inline.js</code> 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">'我是内联 JS 文件'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>模板 HTML 文件：</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token comment">&lt;!-- html-webpack-plugin 支持解析 ejs 语法 --></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>我是模板 HTML 文件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-loader!./inline.html'</span><span class="token punctuation">)</span></span><span class="token delimiter punctuation">%></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
	<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-loader!babel-loader!./inline.js'</span><span class="token punctuation">)</span></span><span class="token delimiter punctuation">%></span></span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构建后生成的 <code>index.html</code> 文件：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>我是模板 HTML 文件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>我是内联 HTML 文件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">'我是内联 JS 文件'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PS：这里之所以要使用 0.5.1 版本的 raw-loader，是因为这个版本的 raw-loader 默认采用 CJS 的模块导出方案，所以可以使用 require 直接导入；之后的版本则默认采用 ES Module 导出方案，如果想使用高版本，有两种方法：</p><ul><li>通过 <code>&lt;%= require('...').default %&gt;</code> require 一个 ES6 模块</li><li>修改 raw-loader 源代码，默认导出方式改为采用 CJS</li></ul><h3 id="源文件内联css">源文件内联：CSS</h3><p>两种方案：</p><ul><li>方案一：直接使用上面提到的 style-loader，通过 JS 将样式动态注入到 <code>style</code> 中，这种方式下构建产物中不会直接出现样式代码；</li><li>方案二：先使用 mini-css-extract-plugin 抽离出 css 文件到构建产物中，并且在 html 文件中通过 link 引用该 css，再使用 html-inline-css-webpack-plugin 将对于 css 文件的 link 引用转化为内联形式。下面介绍第二种方案。</li></ul><p>安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i mini-css-extract-plugin html-inline-css-webpack-plugin -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HTMLInlineCSSWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-inline-css-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 先导出成 css 文件，通过 link 引用</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 再将 link 引用转化为内联形式</span>
        <span class="token keyword">new</span> <span class="token class-name">HTMLInlineCSSWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    module<span class="token operator">:</span><span class="token punctuation">&#123;</span>
      rules<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
              test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
              loader<span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token comment">// 这里必须开启 plugin 的 loader</span>
                  MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
    			  <span class="token string">'css-loader'</span>	
              <span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span>  
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：</p><ul><li>需要同时配置 loader 和 plugin。另外， <code>MiniCssExtractPlugin.loader</code> 和 <code>style-loader</code> 功能上是冲突的，不能一起使用</li><li>require 的时候需要使用 <code>require(..).default</code>，因为 html-inline-css-webpack-plugin 导出方式是采用 ES Module。</li><li>默认情况下，使用了 html-inline-css-webpack-plugin 之后，不会保留由 mini-css-extract-plugin 导出的 css 文件</li></ul><h3 id="构建产物内联css-和-js">构建产物内联：CSS 和 JS</h3><p>前面讲的内联，都是内联 src 下的文件到 html 中，那么有没有办法可以将 bundle 中的 css 和 js 文件内联到 html 中呢？这就要使用 html-webpack-inline-source-plugin 了。</p><p>它是 html-webpack-plugin 的一个插件，所以两者都要安装。之后进行配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 正则匹配需要内联的文件</span>
            inlineSource<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(js|css)$</span><span class="token regex-delimiter">/</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 注意这里必须传参</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackInlineSourcePlugin</span><span class="token punctuation">(</span>HtmlWebpackPlugin<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PS：注意必须指定安装 <span class="citation">@1.0.0-beta.2</span> 版本的 plugin，npm 默认安装的是旧版本，有 bug。</p><h3 id="图片和字体内联">图片和字体内联</h3><p>图片和字体的内联，其实就是使用前面提到过的 url-loader，注意需要设置 <code>esModule: false</code>。</p><h2 id="开发和构建体验">开发和构建体验</h2><h3 id="文件监听">文件监听</h3><p>文件监听也就是 watch mode。开启文件监听后，每次源代码发生更改，都会<strong>自动重新进行构建</strong>。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    watch<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    watchOptions<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        ignored<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        aggregateTimeout<span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
        poll<span class="token operator">:</span> <span class="token number">1000</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>文件监听的原理是轮询文件的“最后一次编辑时间”是否改变。<code>ignored</code> 指定忽略监听的文件或者文件夹；<code>poll</code> 表示每秒轮询多少次；此外，并不是文件一更改就马上重新构建，必须是在 <code>aggregateTimeout</code> 指定的时间内没有再次更改之后，才会重新构建，有点类似于做了一层防抖处理，避免频繁构建。</p><h3 id="热重载">热重载</h3><p>热重载也就是 live reload，可以在每次源代码发生更改时<strong>自动重新进行构建 + 自动刷新浏览器</strong>。这里需要使用 webpack-dev-server 实现热重载。</p><p>安装：</p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">npm i webpack-dev-server -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 package.json 中配置指令：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span>
    <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"dev"</span><span class="token operator">:</span> <span class="token string">"webpack-dev-server"</span>             <span class="token comment">// npm run dev 运行开启本地服务器</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置 webpack-dev-server：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                    <span class="token comment">// 构建完成后自动打开浏览器</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>                    <span class="token comment">// 监听端口</span>
        contentBase<span class="token operator">:</span> <span class="token string">'./dist'</span>          <span class="token comment">// 服务器根路径</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="热更新">热更新</h3><p>热重载也有缺点，就是每次都会全局刷新浏览器，所有的状态都会重置。所以在热重载的基础上引入了热更新 —— 也就是 HMR（模块热替换），它既可以实现局部视图刷新，也可以保存数据状态。这里需要使用 webpack 内置的 HotModuleReplacementPlugin 实现热更新。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        hot<span class="token operator">:</span> <span class="token boolean">true</span>                 <span class="token comment">// 开启热更新</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="开启-sourcemap">开启 sourcemap</h3><p>在生产环境下（<code>mode: production</code>），打包后的文件都是经过压缩的，代码出错后不容易调试。而开启 sourcemap 之后，可以直接定位到出错的源代码，调试就很方便了。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    mode<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
    devtool<span class="token operator">:</span> <span class="token string">'sourcemap'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="代理跨域请求">代理跨域请求</h3><p>本地开发的时候我们会起一个 http://localhost:8080 的服务器，这时候请求后端接口 http://mysite/api/getData会报跨域错误。此时可以通过 webpack-dev-server 配置一层与本地服务器同源的代理服务器，它会接受请求，再将请求转发给真正的后端服务器（同源仅作用于浏览器和服务器之间，所以这个转发是没问题的）。</p><p>举个例子，这是我们发起的请求：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/getData/'</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这是 webpack-dev-server 的跨域配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        proxy<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'/api'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                target<span class="token operator">:</span> <span class="token string">'http://mysite'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们发起请求的 url <code>/api/getData/</code> 会自动加上同源前缀，变成 http://localhost/api/getData，相当于现在是向同源的代理服务器发起请求；又由于 url 可以匹配 <code>/api</code>，所以这个请求会被进一步转发给真正的后端服务器，相当于发起 http://mysite/api/getData 这个请求。</p><h3 id="自动引用构建产物">自动引用构建产物</h3><p>默认情况下，我们可能需要在 dist 目录下手动创建一个 html 文件去引用构建产物，这是比较麻烦的。通过 html-webpack-plugin，可以在 dist 目录下自动生成一个引用构建产物（资源）的 html 文件。</p><p>安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i html-webpack-plugin -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 提供一个模板 html 文件作为基础</span>
            tamplate<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.html'</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="优化构建日志的显示">优化构建日志的显示</h3><p>构建日志中可能包含很多我们并不关心的信息，可以借助 plugin 优化一下。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i friendly-errors-webpack-plugin -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> friendlyErrorsWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'friendly-errors-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	stats<span class="token operator">:</span> <span class="token string">'errors-only'</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        stats<span class="token operator">:</span> <span class="token string">'errors-only'</span>
    <span class="token punctuation">&#125;</span>
	plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">friendlyErrorsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="捕获构建错误">捕获构建错误</h3><p>每次构建结束后会触发 compiler 对象的 done 钩子函数，可以在这个 hook 中捕获构建错误并进行相关处理：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>errors <span class="token operator">&amp;&amp;</span>
                    stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> 
                    process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--watch'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 进行相关处理</span>
                    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="分离配置文件">分离配置文件</h3><p>开发应用的时候一般有两种环境，一个是方便开发调试的开发环境，一个是上线后给用户使用的生产环境。不同的环境，webpack 的配置也不同，比如生产环境需要配置代码压缩，开发环境需要配置热更新等。我们现在是共用一个 webpack.config.js 文件，所以需要解决的问题是：<strong>如何根据不同环境使用不同的 webpack 配置文件</strong>？</p><h4 id="方案一-cross-env-node_env">方案一： cross-env + NODE_ENV</h4><p>我们的基本策略是分离三个配置文件：</p><ul><li>webpack.base.js：开发环境和生产环境共用的配置放在这里</li><li>webpack.dev.js：开发环境专用的配置放在这里</li><li>webpack.prod.js：生产环境专用的配置放在这里</li></ul><p>node 有一个 process 对象，我们在 <code>process.env</code> 上挂载一个 <code>NODE_ENV</code> 环境变量，用来标记当前是什么环境。因为不同操作系统设置环境变量的方式不同，为了方便统一设置，这里使用 cross-env 这个库。接着，我们在所有文件中都可以通过 <code>node.env.NODE_ENV</code> 获取当前环境类型。</p><p>package.json 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 运行 build 肯定是构建打包，所以设置为生产环境，并使用指定文件作为配置文件</span>
    <span class="token string">"build"</span><span class="token operator">:</span> cross<span class="token operator">-</span>env <span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'production'</span> webpack <span class="token operator">--</span>config webpack<span class="token punctuation">.</span>prod<span class="token punctuation">.</span>js
    <span class="token comment">// 运行 dev 肯定是构建调试，所以设置为开发环境，并使用指定文件作为配置文件</span>
    <span class="token string">"dev"</span><span class="token operator">:</span> cross<span class="token operator">-</span>env <span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'development'</span> webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server webpack<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>js
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>webpack.base.js 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// entry、output 等共用配置，以及一些共用的 loader 和 plugin</span>
    
    <span class="token comment">// 有的配置虽然是共用，但因为环境不同，需要使用不同值，比如 sourcemap 是否开启：</span>
    devtool<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'none'</span> <span class="token operator">:</span> <span class="token string">'sourcemap'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>webpack.prod.js 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// merge 可以快速合并两个 webpack 配置</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.js'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
    mode<span class="token operator">:</span> <span class="token string">'production'</span>
    <span class="token comment">// 生产环境专用的配置    </span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>webpack.dev.js 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.js'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
    mode<span class="token operator">:</span> <span class="token string">'development'</span>
    <span class="token comment">// 开发环境专用的配置       </span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="方案二配置文件导出函数">方案二：配置文件导出函数</h4><p>基本策略是仍然使用单个配置文件，但是导出的不再是对象，而是函数。运行构建命令的时候传入一个 mode 参数，这个参数被函数接受，从而判断当前环境。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 这里配置的 mode 参数会传给配置文件中导出的函数</span>
    <span class="token string">"build"</span><span class="token operator">:</span> webpack <span class="token operator">--</span>config webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js <span class="token operator">--</span>mode production
    <span class="token string">"dev"</span><span class="token operator">:</span>  webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js <span class="token operator">--</span>mode development
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>webpack.config.js 文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">mode</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 公共配置</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// 生产环境配置</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 开发环境配置</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="项目开发">项目开发</h2><h3 id="处理-css">处理 CSS</h3><p>postcss 本身提供了一个强大的插件系统，可以对 css 进行后处理。在 webpack 中，需要通过 postcss-loader 去使用 postcss。</p><p><strong>1）自动补齐前缀</strong></p><p>为了向下兼容旧浏览器，某些比较新的 css 属性必须加上浏览器厂商的前缀，可以通过 postcss-loader 和 autoprefixer 实现前缀的自动补齐。</p><p>安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i postcss-loader autoprefixer -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
   module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
       rules<span class="token operator">:</span><span class="token punctuation">[</span>
           <span class="token punctuation">&#123;</span>
               test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
               loader<span class="token operator">:</span><span class="token punctuation">[</span>
                   <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
                   <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
                   <span class="token punctuation">&#123;</span>
                       loader<span class="token operator">:</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
                       options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                           <span class="token comment">// 使用 postcss 的插件</span>
                           plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
                               <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                                   browsers<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'last 2 version'</span><span class="token punctuation">,</span><span class="token string">'>1%'</span><span class="token punctuation">,</span><span class="token string">'iOS 7'</span><span class="token punctuation">]</span>
                               <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                           <span class="token punctuation">]</span>
                       <span class="token punctuation">&#125;</span>
                   <span class="token punctuation">&#125;</span>
               <span class="token punctuation">]</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">]</span>
   <span class="token punctuation">&#125;</span>   
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2）单位转换</strong></p><p>移动端的适配分为两步：</p><ul><li>根据屏幕分辨率动态设置根元素的字体大小。这里可以使用手淘的 lib-flexible 或者 viewport 单位来实现，这样，1rem 的大小就是动态的了</li><li>根据设计稿的 px 进行开发，最后通过插件将 px 统一转化为当前开发使用的分辨率下对应的 rem。</li></ul><p>这里进行单位转化的插件，就可以使用 px2rem-laoder、postcss-plugin-rem 等来完成。</p><h3 id="代码规范">代码规范</h3><h4 id="集成-eslint">集成 eslint</h4><p><strong>1）单独使用</strong></p><p>单独使用 eslint，首先需要安装 eslint 本体：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i eslint -D	<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>生成 eslint 配置文件 .eslintrc.json：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx eslint --init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>根据我们回答的问题，会预先配置好文件中的一些选项。如果想要使用其它公司团队的 eslint 规范，需要单独安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i eslint-config-airbnb -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>并修改配置文件中的 <code>extends</code> 选项：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"browser"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"es2021"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"node"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"extends"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 这里修改</span>
        <span class="token string">"airbnb"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"parserOptions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"ecmaVersion"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
        <span class="token property">"sourceType"</span><span class="token operator">:</span> <span class="token string">"module"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 自定义 lint 规则</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行下面命令对指定文件进行 lint 检测：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx eslint ./src/index.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>2）集成到 webpack 中使用</strong></p><p>在 webpack 中集成 eslint 有两种方式，一种是 eslint-loader，但它存在一些问题，不久将被弃用；webpack 5 开始更推崇使用 eslint-webpack-plugin。这里以后者为例。</p><p>首先安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i eslint-webpack-plugin -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接着到项目根目录下新建 .eslintrc.json 文件，内容和上面差不多。如果想要使用某个公司团队的 eslint 规范，同样需要单独安装 npm 包。</p><p>然后配置 webpack.config.js：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> ESLintPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eslint-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">ESLintPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>基本使用就是这样了，每次运行构建 eslint 都会检测代码。默认情况下 eslint 的报错信息采用的是 stylish 的展示风格，可能不太直观，可以使用特定的插件修改报错信息的展示风格。安装：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">npm i eslint<span class="token operator">-</span>formatter<span class="token operator">-</span>friendly <span class="token operator">-</span><span class="token constant">D</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> ESLintPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eslint-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">ESLintPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            formatter<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eslint-formatter-friendly'</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="集成-stylelint">集成 stylelint</h4><p>在 webpack 中集成 stylelint 有三种方式：</p><ul><li>使用 stylint-loader（官方已弃用，不推荐）</li><li>使用 postcss-loader + stylelint</li><li>使用 stylelint-webpack-plugin</li></ul><p>这里以第三种方式为例。首先安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i stylelint-webpack-plugin -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在项目根目录下新建 .stylelintrc.json 文件：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"unit-no-unknown"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> StylelintPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stylelint-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">StylelintPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每次运行构建 stylelint 都会检测代码。</p><p>PS：以上两种 lintPlugin 的安装都不需要额外安装 eslint 或者 stylelint，因为 npm 从 v7 开始会自动安装 peerDependencies。</p><h3 id="搭建-vue-开发环境">搭建 Vue 开发环境</h3><p>vue-cli 集成了 vue 和 webpack，但还是有必要掌握如何用 webpack 搭建一个基础的 Vue 开发环境。</p><p>创建目录并安装相关依赖：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">mkdir vue<span class="token operator">-</span>webpack <span class="token operator">&amp;&amp;</span> cd $_
npm init <span class="token operator">-</span>y

<span class="token comment">// 安装 webpack</span>
npm i webpack webpack<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">// 安装解析 html 的插件</span>
npm html<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">// 安装 vue（默认安装 vue2，vue@next 可以安装 vue3）</span>
npm i vue <span class="token operator">--</span>save

<span class="token comment">// 安装 vue-loader 和 vue-temlplate-compiler</span>
npm i vue<span class="token operator">-</span>loader vue<span class="token operator">-</span>temlplate<span class="token operator">-</span>compiler <span class="token operator">-</span><span class="token constant">D</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建 src 文件夹，<code>src/App.vue</code> 是 SFC 单文件组件：</p><pre class="line-numbers language-vue" data-language="vue"><code class="language-vue">&lt;template&gt;
  &lt;div id&#x3D;&quot;app&quot;&gt;
    Hello Vue
  &lt;&#x2F;div&gt;
&lt;&#x2F;template&gt;

&lt;script&gt;
	export default &#123;&#125;
&lt;&#x2F;script&gt;

&lt;style scoped&gt;
&lt;&#x2F;style&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>src/index.js 作为打包入口：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> app <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    el<span class="token operator">:</span> <span class="token string">'#project'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span><span class="token operator">=></span><span class="token function">h</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>src/index.html 作为构建产物使用的模板 html：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">// vue 挂载在这个 dom 上
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>project<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置 webpack：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> VueLoaderPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-laoder/lib/plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>
    output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    	path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./dist'</span><span class="token punctuation">)</span>
        filename<span class="token operator">:</span> <span class="token string">'[name].js'</span>
	<span class="token punctuation">&#125;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.vue$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token string">'vue-loader'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
	plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        	template<span class="token operator">:</span> <span class="token string">'./src/index.html'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意关于 vue 的几个依赖的作用：</p><ul><li>vue-loader：用于提取 <code>.vue</code> 中的各个语言块</li><li>VueLoaderPlugin：将 webpack 声明的规则应用于对应的语言块，比如 css-loader、style-loader 会同时作用在 <code>.vue</code> 文件中的 <code>&lt;style&gt;&lt;/style&gt;</code> 语言块</li><li>vue-template-compiler：将 template 预编译成函数，避免运行时进行模板编译，从而加快应用运行速度</li></ul><h2 id="项目打包">项目打包</h2><h3 id="多页面应用打包">多页面应用打包</h3><p>对于多页面应用来说，每个页面都对应“一个 entry + 一个 HtmlWebpackPlugin 实例”。如果每次添加或者删除页面都需要重新配置那就太麻烦了，因此理想的方案是根据页面情况实现自动配置。</p><p>假设项目结构如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token operator">+</span><span class="token operator">--</span> src
<span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span> page1
<span class="token operator">|</span>		<span class="token operator">+</span><span class="token operator">--</span> index<span class="token punctuation">.</span>js
<span class="token operator">|</span>		<span class="token operator">+</span><span class="token operator">--</span> index<span class="token punctuation">.</span>css
<span class="token operator">|</span>		<span class="token operator">+</span><span class="token operator">--</span> index<span class="token punctuation">.</span>html
<span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span> page2
<span class="token operator">|</span>		<span class="token operator">+</span><span class="token operator">--</span> index<span class="token punctuation">.</span>js
<span class="token operator">|</span>		<span class="token operator">+</span><span class="token operator">--</span> index<span class="token punctuation">.</span>css
<span class="token operator">|</span>		<span class="token operator">+</span><span class="token operator">--</span> index<span class="token punctuation">.</span>html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>page1 和 page2 目录下都有一个 index.js 表示页面入口，index.html 表示页面的模板 html。</p><p>首先安装 glob 方便读取文件路径：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i glob -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>通过一个 setMPA 函数处理多页面应用配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">setMPA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> HtmlWebpackPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 返回所有匹配的路径</span>
    <span class="token keyword">const</span> entryPaths <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/*/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    entryPaths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 从路径中提取出页面名</span>
        <span class="token keyword">const</span> entryName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/src\/(.*?)\/index\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
        entry<span class="token punctuation">[</span>entryName<span class="token punctuation">]</span> <span class="token operator">=</span> path
        HtmlWebpackPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 构建的 html 采用的模板</span>
            template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>entryName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token comment">// 构建的 html 的名字</span>
            filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>entryName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token comment">// 为构建的 html 注入哪些 chunk（MPA 一定要设置这个，否则会注入所有 chunk）</span>
            chunks<span class="token operator">:</span> <span class="token punctuation">[</span>entryName<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用 setMPA 生成配置对象，注入到 webpack 的配置中：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>entry<span class="token punctuation">,</span>HtmlWebpackPlugins<span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">setMPA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token punctuation">,</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token operator">...</span>HtmlWebpackPlugins
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="基础组件库打包">基础组件库打包</h3><p>以打包 + 发布一个 promise 为例。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> chor-promise
<span class="token builtin class-name">cd</span> chor-promise
<span class="token function">npm</span> init -y
<span class="token function">npm</span> i webpack webpack-cli -D<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>新建 ./src/index.js ，编写核心代码。接着新建 webpack.config.js 进行打包配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    entry<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 打包两份文件，分别是压缩版和未压缩版</span>
        <span class="token string">'chor-promise.min'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'chor-promise'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>
        <span class="token comment">// 使用该库时 import 的名字    </span>
        library<span class="token operator">:</span> <span class="token string">'myPromise'</span><span class="token punctuation">,</span>
        <span class="token comment">// 不设置的话需要通过 xxx.default 才能使用该库    </span>
        librarayExport<span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
        <span class="token comment">// 可以以 AMD、CJS 或者 ESM 的方式使用该库    </span>
    	librarayTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
        <span class="token comment">// 定义全局对象，必须设置，否则会报 self 或者 window 未定义的错误</span>
        globalObject<span class="token operator">:</span> <span class="token string">'this'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建 ./index.js 作为该库的入口文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 根据用户使用该库的时候是开发环境还是生产环境，决定导出压缩版还是未压缩版</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/chor-promise.min'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/chor-promise'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打包：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>发布：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 登录 <span class="token function">npm</span> 账号
<span class="token function">npm</span> login

// 将该库作为 <span class="token function">npm</span> 包发布
<span class="token function">npm</span> publish<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用：</p><p>首先正常安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i chor-promise -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在需要的文件中导入使用：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> myPromise <span class="token keyword">from</span> <span class="token string">'chor-promise'</span>

myPromsie<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="webpack-性能优化">webpack 性能优化</h2><h3 id="如何进行性能分析">如何进行性能分析</h3><p>webpack 本身可以配置 stats 展示打包构建的信息，但这些信息颗粒度比较大，不利于进行性能分析。所以这里还是要借助插件来分析。</p><h4 id="分析构建速度">分析构建速度</h4><p>性能分析其一，用 speed-measure-webpack-plugin 分析构建速度，它可以分析每个 loader 和 plugin 的耗时。安装后配置如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> speedMeasureWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'speed-measure-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> smp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">speedMeasureWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 用 smp.wrap 去包裹 webpack 的配置对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//.....</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>耗时长的 loader 或者 plugin 会显示为红色，这也是我们需要关注并优化的重心。</p><h4 id="分析打包体积">分析打包体积</h4><p>性能分析其二，用 webpack-bundle-analyzer 分析打包体积，在浏览器的 8888 端口下可以看到每个文件的体积信息以及各个 chunk 的包含关系，方便我们进行分析。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> BundleAnalyzerPlugin <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PS：安装这个 npm 包可能会报很恶心的 node gyp 错误，可以尝试切换回 npm 原来的镜像源（不要使用淘宝镜像源）</p><h3 id="文件结构优化">文件结构优化</h3><p>文件结构优化指的是要<strong>合理地拆分代码文件</strong>。为什么要拆分代码文件呢？一般是从两个角度考量：</p><ul><li>更好地利用缓存：假如 css 没有从 js 文件中分离出来，那么每次 js 或者 css 改变，用户都得重新下载整个文件；而分离之后，两者独立，一方改变后，另一方的缓存仍可利用，无需重新下载</li><li>更好地复用代码：如果开发的是多页面应用，可以把公共样式单独提取成一个文件，这样公共样式文件只需要下载一次，而不是每进入一个页面就要重复下载</li></ul><h4 id="合理使用动态加载">合理使用动态加载</h4><p>通过 <code>import()</code> 或者 <code>require.ensure()</code> 对某些体积较大的模块实现按需加载、动态加载的时候，这些模块会打包到单独的文件中。如果用户用不到这个模块，那么他们就无需加载它，不再像之前那样一股脑地加载整个代码文件。</p><h4 id="多页面应用使用动态路由">多页面应用使用动态路由</h4><p>对于多页面应用，采用之前提到的多页面应用打包方案，使每个页面都有自己对应的文件，这样用户在进入某个页面的时候，只需要加载和这个页面相关的资源，而不是全部一次性加载。</p><h4 id="splitchunks-代码分割">splitChunks 代码分割</h4><p>形成 chunk 的方法有三种：</p><ul><li>设置多个 entry 入口点，每个 entry 会被打包到一个 chunk 中</li><li>动态导入某些代码，这些代码会被打包到一个 chunk 中</li><li>通过 splitChunks 分割代码，分割的代码会被打包到一个 chunk 中</li></ul><p>通过配置 <code>optimization.splitChunks.cacheGroups</code> ，可以将公用的第三方库代码抽离成一个单独的 chunk，下面通过一个例子来理解这个过程。</p><p>假设我们的应用有两个页面，对应两个 entry 入口文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// page1.js</span>
<span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "page1-lodash"*/</span> <span class="token string">'lodash'</span><span class="token punctuation">)</span>

<span class="token comment">// page2.js</span>
<span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "page2-react" */</span> <span class="token string">'react'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "page2-lodash"*/</span> <span class="token string">'lodash'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>webpack 配置如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    optimization<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        splitChunks<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 这里的默认配置项省略，它们最终都会作用到 cacheGroups 上</span>
            cacheGroups<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                vendors<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                    <span class="token comment">// 这里的 chunks 字段指的是分离 chunk 的标准</span>
                    chunks<span class="token operator">:</span> <span class="token string">'async'</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>chunks: &quot;async&quot;</p></blockquote><p>chunks 的默认值就是 async，表示会将异步导入（动态导入）的模块抽离成单独的 chunk。</p><p><strong>对于 page1.js：</strong>本身 entry 文件就会对应一个 chunk，而 jq 和 react 都是同步导入的，因此不会从这个 chunk 中分离，它们三个最终会打包到一起，并输出到 page1.bundle.js 文件。而 lodash 是动态导入的，会分离到一个单独的 chunk 中，并输出到 vendors~page1-lodash.js 文件</p><p><strong>对于 page2.js：</strong>本身 entry 文件就会对应一个 chunk，而 jq 是同步导入的，因此不会从这个 chunk 中分离，它们两个最终会打包到一起，并输出到 page2.bundle.js 文件。而 lodash 是动态导入的，它会和 page1.js 中同样动态导入的 lodash 一起打包到同一个 chunk 中，最终输出到 vendors~page1-lodash.js 文件。react 也是动态导入的，它也会打包到一个单独的 chunk 中，最终输出到 vendors~page2-react.js 文件</p><p>综上，最终会有 4 个 chunk，输出到 4 个 bundle 文件中。从控制台打印信息可以看出确实是这样的：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/2.jpg"></div><p>借助 BundleAnalyzePlugun 可以更加直观地分析 bundle 的成分，如下图：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/3.jpg"></div><blockquote><p>chunks: &quot;initial&quot;</p></blockquote><p>initial 表示，不管模块是同步导入还是异步导入，都会被抽离成单独的 chunk。如果不同的 chunk 都通过同步导入的方式共用了同一个模块，则这两个模块可以被抽离到同一个 chunk 中。</p><ul><li>首先还是同样的，page1.js 和 page2.js 本身的 entry 文件会分别对应两个 chunk，并输出到 page1.bundle.js 和 page2.bundle.js 中。</li><li>由于两个 chunk 都同步导入了 jq，因此 jq 最终被抽离到一个 chunk 中，并输出到 vendors~page1-page2.js 文件。</li><li>对于都异步导入的 lodash 也是一样，会输出到 page1-lodash.js 文件。</li><li>而对于 react 的处理就不同了，虽然两个文件都导入了 react，但一个是同步导入，一个是异步导入，这种情况下，react 会被分别抽离到两个 chunk 中，同步导入的 react 输出到 vendors~page1.js，异步导入的 react 输出到 page2-react.js。</li></ul><p>综上，最终会有 6 个 chunk，输出到 6 个 bundle 文件中。</p><p>控制台打印信息如下：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/4.jpg"></div><p>BundleAnalyzePlugun 的分析情况如下：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/5.jpg"></div><p>PS：使用 <code>chunks:&quot;initial&quot;</code> 的时候需要注意，会有一个 minSize 字段表示被抽离成单独 chunk 的模块至少需要多大，如果模块体积本身小于这个值，则它也不会被单独抽离成 chunk，而是和 entry 对应的 chunk 打包在一起。</p><blockquote><p>chunks: &quot;all&quot;</p></blockquote><p>all 的特点在于，只要两个 chunk 共用了同一个模块，则不管模块在各自的 chunk 中是同步导入还是异步导入，最终都可以被抽离到同一个单独的 chunk 中。</p><ul><li>page1.js 和 page2.js 本身的 entry 文件会分别对应两个 chunk。</li><li>由于这两个 chunk 共用了 jq，所以 jq 被抽离到一个单独的 chunk 中，最终输出到 vendors~page1-page2.js</li><li>由于这两个 chunk 共用了 lodash，所以一样的，被抽离到一个 chunk 中，最终输出到 vendors~page1-lodash.js</li><li>对于 react，虽然在各自 chunk 中导入方式不同，但确实是属于共用的模块，所以也会被抽离到一个 chunk 中，最终输出到 vendors~page1-page2-react.js</li></ul><p>控制台打印信息如下：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/6.jpg"></div><p>BundleAnalyzePlugun 的分析情况如下：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%87%E5%AD%97%E6%A2%B3%E7%90%86%20webpack%20%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/7.jpg"></div><p>从这三种设置的结果可以看出，<code>chunks:&quot;all&quot;</code> 是可以最大程度复用代码的，因为在它的规则下，只要是模块被共用了，就可以被抽离到同一个 chunk 中。</p><h3 id="构建速度优化">构建速度优化</h3><h4 id="减小文件搜索范围">减小文件搜索范围</h4><p>webpack 打包构建的过程中会进行很多搜索过程，如果可以通过修改配置减小文件搜索的范围，那么就可以提高构建速度。</p><blockquote><p>从配置 noParse 的角度来说：</p></blockquote><p>默认情况下，我们导入 jq 或者 lodash 这样的库时，webpack 会去递归地解析这些库是否有其他第三方依赖。这个过程其实是不必要的，所以可以通过 noParse 配置不需要递归解析的模块：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    noParse<span class="token operator">:</span> <span class="token string">'/lodash|jquery/'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>从配置 resolve 的角度来说：</p></blockquote><p><strong><code>resolve.alias</code></strong></p><p>可以配置路径的别名，减少类似 import xxx from '../../a/b' 这样繁琐的导入语句。不仅开发上更加方便，而且 webpack 解析到别名的时候，可以直接去对应的目录找到模块。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    resolve<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        alias<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 用 @ 代替路径 '/project/src'</span>
            <span class="token string">'@'</span><span class="token operator">:</span> <span class="token string">'/project/src'</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 模块导入</span>
<span class="token keyword">import</span> xxx <span class="token keyword">from</span> <span class="token string">'@/assets/test.png'</span>

<span class="token comment">// HTML 中使用 </span>
<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">"~@/assets/test.png"</span><span class="token operator">></span>

<span class="token comment">// CSS 中使用</span>
<span class="token punctuation">.</span>box <span class="token punctuation">&#123;</span>
	background<span class="token operator">:</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'~@/assets/test.png'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意，在 HTML 或者 CSS 中使用别名路径的时候，必须加 <code>~</code> 前缀。另外，<strong>必须安装 html-loader 和 css-loader</strong>，webpack 才能正确解析别名路径对于资源的引用。</p><p><strong><code>resolve.extensions</code></strong></p><p>提供一个后缀名数组，如果像 <code>import</code> 这样的导入语句省略了文件后缀名，则会为文件依次加上数组中的后缀名，看文件是否存在。这意味着我们经过配置后，在导入语句中可以省略文件的后缀名。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    resolve<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 默认可以省略 .js 和 .json 后缀名</span>
        extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span><span class="token string">'.json'</span><span class="token punctuation">]</span>
        <span class="token comment">// 在默认省略的后缀名基础上自定义</span>
        extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'vue'</span><span class="token punctuation">,</span><span class="token string">'...'</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一般来说，应该将出现频率较高的后缀名写在前面，加快 webpack 解析时的匹配速度。另外不应该配置并省略过多的后缀名，否则会增加 webpack 解析时的查找时间。</p><p><strong><code>resolve.modules</code></strong></p><p>指定 webpack 去哪些路径下查找模块，默认会从项目根目录开始找，找不到就往外层找。一般我们自己写的模块或者第三方模块都在项目根目录下了，所以可以指定一下目录，减少不必要的向外查找。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>resolve.mainFields</code></strong></p><p>指定的是去查找第三方模块的 <code>package.json</code> 文件的哪些字段，从而找到模块的入口文件。一般来说入口文件都配置在 main 字段中，所以可以直接将其配置为 <code>['main']</code>。</p><blockquote><p>从配置 loader 的角度来说</p></blockquote><p>可以排除掉一些不需要解析的文件，或者精准指定需要解析的文件，从而减小解析时间，加快构建速度。</p><p>以 babel-loader 为例，默认情况下它会解析根目录中的所有 js 文件，但实际上，node_modules 中的很多第三方包本身就已经经过处理了，无需再进行解析，那么这部分就可以排除掉；同时，我们需要解析的通常是自己编写的代码，所以可以明确指定解析 src 目录下的文件：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                include<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                exclude<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./node_modules'</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="多进程并行构建">多进程并行构建</h4><p>webpack@4 之前使用 HappyPack，webpack@4 之后使用 thread-loader。安装后配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span><span class="token punctuation">[</span>
                    <span class="token punctuation">&#123;</span>
                        loader<span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
                        options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                            workers<span class="token operator">:</span> <span class="token number">3</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token string">'babel-loader'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>排在 thread-loader 之后的那些 loader 会被放在一个进程池中单独运行。这里需要注意，进程池中的 loader 不能产生新文件，因此类似 MiniCssExtractPlugin.loader 这样产生 css 文件的 loader 是不能使用 thread-loader 的。</p><p>PS：不管是 HappyPack 还是 thread-loader 都只适用于大型项目，小型项目中的优化很不明显，甚至可能反而降低打包构建的速度。</p><h4 id="多进程并行压缩">多进程并行压缩</h4><p>CSS 和 JS 的压缩可以开启多进程并行压缩（默认开启）：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    optimization<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token comment">// JS 并行压缩</span>
            <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                parallel<span class="token operator">:</span> <span class="token number">4</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token comment">// CSS 并行压缩</span>
            <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            	parallel<span class="token operator">:</span> <span class="token number">4</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="利用缓存提升二次构建速度">利用缓存提升二次构建速度</h4><p>前面讲到的都是提升首次构建速度，我们可以将首次构建的结果缓存下来，然后利用缓存提升二次构建的速度。</p><p>开启 babel-loader 的缓存功能：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                	<span class="token punctuation">&#123;</span>
                		loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                		options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                			cacheDirectory<span class="token operator">:</span> <span class="token boolean">true</span>
            			<span class="token punctuation">&#125;</span>
            		<span class="token punctuation">&#125;</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>开启 terser-webpack-plugin 的缓存功能：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            cache<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者使用 cache-loader 缓存构建结果：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'cache-loader'</span><span class="token punctuation">,</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者使用 hard-source-webpack-plugin 缓存构建结果：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   
        <span class="token comment">// 和 MiniCssExtractPlugin 的 loader 冲突，必须对其进行排除</span>
        <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin<span class="token punctuation">.</span>ExcludeModulePlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">mini-css-extract-plugin[\\/]dist[\\/]loader</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="打包体积优化">打包体积优化</h3><p>优化打包体积即减小打包体积，基本策略是对文件体积进行压缩，或者设法减少文件的数量。</p><h4 id="webpack-自带tree-shaking">webpack 自带：Tree-Shaking</h4><p>tree-shaking 就是所谓的摇树优化，可以实现 DCE，即去除没有用到的代码，包括：</p><ul><li>永远不会执行的、不可达的代码</li><li>执行结果没有被用到的代码</li><li>只会影响死变量（指变量赋值了，但之后再也没有读取）的代码</li></ul><p>在讲 tree-shaking 之前，首先要理解静态分析的概念。静态分析指的是不需要实际执行代码，仅从字面量就可以对代码进行分析，诸如 <code>import()</code> 和 CommonJS 的 <code>require()</code> 都是动态的，而 ESModule 则不一样，它支持静态分析 —— 在使用 ESModule 的时候，模块是否导入、是否导出、模块之间的依赖关系，这些都是可以提前确定好的，而这种静态分析的特性正是实现 tree-shaking 的关键。</p><p>tree-shaking 如何发挥作用呢？以下面的代码为例：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// export.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>a<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">''</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token keyword">export</span><span class="token punctuation">.</span>js'
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然只是导入并使用了 a，但实际上最终 a 和 b 都会被打包到 bundle 中，这会无形增加代码体积。但是如果使用了 tree-shaking，则最终只有 a 会被打包。</p><p>同样的，如果是下面这种情况：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// export.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>a<span class="token punctuation">,</span>b<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">''</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token keyword">export</span><span class="token punctuation">.</span>js'
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用了 tree-shaking 之后，由于没有用到 b，所以最终 b 也不会被打包。</p><p>对于有副作用的代码（会向外界产生可观察的变化），tree-shaking 无法将其修剪掉。如果确定自己的项目没有副作用，可以配置 webpack.config.js 的 <code>optimization.sideEffects: true</code>（生产环境自动开启），同时配置 package.json 的 <code>sideEffects: false</code> ，告知 webpack 无需考虑副作用的问题，可以放心进行 tree-shaking；另外也可以指定一个路径数组，明确告知 webpack 哪些文件有副作用，从而让 webpack 为其它没有副作用的文件进行 tree-shaking 处理。</p><p>前面也说过，tree-shaking 依赖于 ESModule 的静态分析，那么对于 lodash 这样不使用 ESModule 模块规范的第三方库，怎么进行 tree-shaking 呢？这时候可以考虑使用这种库的 es 版本，比如 lodash 对应的就有一个 lodash-es 版本。</p><p>webpack 在生产环境下默认开启 tree-shaking，当然也可以手动开启：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    optimization<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="webpack-自带scope-hoisting">webpack 自带：Scope-Hoisting</h4><p>scope-hoisting 可以将多个函数声明压缩为一个，这样做的好处一个是减少声明语句，从而减小代码体积；一个是减少函数作用域数量，从而降低内存开销。</p><p>webpack 在生产环境下默认开启 scope-hoisting，当然也可以手动开启：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="资源优化压缩-html">资源优化：压缩 HTML</h4><p>由 html-webpack-plugin 生成的 html 文件，可以通过设置 <code>minify: true</code> 开启压缩功能（生产环境下默认开启）。</p><h4 id="资源优化压缩-js">资源优化：压缩 JS</h4><p>webpack 默认内置了 <code>uglifyjs-webpack-plugin</code>或者 <code>terser-webpack-plugin</code>，并且在生产环境下自动开启，因此 JS 代码默认就是经过压缩的。</p><p>当然也可以自定义配置（具体配置项需要参考 terser）：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    optimization<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        minimizer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
	            <span class="token comment">// 只压缩 `.min.js` 后缀的文件</span>
            	test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.min\.js$</span><span class="token regex-delimiter">/</span></span>
            	<span class="token comment">// 加快二次构建的速度</span>
            	cache<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            	<span class="token comment">// 多线程压缩</span>
            	parallel<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	            terserOptions<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        			compress<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            			unused<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            			drop_debugger<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            			drop_console<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            			dead_code<span class="token operator">:</span> <span class="token boolean">true</span>	
			        <span class="token punctuation">&#125;</span>    
		        <span class="token punctuation">&#125;</span>
	        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>上面指的是对 JS 代码进行压缩，还有一种减少 JS 代码的策略是动态引入 polyfill。</p><p>babel 所做的事情只是转换语法，比如 const 转化为 var，箭头函数转化为普通函数等，对于诸如 map、Promise 这样比较新的 api 则无法进行处理，这时候就需要借助 polyfill 实现向下兼容。但是单纯使用 babel-polyfill 的问题在于，<strong>任何时候都是全量引入的，而有些用户的浏览器比较新，其实用不着使用 polyfill</strong>。</p><p>所以如果能实现动态引入 polyfill，也可以减少代码体积。这里借助的是 polyfill-service，我们引用它提供的 polyfill CDN，对于不同的浏览器，它会返回不同版本的 polyfill。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>srcipt</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://polyfill.io/v3/polyfill.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>srcipt</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="资源优化压缩-css">资源优化：压缩 CSS</h4><p>有三种方案，不管是哪一种，底层使用的压缩引擎都是 cssnano，而 css-loader 已经内置了 cssnano，因此无需额外安装。</p><p><strong>方案一：postcss+ cssnano</strong></p><p>需要安装 postcss-loader，接着进行配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
                    <span class="token punctuation">&#123;</span>
                        loader<span class="token operator">:</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
                        options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token function-variable function">plugins</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
                                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cssnano'</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>方案二：optimize-css-assets-webpack-plugin + cssnano</strong></p><p>适用于 webpack@5 之前的版本。需要安装 optimize-css-assets-webpack-plugin，接着进行配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> optimizeCssAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">optimizeCssAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            assetNameRegExp<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
            cssProcessor<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cssnano'</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>方案三： css-minimizer-webpack-plugin</strong></p><p>适用于 webpack@5 之后的版本。需要安装 css-minimizer-webpack-plugin，接着进行配置：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> CssMinimizerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"css-minimizer-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    optimization<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        minimizer<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>上面的 css 压缩都基于 cssnano，它很好用，但无法移除那些没有使用过的样式。这里可以使用 purgecss-webpack-plugin 实现 css 中的 tree-shaking。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 必须和这个插件一起使用</span>
    <span class="token keyword">new</span> <span class="token class-name">MiniCSSExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">PurgeCSSPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>       
      paths<span class="token operator">:</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'./src/*/*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>nodir<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意这里的 path <strong>并不是指要移除无用样式的 css 所在的路径</strong>，而是指引用这个 css 的文件所在的路径，可以直接配置为 src 下的所有文件。purgecss 会对这些文件进行分析，最终产出一个移除了无用样式的 css 文件。</p><h4 id="资源优化处理图片">资源优化：处理图片</h4><p>从减小文件数量的角度来说：</p><p>1）可以使用前面提到的 url-loader，对体积小于 limit 的图片进行 base64 编码，转化为 dataUrl 内联进我们的应用</p><p>2）对于 svg 图片，可以使用类似的 svg-url-loader 对其进行 utf-8 编码，转化为 dataUrl 内联进应用。它相比 base64 编码的优势在于，字符串更短，浏览器解析更快</p><p>3）对于图标类图片，可以使用 postcss-loader + postcss-sprites（需要额外安装 phantomjs），它可以将多张图片合并成一张雪碧图，并且自动调整图片的背景位置。</p><p>大致配置如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    module<span class="token operator">:</span> <span class="token punctuation">[</span>
        rules<span class="token operator">:</span><span class="token punctuation">[</span>
    		<span class="token punctuation">&#123;</span>
        		test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        		use<span class="token operator">:</span> <span class="token punctuation">[</span>
        			<span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">,</span>
        			<span class="token punctuation">&#123;</span>
        				loader<span class="token operator">:</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
        				options<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        					plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        						<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss-sprites'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    								spritePath<span class="token operator">:</span> <span class="token string">'./src/sprites'</span>
								<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
						    <span class="token punctuation">]</span>
        				<span class="token punctuation">&#125;</span>
        			<span class="token punctuation">&#125;</span>
			    <span class="token punctuation">]</span>
        	<span class="token punctuation">&#125;</span>    
	    <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>postcss-sprites 作用的原理可以简单理解为，将 css 文件中引用到的图片资源合并成一张雪碧图，并自动处理背景图的展示位置。经由 file-loader 处理后，最后产出的 bundle 中只包含雪碧图这一张图片。</p><p>这里需要注意，<code>spritePath</code> 配置的是雪碧图的存放路径。一般雪碧图放在 src 中而不是 dist 中，因为 dist 中本来就会在 file-loader 的作用下产出图片，没有必要重复导出雪碧图到 dist 中 —— 即使导出了，也属于没有被使用的静态资源，会被 clean-webpack-plugin 清理掉。</p><p>此外，postcss-sprites 这个插件不支持识别 <code>resolve.alias</code> 配置的别名。</p><hr><p>从减小文件大小的角度来说，对大体积的图片可以使用 image-webpack-loader 进行无损压缩。这个 loader 必须在 file-loader 之前处理图片，所以最好配置 <code>enforce: 'pre'</code>。</p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2021/11/17/F-TypeScript%20%E5%AE%98%E6%96%B9%E6%89%8B%E5%86%8C%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92%E3%80%90%E4%B8%80%E3%80%91%EF%BC%9A%E5%9F%BA%E7%A1%80/" rel="prev" title="TypeScript 官方手册翻译计划【一】：基础"><i class="fa fa-angle-double-left"></i>&nbspTypeScript 官方手册翻译计划【一】：基础</a></div><div class="post-nav-next"><a href="/2021/08/01/F-JS%20%E5%8E%9F%E7%94%9F%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6%EF%BC%88%E5%8D%81%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0%20PromiseA+%20%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95%EF%BC%9F/" rel="next" title="JS 原生方法原理探究（十）：如何手写实现 Promise/A+ 及相关方法？">JS 原生方法原理探究（十）：如何手写实现 Promise/A+ 及相关方法？&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#modulechunk-%E5%92%8C-bundle"><span class="toc-text">module、chunk 和 bundle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#entry-%E5%92%8C-output"><span class="toc-text">entry 和 output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mode"><span class="toc-text">mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loader"><span class="toc-text">loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plugin"><span class="toc-text">plugin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%93%E6%B7%B7%E6%B7%86%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-text">易混淆的配置项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#filename-%E5%92%8C-chunkfilename"><span class="toc-text">filename 和 chunkFilename</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#path-%E5%92%8C-publicpath"><span class="toc-text">path 和 publicPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hashcontenthash-%E5%92%8C-chunkhash"><span class="toc-text">hash、contenthash 和 chunkhash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E8%A7%A3%E6%9E%90"><span class="toc-text">资源解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-es6-%E8%AF%AD%E6%B3%95"><span class="toc-text">解析 ES6 语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-css-%E5%92%8C-lesssassstylus"><span class="toc-text">解析 CSS 和 LESS&#x2F;SASS&#x2F;Stylus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9B%BE%E7%89%87%E5%92%8C%E5%AD%97%E4%BD%93"><span class="toc-text">解析图片和字体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E5%86%85%E8%81%94"><span class="toc-text">资源内联</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E6%96%87%E4%BB%B6%E5%86%85%E8%81%94html-%E5%92%8C-js"><span class="toc-text">源文件内联：HTML 和 JS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E6%96%87%E4%BB%B6%E5%86%85%E8%81%94css"><span class="toc-text">源文件内联：CSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%BA%A7%E7%89%A9%E5%86%85%E8%81%94css-%E5%92%8C-js"><span class="toc-text">构建产物内联：CSS 和 JS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E5%92%8C%E5%AD%97%E4%BD%93%E5%86%85%E8%81%94"><span class="toc-text">图片和字体内联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E5%92%8C%E6%9E%84%E5%BB%BA%E4%BD%93%E9%AA%8C"><span class="toc-text">开发和构建体验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="toc-text">文件监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E9%87%8D%E8%BD%BD"><span class="toc-text">热重载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-text">热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-sourcemap"><span class="toc-text">开启 sourcemap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82"><span class="toc-text">代理跨域请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%BC%95%E7%94%A8%E6%9E%84%E5%BB%BA%E4%BA%A7%E7%89%A9"><span class="toc-text">自动引用构建产物</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9A%84%E6%98%BE%E7%A4%BA"><span class="toc-text">优化构建日志的显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E6%9E%84%E5%BB%BA%E9%94%99%E8%AF%AF"><span class="toc-text">捕获构建错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%A6%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">分离配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80-cross-env-node_env"><span class="toc-text">方案一： cross-env + NODE_ENV</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0"><span class="toc-text">方案二：配置文件导出函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91"><span class="toc-text">项目开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86-css"><span class="toc-text">处理 CSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83"><span class="toc-text">代码规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90-eslint"><span class="toc-text">集成 eslint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90-stylelint"><span class="toc-text">集成 stylelint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA-vue-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-text">搭建 Vue 开发环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85"><span class="toc-text">项目打包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E6%89%93%E5%8C%85"><span class="toc-text">多页面应用打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E5%BA%93%E6%89%93%E5%8C%85"><span class="toc-text">基础组件库打包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webpack-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-text">webpack 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-text">如何进行性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%9E%84%E5%BB%BA%E9%80%9F%E5%BA%A6"><span class="toc-text">分析构建速度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%89%93%E5%8C%85%E4%BD%93%E7%A7%AF"><span class="toc-text">分析打包体积</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96"><span class="toc-text">文件结构优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD"><span class="toc-text">合理使用动态加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-text">多页面应用使用动态路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#splitchunks-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-text">splitChunks 代码分割</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96"><span class="toc-text">构建速度优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%8F%E5%B0%8F%E6%96%87%E4%BB%B6%E6%90%9C%E7%B4%A2%E8%8C%83%E5%9B%B4"><span class="toc-text">减小文件搜索范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B9%B6%E8%A1%8C%E6%9E%84%E5%BB%BA"><span class="toc-text">多进程并行构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B9%B6%E8%A1%8C%E5%8E%8B%E7%BC%A9"><span class="toc-text">多进程并行压缩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%BC%93%E5%AD%98%E6%8F%90%E5%8D%87%E4%BA%8C%E6%AC%A1%E6%9E%84%E5%BB%BA%E9%80%9F%E5%BA%A6"><span class="toc-text">利用缓存提升二次构建速度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96"><span class="toc-text">打包体积优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack-%E8%87%AA%E5%B8%A6tree-shaking"><span class="toc-text">webpack 自带：Tree-Shaking</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack-%E8%87%AA%E5%B8%A6scope-hoisting"><span class="toc-text">webpack 自带：Scope-Hoisting</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E5%8E%8B%E7%BC%A9-html"><span class="toc-text">资源优化：压缩 HTML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E5%8E%8B%E7%BC%A9-js"><span class="toc-text">资源优化：压缩 JS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E5%8E%8B%E7%BC%A9-css"><span class="toc-text">资源优化：压缩 CSS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86%E5%9B%BE%E7%89%87"><span class="toc-text">资源优化：处理图片</span></a></li></ol></li></ol></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=t.substring(0,n),s=document.URL,l=new Date,i=document.getElementsByClassName("vnick vinput")[0].value,o=document.getElementsByClassName("vmail vinput")[0].value,v=document.getElementsByClassName("vlink vinput")[0].value,m=document.getElementsByClassName("veditor vinput")[0].value,r=e+"|昵称：|邮箱：|网站地址：|当前页面：|评论内容：|跳转链接：|评论时间\n|----|----|----|----|\n|   "+i+"   |   "+o+"  |  "+v+"|   "+a+"| "+m+"| "+s+"|"+l.toLocaleString()+"|",u=new XMLHttpRequest;u.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.send(title1+"&"+r)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->