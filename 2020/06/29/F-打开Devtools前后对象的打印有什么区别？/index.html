<!-- build time:Sun Jul 05 2020 15:15:29 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">打开DevTools前后，对象的打印有什么区别？</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2020-06-29&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.2k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp4 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/0.png" alt="chrome-devtools"></p><a id="more"></a><p>前几天，群里有个朋友问了一个很有意思的问题：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> Person <span class="token punctuation">(</span>myName<span class="token punctuation">,</span> myAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> myName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> myAge<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Person<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    say<span class="token punctuation">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">" prototype中的输出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"John"</span> <span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>就这段代码而言，第一次运行后打开 Chrome 的 DevTools，会发现打印出来的结果是：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/1.png" alt="1"></p><p>而如果在此基础上刷新浏览器，会发现打印的结果变成了这样：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/2.png" alt="2"></p><p>这确实是个很不起眼但是很有意思的问题 —— 为什么 Chrome 没有在第一次的时候就直接打印 <code>{say:f}</code>，而是像 <code>console.dir</code> 那样打印出一个不具备对象属性预览的 <code>Object</code>？</p><p>也许这样做是有什么好处，不过先让我们排除一些不必要的干扰因素。第一个是：是否和原型相关？虽然群友给的案例代码涉及到了原型，但其实和原型没有任何关系。我尝试将代码改为简单的 <code>console.log({a:1})</code>后，依然会发生同样的情况 —— 即第一次只打印 <code>Object</code>，刷新之后才打印 <code>{a:1}</code>。第二个是：是否和浏览器相关？目前为止运行代码的环境都是 Chrome，在其它浏览器下打印结果会是怎么样的呢？</p><p>在 FireFox 下，发现刷新前后都是直接打印对象属性预览：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/3.png" alt="3"></p><p>在 Edge 下，发现刷新前后存在类似 Chrome 的差异：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/4.png" alt="4"></p><p>那么，Chrome 这样做的目的是什么呢？带着这个疑问，我先是来到 StackOverflow 提问，不过并没有得到满意的回答。虽然我极力提醒回答者这道题的困惑之处在于刷新前后打印结果的差异，但他还是“跑题”了……不过，他的回答中有一个地方引起了我的注意，就是“ a very slow operation”。这确实是给出了一个思考的方向：Chrome 在一开始没有直接打印对象的预览，会不会是因为这是一个耗时操作呢？所以，也许这是一个性能相关的问题？</p><p>接着我尝试到知乎提问，最终很惊喜地得到了大佬的回复 —— 这确实是一个为了性能优化而采取的行为：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/5.png" style="zoom:80%"></p><p>点进回答里提供的链接看一下，有更加详细的解释：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/6.png" style="zoom:80%"></p><p>简单地说，这个行为的差异不是由于刷新浏览器导致的，而是由于打开 DevTools 导致的。我们在第一次运行代码之后，对象就打印出来了，但此时还没有打开 DevTools，所以这部分打印的内容是暂时放在内存的缓冲区（buffer）中的。而且对一个普通的用户来说，他<strong>很可能永远也不需要打开 DevTools</strong>，在这种情况下若仍然选择呈现预览对象，会对内存和 CPU 有一定的要求，考虑到这一点，在设计上会让这次的打印不呈现预览对象。</p><p>对我们来说，如果这一次打开 DevTools，我们看到的就只会是 <code>Object</code>。但是，如果在打开之后再次刷新，那么我们看到的就是所期望的 <code>{a:1}</code>。因此，这种行为差异是在“保留信息”和“减少内存占用”之间所做的权衡（trade-off）。</p><p>我们还可以进一步验证一下：随便打开一个页面，并且打开控制台，然后把代码文件直接拖到该页面运行：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%89%93%E5%BC%80DevTools%E5%89%8D%E5%90%8E%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%93%E5%8D%B0%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/7.gif" alt=""></p><p>这时候会发现，控制台里是直接打印出 <code>{a:1}</code> 这样的预览对象的，这是因为在打印之前我们就提前把 DevTools 打开了，这时候打印的对象并不会放在缓冲区中。</p><p>此外，回答里还提到一个叫做 <strong>ObjectPreview</strong> 的东西，它其实就是上面所讲的能够呈现对象属性预览的东西，实际上是 cdp( ChromeDevToolsProtocol ) 协议的一个 api。cdp 协议允许我们检测和调试 Chrome 浏览器，我们所熟知的 ChromeDevTools 就是遵循这个协议的。从这点来说，当我们打开 DevTools 时，其实就已经在使用 cdp 协议了。</p><p>FireFox 可能认为这个优化对性能提升并不是很明显，所以在设计上选择的是直接打印 ObjectPreview。当然不排除还有其它方面的考虑，具体的我就没有再深挖啦，毕竟咱也不是开发浏览器的，了解一下，知道有这么一个东西就好了。关键的是，这次的疑惑得到了一个比较官方而准确的解答，我认为这才是最大的收获。</p><p>参考：</p><p><a href="https://www.zhihu.com/question/403754007" target="_blank" rel="noopener">https://www.zhihu.com/question/403754007</a></p><p><a href="https://twitter.com/ziyunfei/status/1277126750569328645" target="_blank" rel="noopener">https://twitter.com/ziyunfei/status/1277126750569328645</a></p><p><a href="https://chromedevtools.github.io/devtools-protocol/tot/Runtime/#type-ObjectPreview" target="_blank" rel="noopener">https://chromedevtools.github.io/devtools-protocol/tot/Runtime/#type-ObjectPreview</a></p></div><div class="post-nav"><div class="post-nav-prev"></div><div class="post-nav-next"><a href="/2020/05/26/F-%E5%85%B3%E4%BA%8E%20Git%20%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/" rel="next" title="关于 Git 的那些事">关于 Git 的那些事&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2020</span> My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->