<!-- build time:Sun Nov 24 2019 12:53:48 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>PureBlue</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third party/pace-theme-flash.css"><link rel="icon" href="/images/me.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">PureBlue</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">AJAX 与跨域通信（三）：跨域解决方案</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2019-11-09&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp2.5k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp10 mins&nbsp&nbsp&nbsp</span><div class="post-tags"><i class="fa fa-tags"></i> <a href="/tags/AJAX/">AJAX</a> <a href="/tags/跨域/">跨域</a></div></div><div class="post-content"><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%89%EF%BC%89/AJAX%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%89%EF%BC%89-0.jpeg" alt=""></p><a id="more"></a><p>承接上文，继续补充跨域方案：<code>postMessage</code>、<code>location.hash</code>、<code>WebSocket</code>、Nginx 反向代理、Nodejs 中间件代理。</p><h3 id="6-postMessage"><a href="#6-postMessage" class="headerlink" title="6.postMessage"></a>6.postMessage</h3><p>HTML5 提供了 <code>postMessage</code> 和 <code>onmessage</code> 两个 api 用于在跨域站点页面之间进行通信。</p><p>假设A域要向B域发送消息，那么：</p><ul><li>一方面，我们在A域页面中通过 <code>iframe</code> 引入B域，之后用B域的 window 对象调用 <code>postMessage</code>方法（谁接受消息，谁就去调用）。这个方法接受两个参数，第一个参数是发送的消息， 它可以是任何类型的数据，但部分浏览器只支持字符串格式；第二个参数是可以接受消息的域，如果不想限定某个域（比如B）去接受消息，那么可以传 <code>*</code>。</li><li>另一方面，B域监听 <code>message</code> 事件，一旦接收到消息就调用某个函数接受数据。<code>message</code> 事件的事件对象有三个属性，<code>event.data</code> 表示接受到的数据，<code>event.origin</code> 为消息发送方的源，<code>event.source</code> 为消息发送方的窗口对象的引用。</li></ul><p>B域接收到了消息，要通知A域，其实就是上面的过程反过来。</p><p>B域要向A域发送消息，那么：</p><ul><li>一方面，B 域的 <code>window.parent</code> 可以访问父级（A域）窗口对象，我们在B域里通过该对象调用 <code>postMessage</code> 方法，发送通知给A域</li><li>另一方面，A域监听 <code>message</code> 事件，收到B域通知，进行相应处理</li></ul><p>核心代码如下：</p><pre class="line-numbers language-html"><code class="language-html">http://test.com/a.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myIframe<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://anothertest.com/b.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#myIframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iframe<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'我是数据'</span><span class="token punctuation">,</span><span class="token string">'http://anothertest.com/b.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    window<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我收到的B域通知是:'</span><span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 我收到的B域通知是:B域收到A域的消息了，通知你一声</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-html"><code class="language-html">http://anothertest.com/b.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    window<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我接受到的消息是:'</span><span class="token operator">+</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//我接受到的消息是:我是数据</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送消息的源是:'</span><span class="token operator">+</span>event<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送消息的窗口对象是:'</span><span class="token operator">+</span>event<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'B域收到A域的消息了，通知你一声'</span><span class="token punctuation">,</span><span class="token string">'http://test.com/a.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么这就是简单的跨域窗口间通信了，不过这只是客户端层面上的，如果A域的客户端要发送 AJAX 请求给B域服务端呢？只要稍微改进上面的方法就可以，也就是说，B域客户端充当一个中转站，A 域客户端先通过上面的方法把数据发送给B域客户端，B域客户端再把数据转发给B域服务端（这两个是同源的，直接发送 AJAX 请求）；然后，反过来也一样，B域返回的数据经由B域客户端交给A域客户端。</p><p>代码如下：</p><pre class="line-numbers language-html"><code class="language-html">http://anothertest.com/b.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    window<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://anothertest.com/test.php?msg='</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 发送请求</span>
    <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> response<span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 返回响应结果</span>
    <span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span><span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'服务端返回的数据是:'</span><span class="token operator">+</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">,</span><span class="token string">'http://test.com/a.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外还要关注安全问题。 postMessage 本质上是依赖于客户端脚本设置了相应的 <code>message</code> 监听事件，因此只要有消息通过<code>postMessage</code>发送过来，我们的脚本都会接收并进行处理 —— 而任何域都可以通过 <code>postMessage</code> 发送跨域信息，因此对于设置了事件监听器的页面来说，判断到达页面的信息是否安全是非常重要的。通常可以通过 <code>event.origin</code> 检测消息方是否在消息源白名单中。</p><h3 id="7-location-hash"><a href="#7-location-hash" class="headerlink" title="7. location.hash"></a>7. location.hash</h3><p>默认情况下，改变页面的 url 会导致页面跳转，但是 hash 是个例外，譬如将 <a href="http://test.com/a.html#hash" target="_blank" rel="noopener">http://test.com/a.html#hash</a> 改为 <a href="http://test.com/a.html#anotherhash" target="_blank" rel="noopener">http://test.com/a.html#anotherhash</a> ，并不会引起页面跳转，所以我们可以利用 hash 来传输数据。</p><p>假设A域有 a.html 和 b.html，B域有 c.html，且 a.html 和 c.html 之间要进行跨域通信。</p><ul><li>一方面，我们在 a.html 中通过 <code>iframe</code> 引入 c.html，引用的 src 带上 hash —— 实际上这时候已经<strong>通过 hash 的方式把数据传给 c.html 了</strong></li><li>另一方面，在 c.html 中，我们对这个数据进行一些处理，之后想办法返回给 a.html。怎么返回呢？假定 a、c 同域，那么可以通过将数据赋值给 <code>window.parent.location.hash</code> 的方式，让 a.html 的 hash 改变，同时 a.html 监听这个改变，保存传过来的数据。但问题是，a、c 是不同源的，我们无法在 c.html 中通过 <code>window.parent</code> 去访问 a.html。那么谁能和 a.html 直接通信呢？肯定是和 a.html 同源的 html，因此我们想到，在 c.html 中利用 <code>iframe</code> 引入与 a.html 同源的 b.html，引用的 src 带上 hash —— 实际上这时候已经<strong>通过 hash 的方式把数据传给 b.html 了</strong>，而 b.html 拿到数据后，由于它和 a.html 是同源的，所以可以直接将数据赋值给 <code>window.parent.parent.location.hash</code> ，之后，a.html 监听 hash 改变，保存数据。</li></ul><p>如下图所示：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/AJAX%20%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%89%EF%BC%89/AJAX%E4%B8%8E%E8%B7%A8%E5%9F%9F%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%89%EF%BC%89-1.jpg" alt=""></p><p>下面我们看一下代码是怎么写的。</p><p>像前面说的，我们创建 <code>iframe</code> 引用 c.html，通过 hash 传值，同时监听 a.html 的 hash 改变 —— 这里有两种方式，我们可以直接用 onhashchange 监听，也可以设置一个定时器，每隔两秒轮询一次 hash，一旦改变就打印数据。</p><pre class="line-numbers language-html"><code class="language-html">// a.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>No changes yet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
<span class="token keyword">var</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3001/c.html#getdata'</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// location.hash为'#getdata'</span>
iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">// 原生 onhashchange 监听，有些浏览器不支持 onhashchange</span>
window<span class="token punctuation">.</span>onhashchange <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> location<span class="token punctuation">.</span>hash <span class="token operator">?</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span>
    p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//定时器轮询 hash</span>
<span class="token comment" spellcheck="true">// function checkHash() {</span>
<span class="token comment" spellcheck="true">//     let data = location.hash ? location.hash.substring(1) : ''</span>
<span class="token comment" spellcheck="true">//     p.innerHTML = data;</span>
<span class="token comment" spellcheck="true">// }</span>
<span class="token comment" spellcheck="true">// setInterval(checkHash, 2000);   // 每隔2s监听hash值是否发生变化</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里我们根据不同的参数采取不同的处理，因为传过来的是 <code>#getdata</code>，所以调用 <code>callBack</code> 函数，函数首先尝试直接用 <code>parent.location.hash</code> 改变 a.html 的 hash，发现是不同源的，更改失败，改为将数据传给 b.html。</p><pre class="line-numbers language-html"><code class="language-html">// c.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
<span class="token keyword">switch</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'#getdata'</span><span class="token punctuation">:</span>
        <span class="token function">callBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'#getAnotherData'</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">//do something……</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">callBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">'name=Sam'</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> message<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 因为不同域，这里通过 parent.location.hash 直接更改会报错</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 采用 b.html 作为中转站</span>
        <span class="token keyword">var</span> ifrproxy <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ifrproxy<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
        ifrproxy<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3000/b.html#'</span> <span class="token operator">+</span> message<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注意该文件在3000端口下</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>ifrproxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于 b.html 和 a.html 同源，所以可以直接更改 a.html 的 hash。更改后触发 a.html 中的事件，打印数据。</p><pre class="line-numbers language-html"><code class="language-html">// b.html

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> self<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>location.hash 跨域的大致过程就是这样，当然，它的缺点也很明显：</p><ul><li>数据直接暴露在了 url 中</li><li>数据容量和类型有限</li></ul><h3 id="8-WebSocket"><a href="#8-WebSocket" class="headerlink" title="8. WebSocket"></a><strong>8. WebSocket</strong></h3><p>传统的 http 协议有一个缺陷：通信只能由客户端发起，服务端无法主动向客户端推送信息。比如，服务端这边某个状态发生变化，它是无法主动通知客户端的，而只能由客户端采用轮询的方式，每隔一段时间发送一次请求进行探测。</p><p>这时候出现了一种新的叫做 WebSocket 的协议，它使用<code>ws://</code>（非加密）和 <code>wss://</code>（加密）作为协议前缀，特点在于支持双向通信 —— 客户端可以主动向服务端发送信息，服务端也可以主动向客户端推送信息 。那么这和跨域有什么关系呢？事实上，WebSocket 本身就不受同源策略的影响，这意味着，一旦客户端与服务端建立的是 WebSocket 连接，天然就可以实现跨域资源共享。</p><h4 id="8-1-建立-WebSocket-连接"><a href="#8-1-建立-WebSocket-连接" class="headerlink" title="8.1 建立 WebSocket 连接"></a>8.1 建立 WebSocket 连接</h4><p>客户端要求升级至 WebSocket 协议：</p><pre class="line-numbers language-js"><code class="language-js">GET <span class="token operator">/</span>chat HTTP<span class="token operator">/</span><span class="token number">1.1</span>
Host<span class="token punctuation">:</span> server<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
Upgrade<span class="token punctuation">:</span> websocket
Connection<span class="token punctuation">:</span> Upgrade
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Key<span class="token punctuation">:</span> x3JJHMbDL1EzLkh9GBhXDw<span class="token operator">==</span>
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Protocol<span class="token punctuation">:</span> chat<span class="token punctuation">,</span> superchat
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Version<span class="token punctuation">:</span> <span class="token number">13</span>
Origin<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>服务端同意升级：</p><pre class="line-numbers language-js"><code class="language-js">HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">101</span> Switching Protocols
Upgrade<span class="token punctuation">:</span> websocket
Connection<span class="token punctuation">:</span> Upgrade
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Accept<span class="token punctuation">:</span> HSmrc0sMlYUkAGmm5OPpG2HaGWk<span class="token operator">=</span>
Sec<span class="token operator">-</span>WebSocket<span class="token operator">-</span>Protocol<span class="token punctuation">:</span> chat
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="8-2-发起请求"><a href="#8-2-发起请求" class="headerlink" title="8.2 发起请求"></a>8.2 发起请求</h4><p>同源策略限制了不同源之间无法发送 AJAX 请求，但是 WebSocket 发送的并不是 AJAX 请求，而是 WebSocket 请求。在了解怎么发起 ws 请求之前，先看一下一些相关属性。</p><ul><li><code>WebSocket</code>对象的<code>readyState</code>属性用来表示对象实例当前所处的连接状态，有四个值：<ul><li><strong>0</strong>：表示正在连接中（CONNECTING）；</li><li><strong>1</strong>：表示连接成功，可以通信（OPEN）；</li><li><strong>2</strong>：表示连接正在关闭（CLOSING）；</li><li><strong>3</strong>：表示连接已经关闭或打开连接失败（CLOSED）；</li></ul></li><li>另外还有四个事件属性：<ul><li><code>onopen</code>：用于指定连接成功后的回调函数；</li><li><code>onclose</code>：用于指定连接关闭后的回调函数；</li><li><code>onmessage</code>：用于指定收到服务器数据后的回调函数；</li><li><code>onerror</code>：用于指定报错时的回调函数；</li></ul></li><li>另外还提供了 <code>bufferedAmount</code>属性，表示还剩下多少字节的二进制数据没有发送出去</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ws://localhost:3000是响应请求的地址</span>
ws<span class="token punctuation">.</span>onopen <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接成功，准备发送信息!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'发送信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
ws<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'后端返回的是'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不过， 原生的 WebSocket API 使用起来不太方便，可以使用 Socket.io，它很好地封装了 WebSocket 接口，提供了更简单、灵活的接口，也对不支持 WebSocket 的浏览器提供了向下兼容。</p><h3 id="9-Nginx-反向代理"><a href="#9-Nginx-反向代理" class="headerlink" title="9.Nginx 反向代理"></a>9.Nginx 反向代理</h3><p>因为还没学习 Nginx，这里就先不写了。只做个记录，以后学习了再来补充。</p><h3 id="10-Nodejs-中间件代理"><a href="#10-Nodejs-中间件代理" class="headerlink" title="10. Nodejs 中间件代理"></a>10. Nodejs 中间件代理</h3><p>原理和 nginx 相同，通过代理服务器，实现数据的转发 。</p><p><strong>参考：</strong></p><ul><li>《JavaScript 高级程序设计》第三版</li><li><a href="https://segmentfault.com/a/1190000012370451" target="_blank" rel="noopener">再也不学AJAX了！（三）跨域获取资源 ③ - WebSocket &amp; postMessage</a></li><li><a href="https://www.cnblogs.com/2050/p/3191744.html" target="_blank" rel="noopener">js 中几种常用的跨域方法详解</a></li><li><a href="https://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html" target="_blank" rel="noopener">JavaScript 跨域总结与解决方法</a></li><li><a href="https://github.com/FatDong1/cross-domain" target="_blank" rel="noopener">Cross-domain </a>GitHub demo</li></ul></div><div class="post-nav"><div class="post-nav-prev"><a href="/2019/11/13/F-Vue全家桶学习笔记：Vue-router /" rel="prev" title="Vue 全家桶学习笔记：Vue-router"><i class="fa fa-angle-double-left"></i>&nbspVue 全家桶学习笔记：Vue-router</a></div><div class="post-nav-next"><a href="/2019/11/07/F-AJAX与跨域通信（二）/" rel="next" title="AJAX 与跨域通信（二）：跨域解决方案">AJAX 与跨域通信（二）：跨域解决方案&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-postMessage"><span class="toc-text">6.postMessage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-location-hash"><span class="toc-text">7. location.hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-WebSocket"><span class="toc-text">8. WebSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-建立-WebSocket-连接"><span class="toc-text">8.1 建立 WebSocket 连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-发起请求"><span class="toc-text">8.2 发起请求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-Nginx-反向代理"><span class="toc-text">9.Nginx 反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-Nodejs-中间件代理"><span class="toc-text">10. Nodejs 中间件代理</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - 2019 My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->