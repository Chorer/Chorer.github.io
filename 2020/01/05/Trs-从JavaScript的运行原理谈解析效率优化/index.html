<!-- build time:Sat Apr 25 2020 14:05:02 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">【译】从JavaScript的运行原理谈解析效率优化</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2020-01-05&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp2.8k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp10 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><p><img src="https://i0.wp.com/blog.logrocket.com/wp-content/uploads/2019/12/how-javascript-works-optimizing-parsing-efficiency.png?fit=730%2C487&amp;ssl=1" alt="How JavaScript Works: Optimizing for Parsing Efficiency"></p><a id="more"></a><blockquote><ul><li>原文地址：<a href="https://blog.logrocket.com/how-javascript-works-optimizing-for-parsing-efficiency/" target="_blank" rel="noopener">How JavaScript works: Optimizing for parsing efficiency</a></li><li>原文作者：Alvin Wan</li><li>译者：Chor</li></ul></blockquote><p>编写高效率的 JavaScript ，其中一个关键就是要理解它的工作原理。编写高效代码的方法数不胜数，例如，你可以编写<a href="https://blog.logrocket.com/how-javascript-works-optimizing-the-v8-compiler-for-efficiency/" target="_blank" rel="noopener">对编译器友好的 JavaScript 代码</a>，从而避免<a href="https://www.freecodecamp.org/news/javascript-essentials-why-you-should-know-how-the-engine-works-c2cc0d321553/" target="_blank" rel="noopener">将一行简单代码的运行速度拖慢 7 倍</a>。</p><p>本文我们会专注讲解可以最小化 Javascript 代码解析时间的优化方法。我们进一步缩小范围，只讨论 V8 这一驱动 <a href="https://electronjs.org/" target="_blank" rel="noopener">Electron</a>， <a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js</a> 和 <a href="https://www.google.com/chrome/" target="_blank" rel="noopener">Google Chrome</a> 的 JS 引擎。为了理解这些对解析友好的优化方法，我们还得先讨论 JavaScript 的解析过程，在深入理解代码解析过程的基础上，再对三个编写更高速 JavaScript 的技巧进行一一概述。</p><p>先简单回顾一下 JavaScript 执行的三个阶段。</p><ol><li>从源代码到语法树 —— 解析器从源码中生成一棵 <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener">抽象语法树</a>。</li><li>从语法树到字节码 —— V8 的解释器 <a href="https://v8.dev/docs/ignition" target="_blank" rel="noopener">Ignition</a> 从语法树中生成字节码（<a href="https://docs.google.com/presentation/d/1chhN90uB8yPaIhx_h2M3lPyxPgdPmkADqSNAoXYQiVE/edit#slide=id.g18d89eb289_1_362" target="_blank" rel="noopener">在 2017 年之前</a> 并没有该步骤，具体可以看 <a href="https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e" target="_blank" rel="noopener">这篇文章</a>）。</li><li>从字节码到机器码 —— V8 的编译器 <a href="https://v8.dev/docs/turbofan" target="_blank" rel="noopener">TurboFan</a> 从字节码中生成图，用高度优化的机器码替代部分字节码。</li></ol><p>上述的第二和第三阶段 <a href="https://blog.logrocket.com/how-javascript-works-optimizing-the-v8-compiler-for-efficiency/" target="_blank" rel="noopener">涉及到了 JavaScript 的编译</a>。在这篇文章中，我们将重点介绍第一阶段并解释该阶段对编写高效 JavaScript 的影响。我们会按照从左到右、从上到下的顺序介绍解析管道，该管道接受源代码并生成一棵语法树。</p><p><img src="https://i1.wp.com/blog.logrocket.com/wp-content/uploads/2019/12/javascript-parsing.png?resize=730%2C411&amp;ssl=1" alt="Abstract Syntax Tree (AST) for JavaScript Parsing"></p><div style="font-size:16px;color:gray;text-align:center">抽象语法树（AST）。它是在解析器（图中蓝色部分）中创建的。</div><h2 id="扫描器"><a href="#扫描器" class="headerlink" title="扫描器"></a>扫描器</h2><p>源代码首先被分解成 chunk，每个 chunk 都可能采用不同的编码，稍后会有一个字符流将所有 chunk 的编码统一为 UTF-16。</p><p>在解析之前，扫描器会将 UTF-16 字符流分解成 token。token 是一段脚本中具有语义的最小单元。有不同类型的 token，包括空白符（用于 <a href="https://tc39.es/ecma262/#sec-automatic-semicolon-insertion" target="_blank" rel="noopener">自动插入分号</a>）、标识符、关键字以及代理对（仅当代理对无法被识别为其它东西时才会结合成标识符）。这些 token 之后被送往预解析器中，接着再送往解析器。</p><h2 id="预解析器"><a href="#预解析器" class="headerlink" title="预解析器"></a>预解析器</h2><p>解析器的工作量是最少的，只要足够跳过传入的源代码并进行懒解析（而不是全解析）即可。预解析器确保输入的源代码包含有效语法，并生成足够的信息来正确地编译外部函数。这个准备好的函数稍后将按需编译。</p><h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>解析器接收到扫描器生成的 token 后，现在需要生成一个供编译器使用的中间表示。</p><p>首先我们来讨论解析树。解析树，或者说 <a href="https://en.wikipedia.org/wiki/Parse_tree" target="_blank" rel="noopener">具体语法树（CST）</a>将源语法表示为一棵树。每个叶子节点都是一个 token，而每个中间节点则表示一个语法规则。在英语里，语法规指的是名词、主语等，而在编程里，语法规则指的是一个表达式。不过，解析树的大小随着程序大小会增长得很快。</p><p>相反，<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener">抽象语法树</a> 要更加简洁。每个中间节点表示一个结构，比如一个减法运算（<code>-</code>），并且这棵树并没有展示源代码的所有细节。例如，由括号定义的分组是蕴含在树的结构中的。另外，标点符号、分隔符以及空白符都被省略了。你可以在 <a href="https://ruslanspivak.com/lsbasi-part7/" target="_blank" rel="noopener">这里</a> 了解更多 AST 和 CST 的区别。</p><p>接下来我们将重点放在 AST 上。以下面用 JavaScript 编写的斐波那契程序为例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span> 
  <span class="token keyword">return</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token number">-2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>下面的 JSON 文件就是对应的<a href="https://gist.github.com/alvinwan/845fd8ecbb559124271bfdc7bf4491f6" target="_blank" rel="noopener">抽象语法</a>了。这是用 <a href="https://astexplorer.net/#/gist/638ea8b192e66137d361988bc7772f39/81a762666377d6bb1853d79409378b9f0233b67d" target="_blank" rel="noopener">AST Explorer</a> 生成的。（如果你不熟悉这个，可以点击这里来详细了解 <a href="https://blog.logrocket.com/using-typescript-transforms-to-enrich-runtime-code-3fd2863221ed/" target="_blank" rel="noopener">如何阅读 JSON 格式的 AST</a>）。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Program"</span><span class="token punctuation">,</span>
  <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">73</span><span class="token punctuation">,</span>
  <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"FunctionDeclaration"</span><span class="token punctuation">,</span>
      <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">73</span><span class="token punctuation">,</span>
      <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
        <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
        <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"fib"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"expression"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string">"generator"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string">"async"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
          <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
          <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
          <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"n"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BlockStatement"</span><span class="token punctuation">,</span>
        <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">73</span><span class="token punctuation">,</span>
        <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"IfStatement"</span><span class="token punctuation">,</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span>
            <span class="token string">"test"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BinaryExpression"</span><span class="token punctuation">,</span>
              <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
              <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
              <span class="token string">"left"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
                <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"n"</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string">"operator"</span><span class="token punctuation">:</span> <span class="token string">"&lt;="</span><span class="token punctuation">,</span>
              <span class="token string">"right"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span>
                <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">29</span><span class="token punctuation">,</span>
                <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
                <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">"raw"</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"consequent"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ReturnStatement"</span><span class="token punctuation">,</span>
              <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
              <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span>
              <span class="token string">"argument"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">39</span><span class="token punctuation">,</span>
                <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"n"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"alternate"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ReturnStatement"</span><span class="token punctuation">,</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">44</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">71</span><span class="token punctuation">,</span>
            <span class="token string">"argument"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BinaryExpression"</span><span class="token punctuation">,</span>
              <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">51</span><span class="token punctuation">,</span>
              <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
              <span class="token string">"left"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span>
                <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">51</span><span class="token punctuation">,</span>
                <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">59</span><span class="token punctuation">,</span>
                <span class="token string">"callee"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                  <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">51</span><span class="token punctuation">,</span>
                  <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">54</span><span class="token punctuation">,</span>
                  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"fib"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"arguments"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BinaryExpression"</span><span class="token punctuation">,</span>
                    <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">55</span><span class="token punctuation">,</span>
                    <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">58</span><span class="token punctuation">,</span>
                    <span class="token string">"left"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                      <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">55</span><span class="token punctuation">,</span>
                      <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span>
                      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"n"</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"operator"</span><span class="token punctuation">:</span> <span class="token string">"-"</span><span class="token punctuation">,</span>
                    <span class="token string">"right"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span>
                      <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">57</span><span class="token punctuation">,</span>
                      <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">58</span><span class="token punctuation">,</span>
                      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                      <span class="token string">"raw"</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string">"operator"</span><span class="token punctuation">:</span> <span class="token string">"+"</span><span class="token punctuation">,</span>
              <span class="token string">"right"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"CallExpression"</span><span class="token punctuation">,</span>
                <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">62</span><span class="token punctuation">,</span>
                <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
                <span class="token string">"callee"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                  <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                  <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">62</span><span class="token punctuation">,</span>
                  <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"fib"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"arguments"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BinaryExpression"</span><span class="token punctuation">,</span>
                    <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">66</span><span class="token punctuation">,</span>
                    <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">69</span><span class="token punctuation">,</span>
                    <span class="token string">"left"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
                      <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">66</span><span class="token punctuation">,</span>
                      <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">67</span><span class="token punctuation">,</span>
                      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"n"</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"operator"</span><span class="token punctuation">:</span> <span class="token string">"-"</span><span class="token punctuation">,</span>
                    <span class="token string">"right"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"Literal"</span><span class="token punctuation">,</span>
                      <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">68</span><span class="token punctuation">,</span>
                      <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">69</span><span class="token punctuation">,</span>
                      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                      <span class="token string">"raw"</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"sourceType"</span><span class="token punctuation">:</span> <span class="token string">"module"</span>
<span class="token punctuation">}</span>

（来源：GitHub）
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码的要点是，每个非叶子节点都是一个运算符，而每个叶子节点都是操作数。这棵语法树稍后将作为输入传给 JavaScript 接着要执行的两个阶段。</p><h2 id="三个技巧优化你的-JavaScript"><a href="#三个技巧优化你的-JavaScript" class="headerlink" title="三个技巧优化你的 JavaScript"></a>三个技巧优化你的 JavaScript</h2><p>下面罗列的技巧清单中，我会省略那些已经广泛使用的技巧，例如缩减代码来最大化信息密度，从而使扫描器更具有时效性。另外，我也会跳过那些适用范围很小的建议，例如避免使用非 ASCII 字符。</p><p>提高解析性能的方法数不胜数，让我们着眼于其中适用范围最广泛的方法吧。</p><h3 id="1-尽可能遵从工作线程"><a href="#1-尽可能遵从工作线程" class="headerlink" title="1.尽可能遵从工作线程"></a>1.尽可能遵从工作线程</h3><p>主线程被阻塞会导致用户交互的延迟，所以应该尽可能减少主线程上的工作。关键就是要识别并避免会导致主线程中某些任务长时间运行的解析行为。</p><p>这种启发式超出了解析器的优化范围。例如，用户控制的 JavaScript 代码段可以使用 <a href="https://blog.logrocket.com/using-webworkers-for-safe-concurrent-javascript-3f33da4eb0b2/" target="_blank" rel="noopener">web workers</a> 达到相同的效果。你可以阅读 <a href="https://blog.logrocket.com/real-time-processing-web-workers/" target="_blank" rel="noopener">实时处理应用</a> 和 <a href="https://blog.logrocket.com/how-to-execute-a-function-with-a-web-worker-on-a-different-thread-in-angular/" target="_blank" rel="noopener">在 angular 中使用 web workers</a> 来了解更多信息。</p><h4 id="避免使用大量的内联脚本"><a href="#避免使用大量的内联脚本" class="headerlink" title="避免使用大量的内联脚本"></a>避免使用大量的内联脚本</h4><p>内联脚本是在主线程中处理的，根据之前的说法，应该尽量避免这样做。事实上，除了异步和延迟加载之外，任何 JavaScript 的加载都会阻塞主线程。</p><h4 id="避免嵌套外层函数"><a href="#避免嵌套外层函数" class="headerlink" title="避免嵌套外层函数"></a>避免嵌套外层函数</h4><p>懒编译也是发生在主线程上的。不过，如果处理得当的话，懒解析可以加快启动速度。想要<a href="https://blog.sessionstack.com/how-javascript-works-parsing-abstract-syntax-trees-asts-5-tips-on-how-to-minimize-parse-time-abfcf7e8a0c8" target="_blank" rel="noopener">强制进行全解析</a>的话，可以使用诸如 <a href="https://github.com/nolanlawson/optimize-js" target="_blank" rel="noopener">optimize.js</a>（已经不维护）这样的工具来决定进行全解析或者懒解析。</p><h4 id="分解超过-100kB-的文件"><a href="#分解超过-100kB-的文件" class="headerlink" title="分解超过 100kB 的文件"></a>分解超过 100kB 的文件</h4><p>将大文件分解成小文件以最大化并行脚本的加载速度。“<a href="https://v8.dev/blog/cost-of-javascript-2019#impact" target="_blank" rel="noopener">2019 年 JavaScript 的性能开销</a>”一文比较了 Facebook 网站和 Reddit 网站的文件大小。前者通过在 300 多个请求中拆分大约 6MB 的 JavaScript ，成功将解析和编译工作在主线程上的占比控制到 30%；相反，Reddit 的主线程上进行解析和编译工作的达到了将近 80%。</p><h2 id="2-使用-JSON-而不是对象字面量-——-偶尔"><a href="#2-使用-JSON-而不是对象字面量-——-偶尔" class="headerlink" title="2. 使用 JSON 而不是对象字面量 —— 偶尔"></a>2. 使用 JSON 而不是对象字面量 —— 偶尔</h2><p>在 JavaScript 中，解析 JSON 比解析对象字面量来得更加高效。 <a href="https://github.com/GoogleChromeLabs/json-parse-benchmark" target="_blank" rel="noopener">parsing benchmark</a> 已经证实了这一点。在不同的主流 JavaScript 执行引擎中分别解析一个 8MB 大小的文件，前者的解析速度最高可以提升 2 倍。</p><p><a href="https://youtu.be/ff4fgQxPaO0" target="_blank" rel="noopener">2019 年谷歌开发者大会</a> 也讨论过 JSON 解析如此高效的两个原因：</p><ol><li>JSON 是单字符串 token，而对象字面量可能包含大量的嵌套对象和 token；</li><li>语法对上下文是敏感的。解析器逐字检查源代码，并不知道某个代码块是一个对象字面量。而左大括号不仅可以表明它是一个对象字面量，还可以表明它是一个解构对象或者箭头函数。</li></ol><p>不过，值得注意的是，<code>JSON.parse</code> 同样会阻塞主线程。对于超过 1MB 的文件，可以使用 <a href="https://google.github.io/flatbuffers/flatbuffers_guide_use_javascript.html" target="_blank" rel="noopener">FlatBuffers</a> <a href="https://engineering.fb.com/android/improving-facebook-s-performance-on-android-with-flatbuffers/" target="_blank" rel="noopener">提高解析效率</a>。</p><h2 id="3-最大化代码缓存"><a href="#3-最大化代码缓存" class="headerlink" title="3. 最大化代码缓存"></a>3. 最大化代码缓存</h2><p>最后，你可以通过完全规避解析来提高解析效率。对于服务端编译来说， <a href="https://blog.logrocket.com/webassembly-how-and-why-559b7f96cd71/" target="_blank" rel="noopener">WebAssembly</a> <a href="https://blog.logrocket.com/webassembly-how-and-why-559b7f96cd71/" target="_blank" rel="noopener">(WASM)</a> 是个不错的选择。然而，它没办法替代 JavaScript。对于 JS，更合适的方法是最大化代码缓存。</p><p>值得注意的是，缓存并不是任何时候都生效的。在执行结束之前编译的任何代码都会被缓存 —— 这意味着处理器、监听器等不会被缓存。为了最大化代码缓存，你必须最大化执行结束之前编译的代码数量。其中一个方法就是使用立即执行函数（IIFE）启发式：解析器会通过启发式的方法标识出这些 IIFE 函数，它们会在稍后立即被编译。因此，使用启发式的方法可以确保一个函数在脚本执行结束之前被编译。</p><p>此外，缓存是基于单个脚本执行的。这意味着更新脚本将会使缓存失效。V8 团队建议可以<a href="https://v8.dev/blog/code-caching-for-devs#split" target="_blank" rel="noopener">分割</a>脚本或者<a href="https://v8.dev/blog/code-caching-for-devs#merge" target="_blank" rel="noopener">合并</a>脚本，从而实现代码缓存。但是，这两个建议是互相矛盾的。你可以阅读“<a href="https://v8.dev/blog/code-caching-for-devs" target="_blank" rel="noopener">JavaScript 开发中的代码缓存</a>”来了解更多代码缓存相关的信息。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>解析时间的优化涉及到工作线程的延迟解析以及通过最大化缓存来避免完全解析。理解了 V8 的解析机制后，我们也能推断出上面没有提到的其它优化方法。</p><p>下面给出了更多了解解析机制的资源，这个机制通常来说同时适用于 V8 和 JavaScript 的解析。</p><ul><li><a href="https://v8.dev/docs" target="_blank" rel="noopener">V8 文档</a></li><li><a href="https://v8.dev/blog" target="_blank" rel="noopener">V8 博客</a></li><li><a href="https://github.com/thlorenz/v8-perf" target="_blank" rel="noopener">V8-perf</a></li></ul><h2 id="额外小贴士：理解-JavaScript-的错误和性能是如何影响你的用户的。"><a href="#额外小贴士：理解-JavaScript-的错误和性能是如何影响你的用户的。" class="headerlink" title="额外小贴士：理解 JavaScript 的错误和性能是如何影响你的用户的。"></a>额外小贴士：理解 JavaScript 的错误和性能是如何影响你的用户的。</h2><p>跟踪生产过程中 JavaScript 的异常或者错误是很耗时的，而且也很令人伤脑筋。如果你有兴趣监控 JavaScript 的错误和应用性能是如何对用户造成影响的，可以<a href="https://logrocket.com/signup/" target="_blank" rel="noopener">尝试使用 LogRocket</a>。</p><p><img src="https://i1.wp.com/blog.logrocket.com/wp-content/uploads/2019/10/errors-screenshot.png?ssl=1" alt="LogRocket Dashboard Free Trial Banner"></p><p><a href="https://logrocket.com/signup/" target="_blank" rel="noopener">LogRocket</a> 就像是为 web 应用量身订造的 DVR（录像机），它可以确切地记录你的网站上发生的所有事情。LogRocket 可以帮助你统计并报告错误，以查看错误发生的频率以及它们对你的用户群的影响程度。你可以轻松地重现错误发生时特定的用户会话，以查看是用户的哪些操作导致了 bug。</p><p>LogRocket 可以记录你的 app 上的请求和响应（包含 header 和 body）以及用户相关的上下文信息，从而窥探问题全貌。它也可以记录页面的 HTML 和 CSS，即使是面对最复杂的单页面应用，也可以重构出像素完美级别的视频。</p><p>如果你想提高你的 JavaScript 错误监控能力，LogRocket 是个<a href="https://logrocket.com/signup/" target="_blank" rel="noopener">不错的选择</a>。</p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2020/01/07/Trs-%E8%BF%99%E4%BA%9B%E7%90%86%E7%94%B1%E5%91%8A%E8%AF%89%E4%BD%A0%EF%BC%8C%E4%BD%A0%E6%97%A9%E5%B0%B1%E8%AF%A5%E6%94%BE%E5%BC%83%E6%94%AF%E6%8C%81IE%E4%BA%86/" rel="prev" title="【译】这些理由告诉你，你早就该放弃支持IE了"><i class="fa fa-angle-double-left"></i>&nbsp【译】这些理由告诉你，你早就该放弃支持IE了</a></div><div class="post-nav-next"><a href="/2020/01/02/Trs-%E6%B3%A8%E5%86%8C%E4%B8%8E%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E7%9A%84%2022%E6%9D%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" rel="next" title="【译】注册与登录流程的 22 条设计原则">【译】注册与登录流程的 22 条设计原则&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#扫描器"><span class="toc-text">扫描器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预解析器"><span class="toc-text">预解析器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解析"><span class="toc-text">解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三个技巧优化你的-JavaScript"><span class="toc-text">三个技巧优化你的 JavaScript</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-尽可能遵从工作线程"><span class="toc-text">1.尽可能遵从工作线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#避免使用大量的内联脚本"><span class="toc-text">避免使用大量的内联脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#避免嵌套外层函数"><span class="toc-text">避免嵌套外层函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分解超过-100kB-的文件"><span class="toc-text">分解超过 100kB 的文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-使用-JSON-而不是对象字面量-——-偶尔"><span class="toc-text">2. 使用 JSON 而不是对象字面量 —— 偶尔</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-最大化代码缓存"><span class="toc-text">3. 最大化代码缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#额外小贴士：理解-JavaScript-的错误和性能是如何影响你的用户的。"><span class="toc-text">额外小贴士：理解 JavaScript 的错误和性能是如何影响你的用户的。</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2020</span> My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->