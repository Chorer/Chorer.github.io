<!-- build time:Sun Jun 02 2019 21:22:29 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Chor&#39;s Blog</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third party/pace-theme-flash.css"><link rel="icon" href="/images/me.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="header"><span class="theme"><i class="fa fa-bars"></i> <a href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></span><div class="blog-title"><a href="/" class="logo">Chor&#39;s Blog</a><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><nav class="navbar"><ul class="menu"><li class="menu-item"><a href="/" class="menu-item-link">HOME</a></li><li class="menu-item"><a href="/categories" class="menu-item-link">CATEGORIES</a></li><li class="menu-item"><a href="/archives" class="menu-item-link">ARCHIVES</a></li><li class="menu-item"><a href="/tags" class="menu-item-link">TAGS</a></li><li class="menu-item"><a href="/about" class="menu-item-link">ABOUT</a></li></ul></nav><i id="homelink" data-link="https://chorer.github.io/"></i></header><main class="main"><section class="posts"><article class="post"><div class="post-title"><a class="post-title-link" href="/2019/04/08/F-深入理解执行上下文和执行栈/">深入理解执行上下文和执行栈</a></div><div class="post-sub_title"></div><div class="post-date"><span class="date-text"><i class="fa fa-calendar"></i>Date:&nbsp&nbsp2019-04-08</span></div><div class="post-tags"><span class="post-tags-list"><i class="fa fa-bookmark"></i> Tags:&nbsp&nbsp&nbsp </span><a href="/tags/执行上下文/"><i class="fa fa-tag"></i> 执行上下文</a> <a href="/tags/词法环境/"><i class="fa fa-tag"></i> 词法环境</a></div><div class="post-statistic"><span class="post-words"><i class="fa fa-pencil-square-o"></i> <span class="text_words">Count: </span><span>2.4k words</span> </span>&nbsp| &nbsp<span class="post-time"> <i class="fa fa-clock-o"></i> <span class="text_time">Time: </span><span>9 mins</span></span></div><div class="post-content"><p>执行上下文、执行栈、作用域链、闭包，这其实是一整套相关的东西，之前<a href="https://chorer.github.io/2019/03/04/F-%E9%97%AD%E5%8C%85/">转载的文章</a>也有讲到这些。下面两篇文章会更加详细地解释这些概念。</p><ul><li><a href="https://chorer.github.io/2019/04/08/F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E6%89%A7%E8%A1%8C%E6%A0%88/">深入理解执行上下文和执行栈</a></li><li><a href="https://chorer.github.io/2019/04/10/F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%8F%98%E9%87%8F%E5%AF%B9%E8%B1%A1%E3%80%81%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE%E5%92%8C%E9%97%AD%E5%8C%85/">深入理解变量对象、作用域链和闭包</a></li></ul><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/execution%20context/ecstack.jpg" alt=""><br><a id="more"></a></p><h1 id="1-执行上下文"><a href="#1-执行上下文" class="headerlink" title="1.执行上下文"></a>1.执行上下文</h1><h2 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h2><p>执行上下文（execution context）是当前 JavaScript 代码被解析和执行时所在环境的抽象概念，</p><h2 id="1-2-类型"><a href="#1-2-类型" class="headerlink" title="1.2 类型"></a>1.2 类型</h2><ul><li>全局执行上下文<br>只有一个。它创建了一个全局对象（浏览器中是window对象），并将this指向该对象。</li><li>函数执行上下文<br>无数个。每次调用函数时，都会为该函数创建一个新的执行上下文。</li><li>eval函数执行上下文<br>运行在 eval 函数中的代码也获得了自己的执行上下文，eval函数不常用，所以这里不讨论</li></ul><h1 id="2-执行栈"><a href="#2-执行栈" class="headerlink" title="2.执行栈"></a>2.执行栈</h1><p>执行栈（execution stack），也即调用栈（call stack），具有 LIFO（后进先出）结构，用于存储在代码执行期间创建的所有执行上下文。<br>当 JavaScript 引擎首次读取脚本时，它会创建一个全局执行上下文并将其push到当前的执行栈。每当调用函数的时候，都会为该函数创建一个新的执行上下文并将其push到栈顶；在函数执行完毕后，对应的执行上下文将会从栈顶pop出，上下文控制权将移到当前执行栈的下一个执行上下文。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Inside first function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Again inside first function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Inside second function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Inside Global Execution Context'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Inside first function</span>
<span class="token comment" spellcheck="true">// Inside second function</span>
<span class="token comment" spellcheck="true">// Again inside first function</span>
<span class="token comment" spellcheck="true">// Inside Global Execution Context</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/execution%20context/1111.png" alt=""></p><h1 id="3-执行上下文的创建"><a href="#3-执行上下文的创建" class="headerlink" title="3.执行上下文的创建"></a>3.执行上下文的创建</h1><p>执行上下文分两个阶段创建：1）创建阶段（The Creation Phase）； 2）执行阶段（The Execution Phase）</p><h2 id="3-1-创建阶段"><a href="#3-1-创建阶段" class="headerlink" title="3.1 创建阶段"></a>3.1 创建阶段</h2><ul><li>词法环境组件被创建</li><li>变量环境组件被创建</li></ul><p>用伪代码表示就是：</p><pre class="line-numbers language-js"><code class="language-js">ExecutionContext <span class="token operator">=</span> <span class="token punctuation">{</span>  
  LexicalEnvironment <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 词法环境</span>
  VariableEnvironment <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 变量环境</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-1-词法环境"><a href="#3-1-1-词法环境" class="headerlink" title="3.1.1 词法环境"></a>3.1.1 词法环境</h3><p>词法环境（Lexical environment）是一个包含标识符变量映射的结构。（这里的标识符表示变量/函数的名称，变量是对实际对象【包括函数类型对象】或原始值的引用）</p><p>词法环境有三个组成部分：</p><ul><li>环境记录：存储变量和函数声明的实际位置</li><li>对外部环境的引用：可以访问其外部词法环境</li><li>this绑定：确定this的指向</li></ul><p>词法环境有两种类型：</p><ul><li>全局环境：全局执行上下文的词法环境。</li><li>函数环境：函数执行上下文的词法环境。</li></ul><h4 id="3-1-1-1-环境记录："><a href="#3-1-1-1-环境记录：" class="headerlink" title="3.1.1.1 环境记录："></a>3.1.1.1 环境记录：</h4><p>根据词法环境的两种类型，环境记录（Environment record）同样也有两种类型：</p><ul><li><p>对象环境记录（Object environment record）：<br>全局环境的环境记录类型。存储全局变量和函数声明、全局对象（window 对象）和关联的属性/方法。</p></li><li><p>声明性环境记录（Declarative environment record）：<br>函数环境的环境记录类型。存储局部变量和函数声明、<code>arguments</code>对象。<code>arguments</code>对象包含了索引与参数之间的映射，以及传给函数的参数的个数。</p></li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// argument object</span>
Arguments<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-1-1-2-外部环境引用："><a href="#3-1-1-2-外部环境引用：" class="headerlink" title="3.1.1.2 外部环境引用："></a>3.1.1.2 外部环境引用：</h4><p>外部环境引用（Reference to the outer environment）表明当前词法环境能够访问外部词法环境。这意味着如果JavaScript引擎未在当前词法环境找到变量，它将向外部词法环境寻找（这有点类似原型链中的属性查找）</p><p>全局环境没有外部环境，其外部环境引用为 null。</p><p>函数环境有外部环境，其外部环境引用可以是全局环境，也可以是包含内部函数的外部函数环境。</p><h4 id="3-1-1-3-this绑定："><a href="#3-1-1-3-this绑定：" class="headerlink" title="3.1.1.3 this绑定："></a>3.1.1.3 this绑定：</h4><p>全局执行上下文中，this绑定（this binding）到全局对象（对于浏览器，该对象为window）；函数执行上下文中，this绑定到谁将取决于函数的调用位置（或者说调用方法）。<br>我会在另一篇文章总结this的绑定机制，所以这里不再展开。</p><p>讲完了词法环境的三个组成部分，最后再配合伪代码理解一下：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 全局执行上下文</span>
GlobalExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
  LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 标识符绑定在这里 </span>
    <span class="token punctuation">}</span>
    outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>global object<span class="token operator">></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 函数执行上下文</span>
FunctionExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
  LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      Type<span class="token punctuation">:</span> <span class="token string">"Declarative"</span><span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 标识符绑定在这里 </span>
    <span class="token punctuation">}</span>
    outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global or outer <span class="token keyword">function</span> environment reference<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>depends on how <span class="token keyword">function</span> is called<span class="token operator">></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-2-变量环境"><a href="#3-1-2-变量环境" class="headerlink" title="3.1.2 变量环境"></a>3.1.2 变量环境</h3><p>变量环境（Variable environment）同样也是词法环境，因此它具有上面定义的词法环境的所有特征。这两者的区别主要在于：<br>在 ES6 中，词法环境用于存储函数声明和变量（let和const）绑定，而变量环境仅用于存储变量（var）绑定。</p><h2 id="3-2-执行阶段"><a href="#3-2-执行阶段" class="headerlink" title="3.2 执行阶段"></a>3.2 执行阶段</h2><p>在执行阶段，完成对所有变量的分配，最后执行代码。</p><h2 id="3-3-举例说明"><a href="#3-3-举例说明" class="headerlink" title="3.3 举例说明"></a>3.3 举例说明</h2><p>通过一个例子来了解执行上下文的整个创建和执行过程。<br>以下面的代码为例</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> c<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> e <span class="token operator">*</span> f <span class="token operator">*</span> g<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
c <span class="token operator">=</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在开始读取代码后，JavaScript引擎创建全局执行上下文并压栈，全局执行上下文的创建阶段的伪代码如下：</p><pre class="line-numbers language-js"><code class="language-js">GlobalExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 词法环境</span>
  LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
      a<span class="token punctuation">:</span> <span class="token operator">&lt;</span> uninitialized <span class="token operator">></span><span class="token punctuation">,</span>
      b<span class="token punctuation">:</span> <span class="token operator">&lt;</span> uninitialized <span class="token operator">></span><span class="token punctuation">,</span>
      multiply<span class="token punctuation">:</span> <span class="token operator">&lt;</span> func <span class="token operator">></span>
    <span class="token punctuation">}</span>
    outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
    ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object<span class="token operator">></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment" spellcheck="true">// 变量环境</span>
  VariableEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
      c<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
    ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object<span class="token operator">></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之后进入全局执行上下文的执行阶段，开始进行变量分配/赋值，伪代码如下：</p><pre class="line-numbers language-js"><code class="language-js">GlobalExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 词法环境</span>
    LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        a<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        b<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
        multiply<span class="token punctuation">:</span> <span class="token operator">&lt;</span> func <span class="token operator">></span>
        <span class="token punctuation">}</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object<span class="token operator">></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 变量环境</span>
    VariableEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        c<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object<span class="token operator">></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>随着执行阶段的进行，我们遇到了<code>multiply(20, 30)</code>，这是一个函数调用语句，所以此时创建了该函数对应的函数执行上下文并压栈，函数执行上下文的创建阶段的伪代码如下：</p><pre class="line-numbers language-js"><code class="language-js">FunctionExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 词法环境</span>
    LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Declarative"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        Arguments<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span>GlobalLexicalEnvironment<span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object or undefined<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 变量环境</span>
    VariableEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Declarative"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        g<span class="token punctuation">:</span> undefined
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span>GlobalLexicalEnvironment<span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object or undefined<span class="token operator">></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之后进入函数执行上下文的执行阶段，开始进行函数内的变量的分配/赋值，伪代码如下：</p><pre class="line-numbers language-js"><code class="language-js">FunctionExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 词法环境</span>
    LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Declarative"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        Arguments<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> length<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span>GlobalLexicalEnvironment<span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object or undefined<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 变量环境</span>
    VariableEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Declarative"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        g<span class="token punctuation">:</span> <span class="token number">20</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span>GlobalLexicalEnvironment<span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object or undefined<span class="token operator">></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数执行完毕，函数执行上下文出栈，此时的执行上下文是全局执行上下文。由于函数的返回值被赋给变量c，此时全局执行上下文对应的全局词法环境得到更新，伪代码如下：</p><pre class="line-numbers language-js"><code class="language-js">GlobalExectionContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 词法环境</span>
    LexicalEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        a<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        b<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
        multiply<span class="token punctuation">:</span> <span class="token operator">&lt;</span> func <span class="token operator">></span>
        <span class="token punctuation">}</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object<span class="token operator">></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 变量环境</span>
    VariableEnvironment<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        EnvironmentRecord<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span> <span class="token string">"Object"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 标识符绑定在这里</span>
        c<span class="token punctuation">:</span> <span class="token number">12000</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        outer<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">></span><span class="token punctuation">,</span>
        ThisBinding<span class="token punctuation">:</span> <span class="token operator">&lt;</span>Global Object<span class="token operator">></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>全局执行上下文的执行阶段结束，程序结束。</p><p><strong>补充</strong>：</p><p>在全局执行上下文创建阶段的伪代码中我们可以看到，<code>let</code>和<code>const</code>定义的变量没有任何与之关联的值，但<code>var</code>定义的变量设置为<code>undefined</code>。</p><p>这是因为在创建阶段，JavaScript引擎会扫描一遍代码并解析所有的变量和函数声明，其中函数声明被存储在环境记录中，而变量的情况则比较特殊：<code>var</code>声明的变量将被设置为<code>undefined</code>，<code>let</code>和<code>const</code>声明的变量将保持未初始化。</p><p>因此，我们可以在声明之前就访问<code>var</code>定义的变量（尽管是<code>undefined</code> ），但如果在声明之前访问<code>let</code>和<code>const</code>定义的变量则会提示引用错误（因为在执行阶段之前其始终是未初始化的）。</p><p>这就是我们所谓的变量提升。</p><p>注： 在执行阶段，如果Javascript引擎在源代码中声明的实际位置找不到 <code>let</code>变量的值，那么将为其分配<code>undefined</code>值。</p><hr><p><strong>注意</strong>：<br>如果你发现译文和原文的说法存在出入，例如：<br><span style="background-color:#fffa7d">在原文中</span>：</p><blockquote><p>The execution context is created during the creation phase. Following things happen during the creation phase:<br>1.LexicalEnvironment component is created.<br>2.VariableEnvironment component is created.</p></blockquote><blockquote><p>Each Lexical Environment has three components:<br>1.Environment Record<br>2.Reference to the outer environment,<br>3.This binding</p></blockquote><p><span style="background-color:#fffa7d">在译文中</span>：</p><blockquote><p>在任何 JavaScript 代码执行之前，执行环境经历了创建阶段，创建阶段包含以下三个事：<br>1.this 的值确定，也被称为 This Binding.<br>2.Lexical Environment 被创建。<br>3.Variable Environment 被创建。</p></blockquote><blockquote><p>在词法环境中，有两种组件：<br>(1) environment record<br>(2) reference to the outer environment.</p></blockquote><p>这是因为（请看这幅图）：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/execution%20context/2222.png" alt=""></p><p>总而言之是由于ECAMAScript的标准变更导致的。原文最初是基于ES5编写的，this绑定的确是执行上下文创建阶段的一环，但是在<del>ES2015</del> ES2018 的规范中，this绑定被并入词法环境的环境记录，所以原作者后来进行了更改，只是各种翻译和转载没有改过来就是了。关于具体内容，可以参考：<br><a href="https://es5.github.io/#x10.2" target="_blank" rel="noopener">ES5规范</a><br><a href="http://www.ecma-international.org/ecma-262/6.0/index.html#table-23" target="_blank" rel="noopener">ES6规范</a><br><a href="http://dmitrysoshnikov.com/ecmascript/es5-chapter-3-2-lexical-environments-ecmascript-implementation/#structure-of-execution-context" target="_blank" rel="noopener">上图的文章</a></p><hr><p>本文参考：<br><a href="https://blog.bitsrc.io/understanding-execution-context-and-execution-stack-in-javascript-1c9ea8642dd" target="_blank" rel="noopener">原文</a><br><a href="https://github.com/RicoLiu/automatic-goggles/issues/9" target="_blank" rel="noopener">译文</a></p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2019/04/10/F-深入理解变量对象、作用域链和闭包/" rel="prev" title="深入理解变量对象、作用域链和闭包"><i class="fa fa-chevron-left"></i>深入理解变量对象、作用域链和闭包</a></div><div class="post-nav-next"><a href="/2019/04/04/P-PureBlue主题更新记录/" rel="next" title="PureBlue主题更新记录">PureBlue主题更新记录<i class="fa fa-chevron-right"></i></a></div></div></article><div class="post-toc"><div id="post-catalog-text" data-catalog="Catalog"></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-执行上下文"><span class="toc-text">1.执行上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-定义"><span class="toc-text">1.1 定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-类型"><span class="toc-text">1.2 类型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-执行栈"><span class="toc-text">2.执行栈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-执行上下文的创建"><span class="toc-text">3.执行上下文的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-创建阶段"><span class="toc-text">3.1 创建阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-词法环境"><span class="toc-text">3.1.1 词法环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-1-环境记录："><span class="toc-text">3.1.1.1 环境记录：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-2-外部环境引用："><span class="toc-text">3.1.1.2 外部环境引用：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-3-this绑定："><span class="toc-text">3.1.1.3 this绑定：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-变量环境"><span class="toc-text">3.1.2 变量环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-执行阶段"><span class="toc-text">3.2 执行阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-举例说明"><span class="toc-text">3.3 举例说明</span></a></li></ol></li></ol><div id="post-toTop-text" data-totop="Back"></div></div><div id="vcomments"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - 2019 My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/search.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script><script src="/js/BgPic.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:150,height:300,vOffset:-120,hOffset:-5},mobile:{show:!1},react:{opacityDefault:1e3,opacityOnHover:1e3},log:!1})</script></body></html><!-- rebuild by neat -->