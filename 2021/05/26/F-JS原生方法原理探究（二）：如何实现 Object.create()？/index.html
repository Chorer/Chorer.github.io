<!-- build time:Sun Sep 05 2021 18:51:39 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">JS 原生方法原理探究（二）：如何实现 Object.create？</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2021-05-26&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.2k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp4 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><span id="more"></span><p>这是JS 原生方法原理探究系列的第二篇文章。本文会介绍如何实现 <code>Object.create()</code> 方法。关于这个方法的具体用法，MDN 已经描述得很清楚了，这里我们只做简单的介绍，具体的重点在于如何模拟实现。</p><h2 id="语法简介">语法简介</h2><blockquote><p>调用：Object.create ( proto , propertiesObject )</p><p>返回： 一个新的实例对象</p></blockquote><p>调用这个方法的时候接受两个参数，第一个参数作为返回对象的 <code>__proto__</code>，这个参数只能是 null 或者对象（而且不能是基本类型的包装对象）。</p><p>第二个参数作为返回对象的属性描述，它和 <code>Object.defineProperties()</code> 的第二个参数形式是一样的：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span>
    propertyA<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        value<span class="token operator">:</span> xxx<span class="token punctuation">,</span>
        configurable<span class="token operator">:</span> xxx<span class="token punctuation">,</span>
        enumerable<span class="token operator">:</span> xxx<span class="token punctuation">,</span>
        writable<span class="token operator">:</span> xxx    
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    propertyB<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    propertyC<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个参数的每一个属性都会作为返回对象的属性，而属性值则是相应属性的特性描述（该属性的属性值、是否可读、是否可枚举、是否可配置）。第二个参数只能是对象或者 undefined（表示没有传第二个参数），不能是 null。</p><h2 id="es-规范">ES 规范</h2><p>对于 <code>Object.create()</code> 的具体实现，规范中其实已经描述得很清楚，可以进入http://es5.github.io/#x15.2.3.5查看：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/2.jpg"></div><p>我简单翻译一下这段话：</p><p><code>create()</code> 方法会创建一个具有指定原型的新对象，当调用该方法的时候，会有如下步骤：</p><ol style="list-style-type:decimal"><li>如果传入的参数 <code>O</code> 不是对象也不是 <code>null</code>，抛出 TypeError 错误</li><li>令 <code>obj</code> 作为调用 <code>new Object()</code> 方法所创建的新对象</li><li>将 <code>obj</code> 的内部属性 <code>[[prototype]]</code> 设置为 <code>O</code></li><li>如果提供了第二个参数 <code>Properties</code>，且不是 <code>undefined</code>，则调用 <code>Object.defineProperties</code> 方法并传入 <code>obj</code> 和 <code>Properties</code> 作为参数，从而为 <code>obj</code> 添加它自己的属性</li><li>返回 <code>obj</code></li></ol><p>可以说，整个过程是一目了然的，我们实现的时候也只需要按照上述步骤实现即可。</p><h2 id="代码实现">代码实现</h2><p>我们先看第一种实现：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">Object<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">proto<span class="token punctuation">,</span>propertiesObject</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> proto <span class="token operator">!=</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> proto <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'the first param must be an object or null'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> propertiesObject <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token string">'TypeError'</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> proto
    <span class="token keyword">if</span><span class="token punctuation">(</span>propertiesObject<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>propertiesObject<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> obj
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>基本上没有什么大问题。不过，我们要留意两个地方：</p><ul><li>在这个实现中，没有检测第一个参数是不是基本类型的包装对象，只要传进来的参数是对象，我们就认为是合法的</li><li>当传入 null 也即 <code>Object.create(null)</code> 的时候，我们实际上创建了一个很纯粹的空对象，这个对象的原型直接就是 null，<code>Object.prototype</code> 甚至没有出现在该对象的原型链中，这意味这个对象不会继承 Object 的任何方法。</li></ul><p>此外，你还可能在其他地方看到类似下面这样的实现：</p><p>具体实现如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">Object<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">proto<span class="token punctuation">,</span>propertiesObject</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> proto <span class="token operator">!=</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> proto <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'the first param must be an object or null'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>propertiesObject <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token string">'TypeError'</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 处理传参 null 的情况</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>proto <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> proto
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>propertiesObject<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>propertiesObject<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> obj
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个实现和前面的实现有一个很关键的区别：代码中单独处理了传参 <code>proto</code> 为 <code>null</code> 的情况。可能你会觉得很奇怪：当 <code>proto</code> 为 <code>null</code> 的时候，<code>F.prototype = proto</code> 的效果和 <code>obj.__proto__ = proto</code> 应该是一样的，为什么还要在这种情况下执行一遍 <code>obj.__proto__ = proto</code> 呢？这似乎说明，用 null 重写 F 的原型后，新创建的实例的 <code>__proto__</code> 并不是 null —— 事实上确实不是。</p><p>关于调用构造函数时会执行的操作，<a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-13.2.2">规范</a>明确提到了这一点：</p><blockquote><p>If <a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-8">Type</a>(<em>proto</em>) is not Object, set the [[Prototype]] internal property of <em>obj</em> to the standard built-in Object prototype object as described in <a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-15.2.4">15.2.4</a>.</p></blockquote><p>由于我们这里是通过 new 构造函数的方式创建新对象（而不是像之前那样通过对象字面量的形式），所以在 new F 的时候，内部会检测 F 的原型是不是对象，如果不是对象，那么会把实例的 <code>__proto__</code> 链接到内建的 <code>Object.prototype</code>。因此，这里新创建的实例的 <code>__proto__</code> 还真不是 null。</p><p>但根据 <code>Object.create</code> 的实现规范，这里必须让实例的 <code>__proto__</code> 指向 null，所以才需要执行 <code>obj.__proto__ = proto</code> 去手动设置对象原型。</p><p>当然，如果我们像第一个实现那样，直接去设置对象的 <code>__proto__</code>，而不是采用构造函数的方式，就不存在这个问题了。</p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2021/05/26/F-JS%E5%8E%9F%E7%94%9F%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%20new%EF%BC%9F/" rel="prev" title="JS 原生方法原理探究（三）：如何实现 new 操作符？"><i class="fa fa-angle-double-left"></i>&nbspJS 原生方法原理探究（三）：如何实现 new 操作符？</a></div><div class="post-nav-next"><a href="/2021/05/25/F-%E4%BD%A0%E7%9A%84%E6%89%8B%E5%86%99new%E5%AE%9E%E7%8E%B0%E8%B6%B3%E5%A4%9F%E4%B8%A5%E8%B0%A8%E5%90%97%EF%BC%9F/" rel="next" title="你的手写 new 实现足够严谨吗？">你的手写 new 实现足够严谨吗？&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E7%AE%80%E4%BB%8B"><span class="toc-text">语法简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#es-%E8%A7%84%E8%8C%83"><span class="toc-text">ES 规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">代码实现</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->