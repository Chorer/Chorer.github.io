<!-- build time:Sun Sep 05 2021 18:44:30 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">ES6的Set与Map</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2020-03-06&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp2.8k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp11 mins&nbsp&nbsp&nbsp</span><div class="post-tags"><i class="fa fa-tags"></i> <a href="/tags/ES6/">ES6</a></div></div><div class="post-content"><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/ES6%E7%9A%84Set%E4%B8%8EMap/ES6%E7%9A%84Set%E4%B8%8EMap-0.jpg"></div><span id="more"></span><h3 id="为什么要有-set-和-map">为什么要有 Set 和 Map ？</h3><p>有了对象，为什么还需要 Set 集合与 Map 映射呢？因为使用对象有时候会带来一些问题：</p><p>1）比如执行 <code>if(obj.num)</code> ，预期行为是只要存在 <code>num</code> 就能通过 if 判断，但如果 <code>obj.num = 0</code>，那么也无法继续执行，即使此时 <code>num</code> 确实是存在的。</p><p>2）另外，如果使用对象，那么 key 必须是 Symbol 或者字符串，非字符串类型的 key 也会通过 <code>toString()</code>被转换成字符串，这意味着 <code>obj[5]</code> 与 <code>obj['5']</code> 没有区别，尽管我们本意是想创建两个不同的 key；甚至，当key 是对象的时候，不管我们操作的是 <code>obj[&#123;a:1&#125;]</code> 还是 <code>obj[&#123;b:2&#125;]</code>，实际操作的都是 <code>obj['[object Object]']</code>，这是因为对象会被转换成字符串 <code>'[object Object]'</code>，这些都是与我们的预期不符合的。</p><p>因此，ES6 新增了 Set 和 Map。</p><h3 id="set">Set</h3><p>Set 是一个不包含重复元素的集合，元素可以是任意数据类型</p><h4 id="创建">1）创建</h4><p>调用 <code>new Set()</code> 可以创建一个空的 Set 集合，之后通过 <code>add()</code> 添加元素</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">)</span>
set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'two'</span><span class="token punctuation">)</span>
set<span class="token punctuation">.</span>size    <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>另外，也可以在创建 Set 集合的时候进行初始化。只需要传入一个可迭代对象 —— 比如数组，数组中包含 Set 集合的元素</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
set<span class="token punctuation">.</span>size  <span class="token comment">// 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="如何确保元素不重复零值相等算法">2）如何确保元素不重复：零值相等算法</h4><p>Set 中不能包含重复的元素，这点是怎么做到的呢？实际上，每次添加元素的时候，都会调用 “零值相等算法” 判断新增元素是否和已有元素重复，若不重复则可以加入。</p><p>“零值相等算法” 和 <code>Object.is()</code> 所使用的 “同值相等算法” 很像，所以它认为 <code>'5'</code> 和 <code>5</code> 不相等，<code>&#123;&#125;</code> 和 <code>&#123;&#125;</code> 不相等（引用不同），<code>NaN</code> 和 <code>NaN</code> 相等 …… 唯一的区别是，<strong>它认为 +0 和 -0 是相等的</strong>，这意味着一个 Set 无法同时存在 +0 和 -0。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>   <span class="token comment">// Set&#123;'5',5&#125;</span>

set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>   <span class="token comment">// Set&#123;'5',5,&#123;...&#125;,&#123;...&#125;&#125; </span>

set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">;</span> set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>   <span class="token comment">// Set&#123;'5',5,&#123;...&#125;,&#123;...&#125;,NaN&#125; </span>

set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>   <span class="token comment">// Set&#123;'5',5,&#123;...&#125;,&#123;...&#125;,NaN,+0&#125; </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="相关操作">3）相关操作</h4><p>可以用 <code>size</code> 获取 Set 的元素个数，用 <code>has()</code> 检测是否存在某个元素，用 <code>delete()</code> 移除指定元素，用 <code>clear()</code> 清空整个 Set 集合。</p><p>因为初始化 Set 的时候可以传入一个数组，而对 Set 使用 <code>...</code> 展开运算符，又可以将其转化为数组，所以 Set 和数组是可以互相转化的。这有什么用呢？由于 Set 不能包含重复元素，所以其实可以利用这一点来实现数组去重：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> _arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_arr<span class="token punctuation">)</span>     <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>但仍然需要注意的是，由于 Set 采用的是零值相等算法，所以如果数组中有 +0 和 -0，即使这是两个不同的数字，也会被认为是同一个，去重后只剩下 0。</p><h4 id="迭代">4）迭代</h4><p>Set 并没有 key，无法像数组、对象或者 Map 那样通过指定 key 访问对应的 value。要访问 Set 的元素，只能一个一个迭代。迭代的方式主要有 <code>forEach</code> 和 <code>for……of</code>。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 方式一</span>
set<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token comment">// 方式二</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> set<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 方式三</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> <span class="token keyword">set</span><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 方式四</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> set<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 方式五</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> set<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 方式六</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> set<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然可以遍历出 key，但这里的 key 其实是 value。</p><h3 id="weakset">WeakSet</h3><p>如果 Set 中的元素为对象，那么这个对象使用的是强引用，即使在 Set 外面通过 <code>obj = null</code> 释放了对象，由于 Set 内还有对该对象的强引用，也会导致该对象无法被回收。</p><p>而如果使用的是 WeakSet，那么集合中的元素为对象时，这个对象使用的是弱引用，它并不会妨碍垃圾回收机制 —— 只要在 WeakSet 外面释放了对象，那么对象就一定会被回收，因此不存在内存泄露的问题。</p><p>此外，WeakSet 还有一些特点：</p><ul><li>不可以存储原始值，否则报错</li><li>不可迭代，所以不能使用 <code>forEach()</code>，<code>clear()</code></li><li>不支持 <code>size</code> 属性</li><li>不暴露诸如 <code>keys()</code>，<code>values()</code> 等迭代器</li></ul><h4 id="应用场景">应用场景</h4><p>WeakSet 的一个应用场景是给 DOM 节点打上 tag，或者说进行分类。比如现在有一些按钮是禁用的，那么我们可以把它们集中归类到一个 Set 中：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> btns <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.button_disable'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> disabledBtns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>btns<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>但是，假如这些按钮节点一段时间后会从 DOM 树中移除，那么由于 Set 中还有它们的强引用，就会导致它们占用的内存没有被释放，出现内存泄露问题。</p><p>而如果改用 WeakSet，那么只要按钮 DOM 被移除，就不存在任何强引用了，它们的内存自然就会被释放，WeakSet 中保存的只是弱引用，不会妨碍 GC 机制。</p><h3 id="map">Map</h3><p>Map 是一个包含多组键值对的映射，并且键名和键值支持所有的数据类型。</p><h4 id="创建和读写">1）创建和读写</h4><p>调用 <code>new Map()</code> 可以创建一个空的 Map 映射，之后通过 <code>map.set(key,value)</code> 添加键值对，<code>map.get(key)</code> 访问指定键名的键值。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">// 写</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token string">'I am object'</span><span class="token punctuation">)</span>     <span class="token comment">//  Map 的键名可以是对象</span>

<span class="token comment">// 读</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>  <span class="token comment">// 'Jack'</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>     <span class="token comment">// 'I am object'</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'unexisted key'</span><span class="token punctuation">)</span>  <span class="token comment">// 访问不存在的键，返回 undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外，也可以在创建 Map 的时候进行初始化。只需要传入一个数组，传入的数组的每个元素也是一个数组，这些数组中存放着键值对：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span>  map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'Jack'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>   <span class="token comment">// 'Jack'</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>    <span class="token comment">// 12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="相关操作-1">2）相关操作</h4><p>除了 <code>get(key)</code> 和 <code>set(key,value)</code> 方法之外，Map 还有 <code>has(key)</code>，<code>delete(key)</code>，<code>clear()</code>，<code>size</code> （返回键值对对数）等方法和属性。</p><h4 id="迭代-1">3）迭代</h4><p>虽然 Map 有 key，但是不能像对象或者数组那样使用 <code>for……in</code> 迭代。通常的迭代方式是使用 <code>for……of</code> 和 <code>forEach</code>。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 遍历 key 和 value</span>
map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span>           <span class="token comment">// name Jack,age 12</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token comment">// 遍历 key 和 value</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> pair <span class="token keyword">of</span> map<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span>               <span class="token comment">// ['name','Jack'],['age',12]</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 遍历 key</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> map<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>                <span class="token comment">// name,age</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 遍历 value</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> map<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>              <span class="token comment">// 'Jack',12 </span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PS：<code>map.entries()</code> 等同于 <code>map[Symbol.iterator]()</code>，会返回 map 的迭代器。另外，直接 <code>for(let pair of map)</code> 也是可以的。</p><h3 id="weakmap">WeakMap</h3><p>类似的，Map 也有弱引用版本 —— WeakMap。WeakMap 最大的特点在于，它的<strong>键名必须是对象</strong>，且保存着对象的弱引用。也就是说，它不会妨碍垃圾回收机制回收该对象。</p><p>比如说下面这段代码：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
obj <span class="token operator">=</span> <span class="token keyword">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果使用的是 map，那么 map 内外各有一个关于 <code>obj</code> 的强引用，即使执行了 <code>obj = null</code> ，由于 map 内部仍然有对于 <code>obj</code> 的强引用，也会导致 <code>obj</code> 没有被回收；但是，如果使用的是 weakmap，那么执行了 <code>obj = null</code> 之后，<code>obj</code> 就被回收了（而且键值对也会被移除），因为 map 对于 <code>obj</code> 的引用是一个弱引用，不会妨碍垃圾回收机制的判定。</p><h4 id="应用场景-1">应用场景</h4><p><strong>（1）DOM 对象关联元数据</strong></p><p>有时候，我们确实需要用到 DOM 对象的引用去关联一些元数据，但是又不想后期费心地去释放这个对象的引用。那么这个时候使用 WeakMap 就非常合适了。比如下面这个例子：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>btn<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>disable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果使用的是 map，那么当我们手动移除按钮 DOM 节点的时候，还得回过头来把 map 中对于 <code>btn</code> 的强引用也删除，否则无法真的释放 DOM 节点的内存；但是如果使用的是 weakmap，那么只要手动移除 DOM 节点就够了，weakmap 中对于 <code>btn</code> 的引用根本不需要去管它，因为它是一个弱引用，不会妨碍垃圾回收的判定。</p><p><strong>（2）实现私有变量</strong></p><p>此外，WeakMap 也可以用来实现实例的私有变量。这里的私有变量应该具备两个特点：</p><ul><li>无法从外部直接访问和修改，只能通过暴露的方法进行访问</li><li>一旦实例销毁，则它的私有变量也一并销毁，从而确保信息的私有性</li></ul><p>实现的代码如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> Person <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> privateData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>age</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        privateData<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>name<span class="token operator">:</span>name<span class="token punctuation">,</span>age<span class="token operator">:</span>age<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> privateData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getAge</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> privateData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>age
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> Person
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'Jack'</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 'Jack'</span>
p<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 12 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的这段代码中，我们用一个 WeakMap 维护多个映射关系，其中，key 为实例，value 为该实例的私有变量。每次创建新实例的时候，都会往 WeakMap 中添加新的“映射条目”。</p><p>1）由于我们使用的是 WeakMap，所以只要在外围移除实例的强引用，就一定可以确保实例被回收，同时，与之关联的私有变量也会被销毁。</p><p>2）WeakMap 和 Person 构造函数一起被封装到了一个闭包函数中，因此我们无法在外面通过 WeakMap 直接访问它保存的私有变量，只有通过内部暴露出来的 <code>getName</code> 和 <code>getAge</code> 方法，才能访问私有变量。</p><p>此外，WeakMap 还有一些特点：</p><ul><li>不支持 <code>size</code> 属性</li><li>不支持迭代 —— 由于弱引用的 key-value 随时会被销毁，所以没有必要提供可以迭代的能力</li><li>不支持 <code>forEach()</code> 和 <code>clear()</code> —— 因为不支持迭代，所以也不支持这两个方法</li></ul><h3 id="weakref">WeakRef</h3><p>WeakSet 中的元素和 WeakMap 中的 key 都保持着对象的弱引用， 那么有没有一种更加直接的方式可以创建某个对象的弱引用呢？那就是使用 WeakRef。</p><p><code>new WeakRef(obj)</code> 返回一个 WeakRef 实例对象，对象中包含对于传入 <code>obj</code> 的弱引用：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>a<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span>
<span class="token keyword">let</span> wr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>通过 <code>deref()</code> 方法，可以获取弱引用指向的实际对象（强引用）：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wr<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> obj<span class="token punctuation">)</span>      <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以为同一个对象创建多个弱引用，这些弱引用的行为保持一致，不会在调用 <code>deref()</code> 的时候有任何差异化表现：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> wr2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wr<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> wr2<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>应该尽量避免使用 WeakRef。因为不同浏览器引擎采用的 GC 机制不同，可能很复杂且不可预测，依赖于 GC 去清除 WeakRef 可能会导致意想不到的结果。</p></blockquote></div><div class="post-nav"><div class="post-nav-prev"><a href="/2020/03/08/F-%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8%20vue-awesome-swiper%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" rel="prev" title="在项目中使用 vue-awesome-swiper 遇到的问题"><i class="fa fa-angle-double-left"></i>&nbsp在项目中使用 vue-awesome-swiper 遇到的问题</a></div><div class="post-nav-next"><a href="/2020/02/14/F-Chrome%20%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E7%AE%80%E8%AE%B0/" rel="next" title="Chrome 调试技巧简记">Chrome 调试技巧简记&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89-set-%E5%92%8C-map"><span class="toc-text">为什么要有 Set 和 Map ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set"><span class="toc-text">Set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-text">1）创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E5%85%83%E7%B4%A0%E4%B8%8D%E9%87%8D%E5%A4%8D%E9%9B%B6%E5%80%BC%E7%9B%B8%E7%AD%89%E7%AE%97%E6%B3%95"><span class="toc-text">2）如何确保元素不重复：零值相等算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-text">3）相关操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3"><span class="toc-text">4）迭代</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weakset"><span class="toc-text">WeakSet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map"><span class="toc-text">Map</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E8%AF%BB%E5%86%99"><span class="toc-text">1）创建和读写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C-1"><span class="toc-text">2）相关操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3-1"><span class="toc-text">3）迭代</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weakmap"><span class="toc-text">WeakMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-text">应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weakref"><span class="toc-text">WeakRef</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->