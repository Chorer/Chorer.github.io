<!-- build time:Thu May 14 2020 09:02:09 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">ES6 参数默认值引起的中间作用域</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2019-05-24&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.6k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp5 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><p>ES6 参数默认值的问题，其实之前在<a href="https://chorer.github.io/2019/05/02/Trs-ES6%EF%BC%9A%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC/">这篇文章</a>中已经有涉及，之所以再谈起这个问题，是在阅读《ES6 标准入门》时产生的一个疑惑。阮老师的代码是：<br><a id="more"></a></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
   <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span>
x <span class="token comment" spellcheck="true">// 1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>怎么解释输出？</p><ul><li>首先需要明确的是，参数默认值确实会引起一个额外的参数作用域，不信看一下<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-functiondeclarationinstantiation" target="_blank" rel="noopener">标准</a>：<blockquote><p>If the function’s formal parameters do not include any default value initializers then the body declarations are instantiated in the same Environment Record as the parameters. If default value parameter initializers exist, a second Environment Record is created for the body declarations. Formal parameters and functions are initialized as part of FunctionDeclarationInstantiation. All other bindings are initialized during evaluation of the function body.</p></blockquote></li></ul><p>（注意这里的 default value parameter initializers exist，也就是说声明了默认参数值不一定会产生这个作用域，只有初始化了、确实用到了这个默认值，作用域才会产生。）</p><ul><li>第二个需要明确的地方是：上面代码中，存在全局作用域、参数作用域、函数作用域，并且这三者的关系如图：<br><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/ES6%20%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC%E5%BC%95%E8%B5%B7%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BD%9C%E7%94%A8%E5%9F%9F/ES6%20%E5%8F%82%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F-1.png" alt=""></li></ul><p>明确这两点之后开始来分析结果。实际上这段代码中存在着三个不同的 <code>x</code>，分别是全局的 <code>x</code>，参数作用域的 <code>x</code> 以及函数体内重新声明的 <code>x</code>。调用 <code>foo</code> 执行到 <code>y</code> 函数的时候，将值赋给 <code>x</code>，那么这是哪个 <code>x</code> 呢？对于 <code>y</code> 函数，<code>x</code> 不是在其体内声明的，所以这个 <code>x</code> 对它来说是自由变量，根据作用域链查找的规则，此时会查找到参数作用域中的 <code>x</code> ，并赋值为 2。之后打印 <code>x</code>，首先会在 <code>foo</code> 函数对应的变量对象中查找 <code>x</code> 的声明，确实 <code>foo</code> 函数里面有这个声明，所以就把它打印出来，为 3。后面在全局访问 <code>x</code> 时也同理，因为全局已经有这个 <code>x</code> 的声明，所以就把它打印出来，为 1。</p><p>事情到这里其实问题不大，直到后面遇到了两段代码，对于输出无法理解。</p><h3 id="其一"><a href="#其一" class="headerlink" title="其一"></a>其一</h3><p>先说第一个 snippet ：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> f1 <span class="token punctuation">(</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>  f <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> x<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>   
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token punctuation">}</span> 
 <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码会报错：Identifier ‘x’ has already been declared。如果在同一作用域中用 let 重复声明一个变量，则确实会报错，但是根据上面的分析，这里其实是不同的两个作用域，按道理说不应该报错。为什么会报错呢？首先从标准来回答这个问题：</p><blockquote><p>4.1.2 Static Semantics:Early Errors<br>It is a Syntax Error if any element of the BoundNames of <strong>FormalParameters</strong> also occurs in the LexicallyDeclaredNames of <strong>FunctionBody</strong></p></blockquote><p>意思是说，如果参数名和函数体内的变量名相同，将会报 Syntax Error，而且注意这是一个 Early Errors，也就是说，在解析阶段就会报错 ——— 由此看出，这里的参数 x 和函数体内 x 其实是一起解析的，并在解析时报错。那么为什么要这么设计呢？根据 @紫云飞 老师的说法，这其实是出于合理情况的考虑 —— 这里就应该报错。因为如果不报错，让开发者重复声明了一个变量，那么在函数体作用域内，实参将难以获取（事实上我们依然可以通过参数作用域里的函数返回这个实参，但这不是我们希望的访问方式）。因此这里的报错是一种合理的设计。<br>到这里，这个问题就算解释清楚了，接下来说第二个问题。</p><h3 id="其二"><a href="#其二" class="headerlink" title="其二"></a>其二</h3><p>这是第二个 snippet</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> f1 <span class="token punctuation">(</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>  f <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>   
  <span class="token keyword">var</span> x<span class="token punctuation">;</span>   
  <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>   
<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>奇怪，上面不是说重复声明会有 Syntax Error 吗？为何这里又不报错了？说实话，这个问题我暂时没有找到比较好的解释，只能说可能是由于上面的 Error 是针对 <code>let</code> 声明这种情况来说的，因为 ES5 中 <code>var</code> 的重复声明确实不会报错，在这里也一样不报错。那么回到问题，为什么这里会输出 2？先按照正常思路分析，执行 <code>f</code> 函数时，为 <code>x</code> 赋值 3，这个 <code>x</code> 按照之前的解释，应该是参数 <code>x</code> 而不是函数体内的 <code>x</code> 。所以，函数体的 <code>x</code> 依然是 <code>undefined</code>（只声明，没赋值），不过我们知道，结果打印的是 2，与预想相反。可以肯定的是，这里访问的一定是函数体的 <code>x</code>，那么它为何会有值 2 呢，难道它默认会有一个值吗？确实如此，我们再来看标准：</p><blockquote><p>NOTE vars whose names are the same as a formal parameter, initially have the same value as the corresponding initialized parameter.</p></blockquote><p>意思是说，与参数同名的 <code>var</code> 变量在初始的时候会具有一个与对应的参数相同的值。在这个例子中，函数体中的 x 的值将会和参数默认值一样，为 2。我们可以打下断点：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/ES6%20%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC%E5%BC%95%E8%B5%B7%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BD%9C%E7%94%A8%E5%9F%9F/ES6%20%E5%8F%82%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F-2.png" alt=""></p><p>那么这样设计的目的是什么呢？前面我们说过，我们期望的合理行为是：可以在函数体内成功访问到实参，或者更准确地说，访问到实参的值。虽然这里我们无法轻易访问到实参，但是通过设置同名变量的值与实参相同，达到了类似的期望效果。</p><p>到这里问题算是解决了。这次问题的解决主要从三个方面入手：自主搜索、平台提问、阅读规范。网上有很多文章讲到参数默认值，但是提及参数作用域的文章数量很有限，所以最后也基本是依靠知乎上两位老师的回答以及自己的琢磨得出了结论。对我来说，阅读规范的难度还是太大了，很难定位到重点，所以本篇文章极有可能有表述错误的地方，如果你在阅读之后有任何的想法，欢迎在底下评论区留言。</p><p>这里附上一些相关的文章链接：<br><a href="https://juejin.im/post/5c7350c7f265da2dde06f3aa" target="_blank" rel="noopener">https://juejin.im/post/5c7350c7f265da2dde06f3aa</a><br><a href="https://segmentfault.com/a/1190000007537913#articleHeader0" target="_blank" rel="noopener">https://segmentfault.com/a/1190000007537913#articleHeader0</a><br><a href="https://segmentfault.com/q/1010000015237136/a-1020000015242350" target="_blank" rel="noopener">https://segmentfault.com/q/1010000015237136/a-1020000015242350</a><br><a href="https://code.wileam.com/default-value-n-params-env/" target="_blank" rel="noopener">https://code.wileam.com/default-value-n-params-env/</a></p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2019/05/25/F-CSS%20%E5%9F%BA%E7%A1%80%E7%B3%BB%E5%88%97%EF%BC%9A%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E5%B1%85%E4%B8%AD%E6%96%B9%E6%A1%88/" rel="prev" title="CSS 基础系列：水平垂直居中方案"><i class="fa fa-angle-double-left"></i>&nbspCSS 基础系列：水平垂直居中方案</a></div><div class="post-nav-next"><a href="/2019/05/23/Trs-%E5%88%A9%E7%94%A8JavaScript%E5%A4%8D%E5%88%B6%E6%96%87%E6%9C%AC%E5%88%B0%E5%89%AA%E8%B4%B4%E6%9D%BF/" rel="next" title="「译」利用 JavaScript 复制文本到剪贴板">「译」利用 JavaScript 复制文本到剪贴板&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#其一"><span class="toc-text">其一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其二"><span class="toc-text">其二</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2020</span> My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->