<!-- build time:Mon Jan 03 2022 16:31:27 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">你的手写 new 实现足够严谨吗？</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2021-05-25&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.5k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp5 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><span id="more"></span><p>在开始阅读这篇文章之前，你可以对比下面这两段代码的输出结果是否一致（假设 <code>myNew</code> 是你自己实现的 new 操作）：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">myNew</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果不一样，那么可能说明你的 <code>myNew</code> 方法和标准的 <code>new</code> 操作之间存在着些许出入，这篇文章也许能够让你的方法更加完善 / 严谨。</p><h4 id="从-objectcreate-说起"><a class="markdownIt-Anchor" href="#从-objectcreate-说起"></a> 从 <code>Object.create</code> 说起</h4><p>最近在刷一些手写实现原生方法的面试题，偶然看到了有一个 <code>Object.create()</code> 方法的实现是这么写的：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">Object<span class="token punctuation">.</span><span class="token function-variable function">myCreate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">proto<span class="token punctuation">,</span> propertyObject <span class="token operator">=</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>propertyObject <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 这里没有判断propertyObject是否是原始包装对象</span>
    <span class="token keyword">throw</span> <span class="token string">'TypeError'</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function">Fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propertyObject <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> propertyObject<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 创建一个没有原型对象的对象，Object.create(null)</span>
      obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> obj
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而这个方法在<a target="_blank" rel="noopener" href="http://es5.github.io/#x15.2.3.5">规范</a>里的实现是这样的：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/2.jpg" alt=""></p><p>简单地说，它会接受两个参数，第一个参数作为调用后返回对象的 <code>__proto__</code>，第二个参数负责配置该对象的相关属性。而<strong>这里的第一个参数，可以是对象也可以是 <code>null</code></strong>。</p><p>基本上，上面代码的实现没有什么问题，但是我突然产生了一个疑问：当第一个参数是 <code>null</code> 的时候，<code>Fn.prototype = proto</code> 已经把构造函数的原型对象设置为 <code>null</code>了，为什么后面还要在判断第一个参数为 <code>null</code> 之后设置 <code>obj.__proto__ = null</code> 呢？这两个语句的作用难道不是一样的吗？毕竟 <code>Fn.prototype</code> 和 <code>obj.__proto__</code> 都是指向同一个原型对象呀！</p><p>于是我将代码中的 <code>if (proto === null)</code> 判断去掉，并分别测试了 <code>Object.create()</code> 方法和 <code>Object.myCreate()</code> 方法：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/3.jpg" alt=""></p><p>可以看到，第二个打印是符合预期的，返回对象的 <code>__proto__</code>确实指向传入的参数 <code>null</code>；但第一个打印却和预想的不一样，展开打印对象后会发现，它其实是 <code>Object.prototype</code>。这是怎么回事呢？难道说代码中执行 <code>Fn.prototype = proto</code> 的时候，实际上实例的 <code>__proto__</code> 并没有跟着改变？</p><p>于是继续测试：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/4.jpg" alt=""></p><p>这里可以看到：用 <code>null</code> 重写构造函数的原型后，通过 new 构造函数创建的实例的 <code>__proto__</code> 并没有跟着变成 <code>null</code>，而是指向了 <code>Object.prototype</code>。</p><h4 id="调用构造函数的时候做了什么"><a class="markdownIt-Anchor" href="#调用构造函数的时候做了什么"></a> 调用构造函数的时候做了什么？</h4><p>这时候，我们可能会想到，通过 new 调用构造函数的时候，内部可能做了一些处理，导致最终返回的实例对象的 <code>__proto__</code> 和我们预期的不一致。既然如此，我们通过<a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-13.2.2">规范</a>看一下调用构造函数的时候，具体做了什么事：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/5.jpg" alt=""></p><p>这里我们只需要关注第六步和第七步。这两步会检查构造函数的原型对象的类型，如果是一个对象，则会将其作为实例的 <code>__proto__</code>；如果不是对象，则会将 <code>Object.prototype</code> 作为实例的 <code>__proto__</code>。这就能解释为什么用 <code>null</code> 重写构造函数的原型后，实例的 <code>__proto__</code> 没有跟着改变了，因为在调用构造函数的过程中，它链接上了 <code>Object.prototype</code>，可以说，这里实例的原型链并没有断开。</p><h4 id="实现一个更严谨的-new"><a class="markdownIt-Anchor" href="#实现一个更严谨的-new"></a> 实现一个更严谨的 <code>new</code></h4><p>在大部分的手写 <code>new</code> 实现中，通常都没有去检查构造函数的原型是否是一个对象。有的实现中甚至直接使用了 <code>Object.create()</code> 方法以快速地建立原型关系，就像这样：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">myNew</span><span class="token punctuation">(</span><span class="token parameter">Fn<span class="token punctuation">,</span><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Fn <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>Fn <span class="token operator">+</span> <span class="token string">'is not a constructor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>    
    <span class="token keyword">const</span> returnValue <span class="token operator">=</span> <span class="token function">Fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> returnValue <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> returnValue <span class="token operator">:</span> instance
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里直接使用<code>Object.create()</code> 方法，是有问题的。</p><p>在前面阅读规范的时候我们已经知道了，即使传给 <code>Object.create</code> 的参数是 <code>null</code>，也会将其作为创建的对象的 <code>__proto__</code>，所以这里如果使用了 <code>Object.create</code>，并且构造函数的原型 <code>Fn.prototype</code> 还恰好就是 <code>null</code> 的话，就会导致实例的 <code>__proto__</code> 也是 <code>null</code>，这和 <code>new</code> 的实际实现是有出入的。</p><p>所以，如果想实现一个更加严谨的 <code>new</code>，那么就不应该在内部去调用 <code>Object.create</code> 方法，而应该选择手动创建一个对象并和构造函数建立原型关系，同时，我们还应该加入对构造函数原型的类型判断，看它到底是不是一个对象。</p><p>因此，上面的代码可以修改如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">myNew</span><span class="token punctuation">(</span><span class="token parameter">Fn<span class="token punctuation">,</span><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Fn <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>Fn <span class="token operator">+</span> <span class="token string">'is not a constructor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token comment">// 检测构造函数原型是不是对象</span>
    instance<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">:</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype 
    <span class="token keyword">const</span> returnValue <span class="token operator">=</span> <span class="token function">Fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> returnValue <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> returnValue <span class="token operator">:</span> instance
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在，我们再用这个改进之后的 <code>new</code> 去测试文章开头的代码：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/6.jpg" alt=""></p><p>可以看到，加入了对构造函数原型可能为 <code>null</code> 的处理之后，返回的实例的 <code>__proto__</code> 明确指向了 <code>Object.prototype</code>。现在我们实现的 <code>new</code> 就更加严谨了，而且也更接近原生的 <code>new</code> 操作。</p><p>本文到这里就结束了。不过，从语言设计的角度来说，为什么不将实例的 <code>__proto__</code> 也跟着设置为 <code>null</code> 呢？这里不断开实例的原型链，而是将其链接到 <code>Object.prototype</code> 有什么好处？大家可以在评论区留言讨论一下。另外，不排除本文存在原理性的错误或者说法上的偏颇，如果你发现了，也欢迎在评论区指正。</p><h4 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h4><p><a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-13.2.2">https://262.ecma-international.org/5.1/#sec-13.2.2</a></p><p><a target="_blank" rel="noopener" href="http://es5.github.io/#x15.2.3.5">http://es5.github.io/#x15.2.3.5</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18198178/null-prototype-object-prototype-and-object-create">https://stackoverflow.com/questions/18198178/null-prototype-object-prototype-and-object-create</a></p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2021/05/26/F-JS%E5%8E%9F%E7%94%9F%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%20Object.create()%EF%BC%9F/" rel="prev" title="JS 原生方法原理探究（二）：如何实现 Object.create？"><i class="fa fa-angle-double-left"></i>&nbspJS 原生方法原理探究（二）：如何实现 Object.create？</a></div><div class="post-nav-next"><a href="/2021/05/21/F-JS%E5%8E%9F%E7%94%9F%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0call%E3%80%81apply%20%E5%92%8C%20bind%EF%BC%9F/" rel="next" title="JS 原生方法原理探究（一）：如何实现 call、apply 和 bind？">JS 原生方法原理探究（一）：如何实现 call、apply 和 bind？&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-objectcreate-%E8%AF%B4%E8%B5%B7"><span class="toc-text">从 Object.create 说起</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%97%B6%E5%80%99%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-text">调用构造函数的时候做了什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9B%B4%E4%B8%A5%E8%B0%A8%E7%9A%84-new"><span class="toc-text">实现一个更严谨的 new</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=(t.substring(0,n),document.URL),s=new Date,l=document.getElementsByClassName("vnick vinput")[0].value||"Anonymous",i=(document.getElementsByClassName("vmail vinput")[0].value,document.getElementsByClassName("vlink vinput")[0].value,document.getElementsByClassName("veditor vinput")[0].value),o=e+"文章："+a+"\n\n昵称："+l+"\n\n留言："+i+"\n\n时间："+s.toLocaleString(),v=new XMLHttpRequest;v.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),v.setRequestHeader("Content-type","application/x-www-form-urlencoded"),v.send(title1+"&"+o)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2022</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/prism.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:150,height:300,vOffset:-120,hOffset:-5},mobile:{show:!1},react:{opacityDefault:1e3,opacityOnHover:1e3},log:!1})</script></body></html><!-- rebuild by neat -->