<!-- build time:Sun Jan 15 2023 16:09:00 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">安卓7.0+系统抓包方案</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2022-05-19&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.9k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp6 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><span id="more"></span><blockquote><p>声明：本文所讲内容只用于学习相关技术，勿用于其它用途</p></blockquote><p>最近在帮人写一些自动签到的脚本，涉及到了在安卓7.0+系统中如何对 app 和微信小程序进行抓包的问题。这里记录一下有效的抓包方案。</p><p>众所周知，不管是用 httpCanary、Fiddler 还是其它工具对手机进行抓包，都需要在手机上安装这些工具提供的根证书。但安卓从7.0版本开始已经不再信任用户自己安装的证书 —— 你仍然可以安装，但证书不会起作用，典型表现就是在开启抓包工具的情况下，被抓包的 app 是处于断网状态的。那么如何解决这个问题呢？有下面的方案可供选择：</p><h4 id="root"><a class="markdownIt-Anchor" href="#root"></a> root</h4><p>究其根本，不能抓包是因为系统不信任用户证书，那么只要想办法将用户证书放到系统证书目录下，证书就可以被当作系统证书而得到信任了。但这个操作的前提是手机需要 root，这样才能操作系统证书目录。而 root 有一定的风险，所以 pass。</p><h4 id="虚拟空间-httpcanary"><a class="markdownIt-Anchor" href="#虚拟空间-httpcanary"></a> 虚拟空间 + httpCanary</h4><p>有很多 app 可以实现在手机中开辟虚拟空间。</p><p>（1）VMOS pro：可以在手机中开一个虚拟机，而这个虚拟机是很容易 root 的，对其 root 后将目标应用导入并安装证书，最后在真机中用 httpCanary 抓包即可。但实际下载 VMOS pro 之后，由于 rom 一直下不来，导致连应用都没进去，遂放弃。</p><p>（2）平行空间：可以在谷歌商店下载，它不支持导入 64 位应用，所以还得下载一个 64 bit support 补丁。平行空间应用的版本必须适配 httpCanary 的版本，否则还是无法抓包，而 httpCanary 虽然内置了对应版本的平行空间下载入口，但点击下载始终没有反应。最终，在我终于找到版本适配的 httpCanary 和平行空间，并且也成功进入目标应用之后，仍然还是遇到了抓包断网的问题，于是也只能放弃。</p><p>（3）VirturalXposed + justTrustMe：还是类似的应用，justTrustMe 模块的作用是禁止在虚拟空间中运行的 app 进行证书校验，所以自然也就不存在证书信任问题。但我将目标应用导入 VirturalXposed 之后，发现应用一打开就闪退，所以这个方法也不行，只能放弃。</p><h4 id="反编译"><a class="markdownIt-Anchor" href="#反编译"></a> 反编译</h4><p>对应用的 apk 文件进行反编译，修改其中的配置，让用户自己安装的证书被信任。由于我不是专业搞安卓的，同时这个方案要求第三方的开发者没有采取防止反编译的措施，所以 pass。</p><h4 id="安卓模拟器-fiddler"><a class="markdownIt-Anchor" href="#安卓模拟器-fiddler"></a> 安卓模拟器 + Fiddler</h4><p>没错，模拟器不仅能用来打游戏，也能用来抓包，而且这个方案出奇奏效。</p><p>还是回到最开始的问题，我们需要的其实只是一台低版本的安卓机，或者高版本但是能操作系统证书目录的安卓机，这样就无需担心证书问题 —— 而模拟器刚好都能满足这两个条件。考虑到目标应用无法在低版本安卓中运行，所以我在模拟器中使用的版本是安卓7.0，因为在模拟器中操作证书目录非常简单，所以版本高低也不是问题，有没有 root 更不是问题。下面讲一下关键步骤。</p><p>1）下载夜神模拟器，将目标应用的 apk 文件拖入到模拟器中安装，确保可以正常打开</p><p>2）将 Fiddler 的根证书 FiddlerRoot.cer 导出（高版本安卓拒绝超过两年有效期的证书，为了以防万一，可以用 Fiddler CertMaker 生成新的证书导入到 Fiddler 中，再导出来）</p><p>3）下载 64 位的 openssl，并将 openssl 的 bin 目录配置为系统环境变量。接着命令行执行如下操作。</p><p>将 cer 证书转化为 pem 证书：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl x509 -inform DER -in C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Chor<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>FiddlerRoot.cer -out C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Chor<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>FiddlerRoot.pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>获取 pem 证书的哈希值：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl x509 -inform PEM -subject_hash_old -in C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Chor<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>FiddlerRoot.pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用哈希值重新命名 pem 证书：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ren C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Chor<span class="token punctuation">\</span>Desktop<span class="token punctuation">\</span>FiddlerRoot.pem abcdefgh.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4）将证书 <code>abcdefgh.0</code> 转移到目录 <code>C:\Users\Chor\Nox_share\ImageShare</code> 下，这样证书就位于模拟器中了。</p><p>5）使用模拟器自带的文件管理器，打开 <code>Pictures</code> 目录，将证书 <code>abcdefgh.0</code> 转移到系统证书目录 <code>system/etc/security/cacerts</code> 中。这样，这个证书就成为了一个被信任的系统证书。</p><p>6）现在这个证书还不是可读的，所以需要修改证书的读写权限。而文件系统本身也是只读的，所以还得先解除系统的只读状态。如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span>
<span class="token function">mount</span> -o remount,rw /system
<span class="token builtin class-name">cd</span> /system/etc/security/cacerts
<span class="token function">chmod</span> <span class="token number">777</span> abcdefgh.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这样，证书就有了最高读写权限，而且在系统设置中也可以看到这个证书。</p><p>7）电脑连接 wifi 或者手机热点，通过 <code>ipconfig</code> 获取 WLAN 的 IPv4 地址，同时 Fiddler 开放 8888 端口。此时，充当手机的模拟器和电脑位于同一网络，进入模拟器的网络设置界面，手动设置网络代理，将代理服务器地址设置为前面的 IPv4 地址，端口设置为 8888。这样，模拟器中收发的数据包就会经过 Fiddler 这个中间代理服务器。</p><p>8）所有准备工作都已经完成了，接下来在模拟器中打开目标应用，然后到 Fiddler 中愉快抓包吧~</p><h4 id="小程序如何抓包"><a class="markdownIt-Anchor" href="#小程序如何抓包"></a> 小程序如何抓包？</h4><p>前面介绍的都是对安卓 app 进行抓包，那么怎么对小程序抓包呢？这里提供三种方法：</p><p>（1）安卓模拟器 + Fiddler：</p><p>基本步骤和前面介绍的差不多。需要注意的是，我们的用户证书只是被系统信任了，还没有被微信信任 —— 微信 7.0+ 版本不会信任用户证书，它有自己的一个证书列表。如果要抓包，我们必须下载 7.0 以下的微信并导入到模拟器中，或者在模拟器中使用 7.0 以下的安卓系统，这样就可以无视微信版本。</p><p>（2）VirturalXposed + justTrustMe + 抓包工具：</p><p>基本步骤和前面介绍的差不多。虽然某些应用导入 VirturalXposed 之后无法打开，但微信不会，这个方法针对微信小程序是实测有效的。</p><p>（3）电脑端微信小程序 + Fiddler：</p><p>最简单的方法，不过最近小程序的架构升级了，所以在使用这个方法之前需要先进行额外的工作。打开任意一个小程序，在任务管理器中定位到微信小程序的进程，右键打开所在目录，然后跳转到 WMPFRuntime 文件夹。关闭微信，将整个 WMPFRuntime 文件夹删掉，然后重新打开微信并进入目标小程序，这时候发现 Fiddler 可以成功抓包了。</p><h4 id="微信公众号如何抓包"><a class="markdownIt-Anchor" href="#微信公众号如何抓包"></a> 微信公众号如何抓包？</h4><p>微信公众号的抓包只需要在 PC 端微信客户端操作即可，要点是必须使用微信内置浏览器打开公众号链接（其它浏览器无法打开公众号）。</p><p>参考文章：</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43278826/article/details/124291040">Android 7.0+模拟器Fiddler抓包详细教程</a></p></div><div class="post-nav"><div class="post-nav-prev"></div><div class="post-nav-next"><a href="/2022/01/03/To-%E5%A5%95%E8%BE%85%E5%AF%BC%E8%87%AA%E5%8A%A8%E6%89%93%E5%8D%A1%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0/" rel="next" title="奕辅导自动打卡脚本实现">奕辅导自动打卡脚本实现&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#root"><span class="toc-text">root</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E7%A9%BA%E9%97%B4-httpcanary"><span class="toc-text">虚拟空间 + httpCanary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="toc-text">反编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8-fiddler"><span class="toc-text">安卓模拟器 + Fiddler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%A6%82%E4%BD%95%E6%8A%93%E5%8C%85"><span class="toc-text">小程序如何抓包？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%A6%82%E4%BD%95%E6%8A%93%E5%8C%85"><span class="toc-text">微信公众号如何抓包？</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=(t.substring(0,n),document.URL),s=new Date,l=document.getElementsByClassName("vnick vinput")[0].value||"Anonymous",i=(document.getElementsByClassName("vmail vinput")[0].value,document.getElementsByClassName("vlink vinput")[0].value,document.getElementsByClassName("veditor vinput")[0].value),o=e+"文章："+a+"\n\n昵称："+l+"\n\n留言："+i+"\n\n时间："+s.toLocaleString(),v=new XMLHttpRequest;v.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),v.setRequestHeader("Content-type","application/x-www-form-urlencoded"),v.send(title1+"&"+o)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2023</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/prism.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:150,height:300,vOffset:-120,hOffset:-5},mobile:{show:!1},react:{opacityDefault:1e3,opacityOnHover:1e3},log:!1})</script></body></html><!-- rebuild by neat -->