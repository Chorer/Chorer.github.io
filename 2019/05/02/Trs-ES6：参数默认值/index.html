<!-- build time:Sun Nov 28 2021 10:22:28 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">「译」ES6：参数默认值的实现细节</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2019-05-02&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp2.6k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp10 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><blockquote><ul><li>原文地址：<a target="_blank" rel="noopener" href="http://dmitrysoshnikov.com/ecmascript/es6-notes-default-values-of-parameters/">ES6: Default values of parameters</a></li><li>原文作者：Dmitry Soshnikov</li><li>译者：Chor</li></ul></blockquote><span id="more"></span><p>在这篇文章中我们会介绍另一个 ES6 的特性，带<strong>默认值</strong>的函数参数。正如我们将看到的，有一些微妙的案例。</p><h2 id="es5-及更低版本的手动默认值">1.ES5 及更低版本的手动默认值</h2><p>以前的默认参数值是通过以下几种可选方式手动处理的：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> level</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  level <span class="token operator">=</span> level <span class="token operator">||</span> <span class="token string">'warning'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token string">': '</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'low memory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warning: low memory</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out of memory'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error: out of memory</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了避免参数未传递的情况，通常可以看到 <code>typeof</code> 检查：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> level <span class="token operator">==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  level <span class="token operator">=</span> <span class="token string">'warning'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>有时，你也可以检查 <code>arguments.length</code> :</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  level <span class="token operator">=</span> <span class="token string">'warning'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>所有这些方法都行之有效，但是，它们太偏向手动了，并且不够抽象。ES6 标准化了一种句法结构，在函数头直接定义了参数默认值。</p><h2 id="es6-默认值基本实例">2.ES6 默认值：基本实例</h2><p>许多语言都存在默认参数值，所以大多数开发人员应该熟悉它的基本形式：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> level <span class="token operator">=</span> <span class="token string">'warning'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token string">': '</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'low memory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warning: low memory</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out of memory'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error: out of memory</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种默认参数用法相当随意，但是却很方便。让我们深入实现细节来理清默认参数可能带来的困惑。</p><h2 id="实现细节">3.实现细节</h2><p>以下是一些关于 ES6 函数默认参数值的实现细节。</p><h3 id="执行阶段的重新计值">3.1 执行阶段的重新计值</h3><p>一些其他语言（例如 Python）会在<strong>定义阶段</strong>对默认参数进行一次计值，相比之下，ECMAScript 则会在<strong>执行阶段</strong>计算默认参数值 —— 每次函数调用的时候。采用这种设计是为了避免与作为默认值的复杂对象混淆。思考下面的 Python 例子：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">def <span class="token function">foo</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span>
  x<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> x
 
# 我们可以看到默认值在函数定义时
# 只创建了一次，并且保存于
# 函数对象的属性中
<span class="token function">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__defaults__<span class="token punctuation">)</span> # <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
 
# 正如我们所说的，原因是：
<span class="token function">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__defaults__<span class="token punctuation">)</span> # <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了避免这种情况，Python 开发者习惯将默认值定义为 <code>None</code>，并且显式检查这个值：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">def <span class="token function">foo</span><span class="token punctuation">(</span>x <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token keyword">if</span> x is None<span class="token operator">:</span>
    x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  x<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
 
<span class="token function">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__defaults__<span class="token punctuation">)</span> # <span class="token punctuation">(</span>None<span class="token punctuation">,</span><span class="token punctuation">)</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> # <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
 
<span class="token function">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>__defaults__<span class="token punctuation">)</span> # <span class="token punctuation">(</span><span class="token punctuation">[</span>None<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是，这与手动处理实际默认值的方式是一样不方便的，并且最初的案例让人感到疑惑。因此，为了避免这种情况，ECMAScript 会在每次函数执行时计算默认值：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  x<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1]</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1]</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一切都很好，很直观。接下来你会发现，如果我们不了解默认值的工作机制，ES 语义可能会让我们感到困惑。</p><h3 id="外部作用域的遮蔽">3.2 外部作用域的遮蔽</h3><p>思考下面的例子：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y <span class="token operator">=</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2，不是 1！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正如我们<strong>看到</strong>的，上面的例子输出的 <code>y</code> 是 <code>2</code> ，不是 <code>1</code> 。 原因是参数中的 <code>x</code> 与全局的 <code>x</code> <strong>不是同一个</strong>。由于执行阶段会计算默认值，在赋值 <code>= x</code> 发生的时候， <code>x</code> 已经在<strong>内部作用域</strong>被解析了，并且指向了 <strong><code>x</code> 参数自身</strong>。具有相同名称的参数 <code>x</code> <strong>遮蔽了</strong>全局变量，使得对来自默认值的 <code>x</code> 的所有访问都指向参数。</p><h3 id="参数的-tdz暂时性死区">3.3 参数的 TDZ（暂时性死区）</h3><p>ES6 提到了所谓的 <strong>TDZ</strong>（表示<strong>暂时性死区</strong>）—— 这是程序的一部分，在这个区域内变量或者参数在<strong>初始化</strong>（即接受一个值）之前将<strong>无法访问</strong>。</p><p>就参数而言，一个<strong>参数不能以自身作为默认值</strong>：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x <span class="token operator">=</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 抛出错误！</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们上面提到的赋值 <code>= x</code> 在参数作用域中解析 <code>x</code> ，遮蔽了全局 <code>x</code> 。 但是，参数 <code>x</code> 位于 TDZ 内，在初始化之前无法访问。因此，它无法初始化为自身。</p><p>注意，上面带有 <code>y</code> 的例子是有效的，因为 <code>x</code> 已经初始化（为隐式默认值 <code>undefined</code> ）了。我们再来看一下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y <span class="token operator">=</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 可行</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>之所以可行，是因为 ECMAScript 中的参数是按照<strong>从左到右的顺序</strong>初始化的，我们已经有可供使用的 <code>x</code> 了。</p><p>我们提到参数已经与“内部作用域”相关联了，在 ES5 中我们可以假定是<strong>函数体</strong>的作用域。但是，它实际上更加复杂：它<strong>可能</strong>是一个函数的作用域，<strong>或者</strong>是一个为了<strong>存储参数绑定</strong>而特别创建的<strong>中间作用域</strong>。我们来思考一下。</p><h3 id="特定的参数中间作用域">3.4 特定的参数中间作用域</h3><p>事实上，如果<strong>一些</strong>（至少有一个）参数具有默认值，ES6 会定义一个<strong>中间作用域</strong>用于存储参数，并且这个作用域与<strong>函数体</strong>的作用域<strong>不共享</strong>。这是与 ES5 存在主要区别的一个方面。我们用例子来证明：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `x` 被共用了吗？</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有，依然是 3，不是 2 </span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 并且外部的 `x` 也不受影响</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这个例子中，我们有<strong>三个作用域</strong>：全局环境，参数环境，以及函数环境：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token operator">:</span>  <span class="token punctuation">&#123;</span>x<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">&#125;</span> <span class="token comment">// 内部</span>
<span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>x<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token function-variable function">y</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 参数</span>
<span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span> <span class="token comment">// 全局</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>我们可以看到，当函数 <code>y</code> 执行时，它在最近的环境（即参数环境）中解析 <code>x</code> ，函数作用域对其并不可见。</p><h4 id="转译为-es5">3.4.1 转译为 ES5</h4><p>如果我们要将 ES6 代码编译为 ES5，并看看这个中间作用域是怎样的，我们会得到下面的结果：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// ES6</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `x` 被共用了吗？</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有，依然是 3，不是 2</span>
<span class="token punctuation">&#125;</span>
 
<span class="token comment">// 编译为 ES5</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 设置默认值。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> y <span class="token operator">==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 现在可以清楚地看到，它更新了参数 `x`</span>
  <span class="token punctuation">&#125;</span>
 
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 现在可以清楚地看到，这个 `x` 来自内部作用域</span>
    <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="参数作用域的源由">3.4.2 参数作用域的源由</h4><p>但是，设置这个<strong>参数作用域</strong>的<strong>确切目的</strong>是什么？为什么我们不能像 ES5 那样与函数体共享参数？理由是：函数体中的同名变量<strong>不应该因为名字相同而影响到<a target="_blank" rel="noopener" href="http://dmitrysoshnikov.com/ecmascript/chapter-6-closures/">闭包</a>绑定中的捕获行为</strong>。</p><p>我们用下面的例子展示：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 捕获 `x`</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是 1，不是 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果我们在<strong>函数体</strong>的作用域中创建函数 <code>y</code>，它将会捕获内部的 <code>x</code> ,也即 <code>2</code>。但显而易见，它应该捕获的是外部的 <code>x</code>，也即 <code>1</code>(除非它被同名参数<strong>遮蔽</strong>)。</p><p>同时，我们无法在外部作用域中创建函数，这意味着我们无法从这样的函数中访问<strong>参数</strong>。我们可以这样做：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token function-variable function">z</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 可以看到 `x` 和 `y`</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2，不是 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="何时不会创建参数作用域">3.4.3 何时不会创建参数作用域</h4><p>上述的语义与默认值的<strong>手动实现</strong>是<strong>完全不同</strong>的：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> y <span class="token operator">==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `x` 被共用了吗？</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是的！ 2</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 外部的 `x` 依然不受影响</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在有一个有趣的事实：如果一个函数<strong>没有默认值</strong>，它就<strong>不会创建这个中间作用域</strong>，并且会与一个<strong>函数环境</strong>中的参数绑定<strong>共享</strong>，即<strong>以 ES5 模式运行</strong>。</p><p>为什么要这么复杂呢？为什么不总是创建参数作用域呢？这仅仅和优化有关吗？并非如此。确切地说，这是为了向下兼容 ES5：上述手动实现默认值的代码<strong>应该</strong>更新函数体中的 <code>x</code>（也就是参数自身，且位于相同作用域中）。</p><p>同时还要注意，那些重复声明只适用于 <code>var</code> 和函数。用 <code>let</code> 或者 <code>const</code> 重复声明参数是不行的：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x <span class="token operator">=</span> <span class="token number">5</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 错误</span>
  <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 错误</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="undefined-检查">3.5 <code>undefined</code> 检查</h3><p>还要注意另一个有趣的事实，是否应用默认值，取决于对参数初始值（其赋值发生在<a target="_blank" rel="noopener" href="http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/#entering-the-execution-context">一进入上下文</a>时）的检查结果是否为值 <code>undefined</code> 。我们来证明一下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined, 2</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 2</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined, 2</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通常，在编程语言中带默认值的参数在必需参数之后，但是，上述事实允许我们在 JavaScript 中使用如下结构：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, undefined</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2, 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="解构组件的默认值">3.6 解构组件的默认值</h3><p>涉及默认值的另一个地方是解构组件的默认值。本文不会涉及解构赋值的主题，不过我们会展示一些小例子。不管是在函数参数中使用解构，还是上述的使用简单默认值，处理默认值的方式都是一样的：即在需要的时候创建两个作用域。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span>x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined, 5</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 5</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尽管解构的默认值更加通用，不仅仅用于函数中：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> <span class="token punctuation">&#123;</span>x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="结论">4 结论</h2><p>希望这篇简短的笔记可以帮助解释 ES6 中默认值的细节。注意，在本文撰写的那一天（2014 年 8 月 21 日），默认值<strong>还没有得到真正的实现</strong>（它们都只是创建了一个与函数体共享的作用域），因为这个“第二作用域”是在最近才添加到标准草案里的。默认值一定会是一个很有用的特性，它将使我们的代码更加优雅和整洁。</p><blockquote><p>另外，你也可以在<a target="_blank" rel="noopener" href="https://juejin.im/post/5cd0eab95188251b984d8abe">掘金翻译计划</a>找到本篇译文。</p></blockquote></div><div class="post-nav"><div class="post-nav-prev"><a href="/2019/05/03/Trs-%E7%BF%BB%E8%AF%91%E6%9C%AF%E8%AF%AD%E8%A1%A8/" rel="prev" title="翻译术语表"><i class="fa fa-angle-double-left"></i>&nbsp翻译术语表</a></div><div class="post-nav-next"><a href="/2019/05/01/Trs-%E7%BF%BB%E8%AF%91%E4%B8%8E%E6%8E%92%E7%89%88%E8%A7%84%E8%8C%83/" rel="next" title="译文排版规范">译文排版规范&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#es5-%E5%8F%8A%E6%9B%B4%E4%BD%8E%E7%89%88%E6%9C%AC%E7%9A%84%E6%89%8B%E5%8A%A8%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-text">1.ES5 及更低版本的手动默认值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#es6-%E9%BB%98%E8%AE%A4%E5%80%BC%E5%9F%BA%E6%9C%AC%E5%AE%9E%E4%BE%8B"><span class="toc-text">2.ES6 默认值：基本实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-text">3.实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5%E7%9A%84%E9%87%8D%E6%96%B0%E8%AE%A1%E5%80%BC"><span class="toc-text">3.1 执行阶段的重新计值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E9%81%AE%E8%94%BD"><span class="toc-text">3.2 外部作用域的遮蔽</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E7%9A%84-tdz%E6%9A%82%E6%97%B6%E6%80%A7%E6%AD%BB%E5%8C%BA"><span class="toc-text">3.3 参数的 TDZ（暂时性死区）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E5%AE%9A%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%AD%E9%97%B4%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-text">3.4 特定的参数中间作用域</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E8%AF%91%E4%B8%BA-es5"><span class="toc-text">3.4.1 转译为 ES5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E6%BA%90%E7%94%B1"><span class="toc-text">3.4.2 参数作用域的源由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E4%BC%9A%E5%88%9B%E5%BB%BA%E5%8F%82%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-text">3.4.3 何时不会创建参数作用域</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined-%E6%A3%80%E6%9F%A5"><span class="toc-text">3.5 undefined 检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%84%E7%BB%84%E4%BB%B6%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-text">3.6 解构组件的默认值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-text">4 结论</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=t.substring(0,n),s=document.URL,l=new Date,i=document.getElementsByClassName("vnick vinput")[0].value,o=document.getElementsByClassName("vmail vinput")[0].value,v=document.getElementsByClassName("vlink vinput")[0].value,m=document.getElementsByClassName("veditor vinput")[0].value,r=e+"|昵称：|邮箱：|网站地址：|当前页面：|评论内容：|跳转链接：|评论时间\n|----|----|----|----|\n|   "+i+"   |   "+o+"  |  "+v+"|   "+a+"| "+m+"| "+s+"|"+l.toLocaleString()+"|",u=new XMLHttpRequest;u.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.send(title1+"&"+r)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->