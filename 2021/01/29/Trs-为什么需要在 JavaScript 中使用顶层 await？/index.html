<!-- build time:Sat Jul 10 2021 15:08:28 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">为什么需要在 JavaScript 中使用顶层 await？</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2021-01-29&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp2.5k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp9 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><blockquote><ul><li>原文地址：<a href="https://blog.bitsrc.io/why-should-you-use-top-level-await-in-javascript-a3ba8139ef23" target="_blank" rel="noopener">Why Should You Use Top-level Await in JavaScript?</a></li><li>原文作者：<a href="https://medium.com/@mahdhirezvi?source=post_page-----a3ba8139ef23--------------------------------" target="_blank" rel="noopener">Mahdhi Rezvi</a></li><li>译者：Chor</li></ul></blockquote><a id="more"></a><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%9C%A8%20JavaScript%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E9%A1%B6%E5%B1%82%20await%EF%BC%9F/0.png" alt=""></p><p>作为一门非常灵活和强大的语言，JavaScript 对现代 web 产生了深远的影响。它之所以能够在 web 开发中占据主导地位，其中一个主要原因就是频繁更新所带来的持续改进。</p><p>顶层 await（<code>top-level await</code>）是近年来提案中涉及的新特性。该特性可以让 ES 模块对外表现为一个 <code>async</code> 函数，允许 ES 模块去 <code>await</code> 数据并阻塞其它导入这些数据的模块。只有在数据确定并准备好的时候，导入数据的模块才可以执行相应的代码。</p><p>有关该特性的提案目前仍处于 stage 3 阶段，因此我们不能直接在生产环境中使用。但鉴于它将在不久的未来推出，提前了解一下还是大有好处的。</p><p>听起来一头雾水没关系，继续往下阅读，我会和你一起搞定这个新特性的。</p><h2 id="以前的写法，问题在哪里？"><a href="#以前的写法，问题在哪里？" class="headerlink" title="以前的写法，问题在哪里？"></a>以前的写法，问题在哪里？</h2><p>在引入顶层 await 之前，如果你试图在一个 <code>async</code> 函数外面使用 <code>await</code> 关键字，将会引起语法错误。为了避免这个问题，开发者通常会使用立即执行函数表达式（IIFE）</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤️'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//报错</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
 <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤️'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//❤️</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="然而这只是冰山一角"><a href="#然而这只是冰山一角" class="headerlink" title="然而这只是冰山一角"></a>然而这只是冰山一角</h3><p>在使用 ES6 模块化的时候，经常会遇到需要导入导出的场景。看看下面这个例子：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//------ library.js ------</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> sqrt <span class="token operator">=</span> Math<span class="token punctuation">.</span>sqrt<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">diagonal</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">square</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">square</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//------ middleware.js ------</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> square<span class="token punctuation">,</span> diagonal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./library.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> squareOutput<span class="token punctuation">;</span>
<span class="token keyword">let</span> diagonalOutput<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// IIFE</span>
 <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
     <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     squareOutput <span class="token operator">=</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     diagonalOutput <span class="token operator">=</span> <span class="token function">diagonal</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span>delayInms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤️'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayInms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>squareOutput<span class="token punctuation">,</span>diagonalOutput<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这个例子中，我们在<code>library.js</code> 和<code>middleware.js</code> 之间进行变量的导入导出 （文件名随意，这里不是重点）</p><p>如果仔细阅读，你会注意到有一个 <code>delay</code> 函数，它返回的 Promise 会在计时结束之后被 resolve。因为这是一个异步操作（在真实的业务场景中，这里可能会是一个 fetch 调用或者某个异步任务），我们在 <code>async</code> IIFE 中使用 <code>await</code> 以等待其执行结果。一旦 promise 被 resolve，我们会执行从 <code>library.js</code> 中导入的函数，并将计算得到的结果赋值给两个变量。这意味着，在 promise 被 resolve 之前，两个变量都会是 <code>undefined</code>。</p><p>在代码最后面，我们将计算得到的两个变量导出，供另一个模块使用。</p><p>下面这个模块负责导入并使用上述两个变量：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//------ main.js ------</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> squareOutput<span class="token punctuation">,</span> diagonalOutput <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middleware.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//169</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//13</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行上面代码，你会发现前两次打印得到的都是 <code>undefined</code>，后两次打印得到的是 169 和 13。为什么会这样呢？</p><p>这是因为，在 <code>async</code> 函数执行完毕之前，<code>main.js</code> 就已经访问了 <code>middleware.js</code> 导出的变量。记得吗？我们前面还有一个 promise 等待被 resolve 呢 ……</p><p>为了解决这个问题，我们需要想办法通知模块，让它在准备好访问变量的时候再将变量导入。</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>针对上述问题，有两个广泛使用的解决方案：</p><p><strong>1.导出一个 Promise 表示初始化</strong></p><p>你可以导出一个 IIFE 并依靠它确定可以访问导出结果的时机。<code>async</code> 关键字可以异步化一个方法，并相应<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="noopener">返回一个 promise</a>。因此，下面的代码中，<code>async</code> IIFE 会返回一个 promise。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//------ middleware.js ------</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> square<span class="token punctuation">,</span> diagonal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./library.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> squareOutput<span class="token punctuation">;</span>
<span class="token keyword">let</span> diagonalOutput<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//解决方案</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    squareOutput <span class="token operator">=</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    diagonalOutput <span class="token operator">=</span> <span class="token function">diagonal</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span>delayInms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤️'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayInms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>squareOutput<span class="token punctuation">,</span>diagonalOutput<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当你在 <code>main.js</code> 中访问导出结果的时候，你可以静待 <code>async</code> IIFE 被 resolve，之后再去访问变量。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//------ main.js ------</span>
<span class="token keyword">import</span> promise<span class="token punctuation">,</span> <span class="token punctuation">{</span> squareOutput<span class="token punctuation">,</span> diagonalOutput <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middleware.js'</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 169</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 13</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 169</span>

     <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 13</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尽管这个方案可以生效，但它也引入了新的问题：</p><ul><li>大家都必须将这种模式作为标准去遵循，而且必须要找到并等待合适的 promise；</li><li>倘若有另一个模块依赖 <code>main.js</code> 中的变量 <code>squareOutput</code> 和<code>diagonalOutput</code>，那么我们就需要再次书写类似的 IIFE promise 并导出，从而让另一个模块得以正确地访问变量。</li></ul><p>为了解决这两个新问题，第二个方案应运而生。</p><p><strong>2.用导出的变量去 resolve IIFE promise</strong></p><p>在这个方案中，我们不再像之前那样单独导出变量，而是将变量作为 <code>async</code> IIFE 的返回值返回。这样的话，<code>main.js</code> 只需简单地等待 promise 被 resolve，之后直接获取变量即可。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//------ middleware.js ------</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> square<span class="token punctuation">,</span> diagonal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./library.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> squareOutput<span class="token punctuation">;</span>
<span class="token keyword">let</span> diagonalOutput<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    squareOutput <span class="token operator">=</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    diagonalOutput <span class="token operator">=</span> <span class="token function">diagonal</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>squareOutput<span class="token punctuation">,</span>diagonalOutput<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span>delayInms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤️'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayInms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//------ main.js ------</span>

<span class="token keyword">import</span> promise <span class="token keyword">from</span> <span class="token string">'./middleware.js'</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span>squareOutput<span class="token punctuation">,</span>diagonalOutput<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 169</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 13</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 169</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 13</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但这个方案有其自身的复杂性存在。</p><p>根据提案的说法，“这种模式的不良影响在于，它要求对相关数据进行大规模重构以使用动态模式；同时，它将模块的大部分内容放在 <code>.then()</code> 的回调函数中，以使用动态导入。从静态分析、可测试性、工程学以及其它角度来讲，这种做法相比 ES2015 的模块化来说是一种显而易见的倒退”。</p><h2 id="顶层-Await-是如何解决上述问题的？"><a href="#顶层-Await-是如何解决上述问题的？" class="headerlink" title="顶层 Await 是如何解决上述问题的？"></a>顶层 Await 是如何解决上述问题的？</h2><p>顶层 <code>await</code> 允许我们让模块系统去处理 promise 之间的协调关系，从而让我们这边的工作变得异常简单。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//------ middleware.js ------</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> square<span class="token punctuation">,</span> diagonal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./library.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> squareOutput<span class="token punctuation">;</span>
<span class="token keyword">let</span> diagonalOutput<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//使用顶层 await </span>
<span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
squareOutput <span class="token operator">=</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
diagonalOutput <span class="token operator">=</span> <span class="token function">diagonal</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span>delayInms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤️'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delayInms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>squareOutput<span class="token punctuation">,</span>diagonalOutput<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//------ main.js ------</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> squareOutput<span class="token punctuation">,</span> diagonalOutput <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middleware.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 169</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 13</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'From Main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squareOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 169</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>diagonalOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 13</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>middleware.js</code> 中的 <code>await</code> promise 被 resolve 之前， <code>main.js</code> 中任意一条语句都不会执行。与之前提及的解决方案相比，这个方法要简洁得多。</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p><strong>必须注意的是，顶层 await 只在 ES 模块中生效。</strong>此外，你必须要显式声明模块之间的依赖关系，才能让顶层 await 像预期那样生效。提案仓库中的这段代码就很好地说明了这个问题：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// x.mjs</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"X1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"X2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// y.mjs</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// z.mjs</span>
<span class="token keyword">import</span> <span class="token string">"./x.mjs"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"./y.mjs"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//X1</span>
<span class="token comment" spellcheck="true">//Y</span>
<span class="token comment" spellcheck="true">//X2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码打印的顺序并不是预想中的 <code>X1,X2,Y</code>。这是因为 <code>x</code> 和 <code>y</code> 是独立的模块，互相之间没有依赖关系。</p><p>推荐你阅读一下 <a href="https://github.com/tc39/proposal-top-level-await#faq" target="_blank" rel="noopener">文档问答</a> ，这样会对这个顶层 await 这个新特性有更加全面的了解。</p><h2 id="试用"><a href="#试用" class="headerlink" title="试用"></a>试用</h2><h3 id="V8"><a href="#V8" class="headerlink" title="V8"></a>V8</h3><p>你可以按照<a href="https://github.com/tc39/proposal-top-level-await#implementations" target="_blank" rel="noopener">文档</a>所说的，尝试使用顶层 <code>await</code> 特性。</p><p>我使用的是 V8 的方法。找到你电脑上 Chrome 浏览器的安装位置，确保关闭浏览器的所有进程，打开命令行运行如下命令：</p><pre class="line-numbers language-cmd"><code class="language-cmd">chrome.exe --js-flags="--harmony-top-level-await"
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样，Chrome 重新打开后将开启对于顶层 await 特性的支持。</p><p>当然，你也可以在 Node 环境测试。阅读<a href="https://medium.com/@pprathameshmore/top-level-await-support-in-node-js-v14-3-0-8af4f4a4d478" target="_blank" rel="noopener">这个指南</a> 获取更多细节。</p><h3 id="ES-模块"><a href="#ES-模块" class="headerlink" title="ES 模块"></a>ES 模块</h3><p>确保在 <code>script</code> 标签中声明该属性：<code>type=&quot;module&quot;</code></p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./index.js<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><span class="token script language-javascript">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>需要注意的是，和普通脚本不一样，声明模块化之后的脚本会受到 CORS 策略的影响，因此你需要通过服务器打开该文件。</strong></p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>以下是<a href="https://github.com/tc39/proposal-top-level-await#use-cases" target="_blank" rel="noopener">提案</a>中讲到的相关用例：</p><h3 id="动态的依赖路径"><a href="#动态的依赖路径" class="headerlink" title="动态的依赖路径"></a>动态的依赖路径</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> strings <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/i18n/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>navigator<span class="token punctuation">.</span>language<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>允许模块使用运行时的值去计算得到依赖关系。这对生产/开发环境的区分以及国际化工作等非常有效。</p><h3 id="资源初始化"><a href="#资源初始化" class="headerlink" title="资源初始化"></a>资源初始化</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">dbConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这有助于把模块看作某种资源，同时可以在模块不存在的时候抛出错误。错误可以在下面介绍的后备方案中得到处理。</p><h3 id="依赖的后备方案"><a href="#依赖的后备方案" class="headerlink" title="依赖的后备方案"></a>依赖的后备方案</h3><p>下面的例子展示了如何用顶层 <code>await</code> 去加载带有后备方案的依赖。如果 CDN A 无法导入 jQuery，那么会尝试从 CDN B 中导入。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">let</span> jQuery<span class="token punctuation">;</span>  
<span class="token keyword">try</span> <span class="token punctuation">{</span>  
  jQuery <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'https://cdn-a.example.com/jQuery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>  
  jQuery <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'https://cdn-b.example.com/jQuery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="抨击"><a href="#抨击" class="headerlink" title="抨击"></a>抨击</h2><p>针对顶层 <code>await</code> 的特性，Rich Harris 提出了不少<a href="https://gist.github.com/Rich-Harris/0b6f317657f5167663b493c722647221" target="_blank" rel="noopener">抨击性的问题</a>：</p><ul><li>顶层 <code>await</code> 会阻塞代码的执行</li><li>顶层 <code>await</code> 会阻塞资源的获取</li><li>CommonJS 模块没有明确的互操作方案</li></ul><p>而 stage 3 的提案已经直接解决了这些问题：</p><ul><li>由于兄弟模块能够执行，所以不存在阻塞；</li><li>顶层 <code>await</code> 在模块图的执行阶段发挥作用，此时所有的资源都已经获取并链接了，因此不存在资源被阻塞的风险；</li><li>顶层<code>await</code> 只限于在 ES6 模块中使用，本身就不打算支持普通脚本或者 CommonJS 模块</li></ul><p>我强烈推荐各位读者阅读提案的 <a href="https://github.com/tc39/proposal-top-level-await#faq" target="_blank" rel="noopener">FAQ</a> 来加深对这个新特性的理解。</p><p>看到这里，想必你对这个酷炫的新特性已经有了一定的了解。是不是已经迫不及待要使用看看了呢？在评论区留言一起交流吧。</p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2021/02/09/F-30%20%E4%B8%AA%E6%A1%88%E4%BE%8B%E6%95%99%E4%BD%A0%E7%94%A8%E7%BA%AF%20CSS%20%E5%AE%9E%E7%8E%B0%E5%B8%B8%E8%A7%81%E7%9A%84%E5%87%A0%E4%BD%95%E5%9B%BE%E5%BD%A2/" rel="prev" title="30 个案例教你用纯 CSS 实现常见的几何图形"><i class="fa fa-angle-double-left"></i>&nbsp30 个案例教你用纯 CSS 实现常见的几何图形</a></div><div class="post-nav-next"><a href="/2021/01/08/T-Chor%20%E7%9A%842020%20%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" rel="next" title="Chor 的 2020 年终总结 | 再见，2020；你好，2021">Chor 的 2020 年终总结 | 再见，2020；你好，2021&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#以前的写法，问题在哪里？"><span class="toc-text">以前的写法，问题在哪里？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#然而这只是冰山一角"><span class="toc-text">然而这只是冰山一角</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#顶层-Await-是如何解决上述问题的？"><span class="toc-text">顶层 Await 是如何解决上述问题的？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#试用"><span class="toc-text">试用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#V8"><span class="toc-text">V8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES-模块"><span class="toc-text">ES 模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用场景"><span class="toc-text">应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动态的依赖路径"><span class="toc-text">动态的依赖路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源初始化"><span class="toc-text">资源初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖的后备方案"><span class="toc-text">依赖的后备方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抨击"><span class="toc-text">抨击</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->