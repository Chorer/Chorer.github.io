<!-- build time:Sun Nov 28 2021 17:39:52 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">记一次小程序开发的踩坑之旅</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2020-07-11&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp2.3k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp8 mins&nbsp&nbsp&nbsp</span><div class="post-tags"><i class="fa fa-tags"></i> <a href="/tags/小程序/">小程序</a></div></div><div class="post-content"><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85/0.png" alt=""></p><span id="more"></span><h3 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h3><p>最近跟着慕课网上的课程在做一个网易云音乐小程序，遇到了一个进度条回跳的 bug，这里记录一下踩坑和解决的过程。</p><p>具体情况见下图：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85/1.gif" alt=""></p><p>预期行为：在拖拽进度条之后，直接到达拖拽之后的位置</p><p>实际行为：在拖拽进度条之后，会首先回跳到拖拽之前的位置，然后再跳到拖拽之后的位置。</p><h3 id="模拟调试的-bug"><a class="markdownIt-Anchor" href="#模拟调试的-bug"></a> 模拟调试的 bug</h3><h4 id="代码逻辑"><a class="markdownIt-Anchor" href="#代码逻辑"></a> 代码逻辑</h4><p>无论如何，先来看一下代码的逻辑：</p><p>页面结构如下，左右两个 <code>text</code> 显示时间就不说了，主要是中间的进度条。这个进度条没有使用小程序原生提供的 slider 来做，而是采用 movable-area 和 movable-view 相结合的方式，movable-area 划出了一块可供滑动的区域，而 movable-view 则是中间可以拖拽的滑块。拖拽滑块的时候会有个 <code>x</code> 来记录拖拽距离，同时绑定 <code>onXChange</code> 事件监听 <code>x</code> 的变化，绑定 <code>onTouchEnd</code> 事件监听拖拽松手的动作。另外，下面还有一个 progress 组件，这个是用来显示进度的，已经播放的进度给个白色样式。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>time<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123;showtime.currentTime&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>control<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>movable-area</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>movable-area<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>movable-view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>movable-view<span class="token punctuation">"</span></span> <span class="token attr-name">direction</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span> 
      <span class="token attr-name">damping</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123;movableDist&#125;&#125;<span class="token punctuation">"</span></span>
      <span class="token attr-name">bindchange</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onXchange<span class="token punctuation">"</span></span> <span class="token attr-name">bindtouchend</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onTouchEnd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>movable-view</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>movable-area</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>progress</span> <span class="token attr-name">percent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#123;&#123;progress&#125;&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name">backgroundColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#969696<span class="token punctuation">"</span></span> <span class="token attr-name">activeColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#fff<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>progress</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>time<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123;showtime.totalTime&#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一旦确定 <code>x</code> 的变化来源于用户的拖拽，就在<code>onXChange</code> 里根据比例关系设置好进度。这里要注意的是，在用户拖拽没松手的时候先不进行 <code>setData</code> 渲染视图层的操作 —— 因为用户可能会频繁进行拖拽，我们要避免频繁的 <code>setData</code> 带来的性能损耗。所以，这里只是把数据保存下来，等待渲染。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">onXchange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>source <span class="token operator">==</span> <span class="token string">"touch"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        ratio <span class="token operator">=</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>x <span class="token operator">/</span> <span class="token punctuation">(</span>movableAreaWidth <span class="token operator">-</span> movableViewWidth<span class="token punctuation">)</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>progress <span class="token operator">=</span> ratio <span class="token operator">*</span> <span class="token number">100</span>    
        <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>movableDist <span class="token operator">=</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>x
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用户一旦松手，基本就可以确定他已经把滑块拖拽到了目标位置，这时候就进行正式的 <code>setData</code> 操作，同时调用 <code>seek</code> 方法让歌曲跳转到对应的位置去播放</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">onTouchEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      
    <span class="token keyword">let</span> toSec <span class="token operator">=</span> totalSec <span class="token operator">*</span> ratio
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        progress<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>progress<span class="token punctuation">,</span>
        movableDist<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>movableDist<span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'showtime.currentTime'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeFormat</span><span class="token punctuation">(</span>toSec<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>   
    backgroundAudioManager<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>toSec<span class="token punctuation">)</span>   
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目前来看，好像并没有什么问题。不过别忘了，我们还有一个 <code>onTimeUpdate</code> 在监听歌曲的播放：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">backgroundAudioManager<span class="token punctuation">.</span><span class="token function">onTimeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> currentTime <span class="token operator">=</span> backgroundAudioManager<span class="token punctuation">.</span>currentTime          
    <span class="token comment">// 获取当前激活时刻</span>
    <span class="token keyword">let</span> sec <span class="token operator">=</span> currentTime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 设置movableview进度</span>
    <span class="token keyword">let</span> movableDist <span class="token operator">=</span> <span class="token punctuation">(</span>movableAreaWidth <span class="token operator">-</span> movableViewWidth<span class="token punctuation">)</span> <span class="token operator">*</span> currentTime <span class="token operator">/</span> totalSec
    <span class="token comment">// 设置progress-bar进度</span>
    <span class="token keyword">let</span> progress <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> currentTime <span class="token operator">/</span> totalSec
    <span class="token comment">// 赋值</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>compareSec <span class="token operator">!=</span> sec<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            movableDist<span class="token punctuation">,</span>
            progress<span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">'showtime.currentTime'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeFormat</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        compareSec <span class="token operator">=</span> sec
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>歌曲播放 --&gt; 时间改变 --&gt; 带动进度条跟着走，这个函数就是用来实现该功能的。</p><h4 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h4><p>问题就在于：拖拽和歌曲播放是同时进行的，拖拽本身会修改进度条，歌曲播放所带来的时间改变也会修改进度条，如果拖拽松开的那一刻是歌曲播放带来的时间改变在修改进度条，那么进度条确实是会弹回到原先位置的。</p><p>解决的方案很简单，这里参考视频的做法。其实很像 OS 中的进程互斥（这么说不准确，但可以近似理解）问题，进度条就相当于是互斥资源，我们只要保证一个时间段内只有一个操作可以修改进度条就好了。具体做法是声明一个变量 <code>isMoving</code> 作为“锁”，在拖拽的时候置为 <code>true</code>，并限制此时 <code>onTimeUpdate</code> 无法修改数据；而在松手后置为 <code>false</code>，并调用 <code>seek</code> 跳转到音乐的某个播放位置 <code>A</code>。由于对 <code>onTimeUpdate</code> 来说，他获取的 <code>currentTime</code> 也是 <code>A</code> 位置对应的时间，这样就不会发生冲突了。</p><p>修改代码后再来看一下拖拽效果，发现确实没有回跳的 bug 了：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85/2.gif" alt=""></p><p>你以为事情就这么结束了吗？No~~</p><h3 id="真机调试的-bug"><a class="markdownIt-Anchor" href="#真机调试的-bug"></a> 真机调试的 bug</h3><p>在确定模拟调试没问题的情况下，我打开手机进行真机调试，诡异的是，这个 bug 再次出现了，并且机率几乎是 100%，这怎么能忍呢？于是继续想方法解决。</p><p>在前面说过，“调用 <code>seek</code> 跳转到音乐的某个播放位置 <code>A</code>，对于 <code>onTimeUpdate</code> 来说，他获取的 <code>currentTime</code> 也是 <code>A</code> 位置对应的时间。” 在真机调试的场景下并不是这样。</p><h4 id="延迟更新的问题"><a class="markdownIt-Anchor" href="#延迟更新的问题"></a> 延迟更新的问题</h4><p>我们假设一下，调用 <code>seek</code> 进行跳转后，<code>onTimeUpdate</code> 内部获取的 <code>currentTime</code> 不是当前时间，而仍然是跳转前的时间，也就是说它的时间没有更新过来，那么按照这个时间计算的数据最后渲染到进度条上，我们看到的就还会是拖拽之前的进度条，而在稍后，时间更新过来了，进度条再次跳回到拖拽之后的位置。如果真的是这样，或许就可以解释回跳的原因了。那么怎么验证呢？</p><p>我们可以在 <code>onTimeUpdate</code> 函数内部打印格式化的 <code>currentTime</code> 和 <code>progress</code> 的值，如果这两者保持在差不多的水平，那么可以认为它们是同步的，如果某个时刻出现了很大的差距，那么就说明 <code>currentTime</code> 没有及时进行更新（<code>progress</code> 是通过 <code>onXchange</code> 修改的，不会有问题）。</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'currentTime：'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeFormat</span><span class="token punctuation">(</span>backgroundAudioManager<span class="token punctuation">.</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'progress：'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>progress<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>打印结果见下图：</p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85/4.png" style="zoom:67%"><p>一开始没有拖拽，所以理所当然， <code>currentTime</code> 和 <code>progress</code> 保持在差不多的水平。然后，注意看红圈部分，红圈的时刻我往后拖拽了进度条，所以可以看到 <code>progress</code> 突然变大了，但是这时候的 <code>currentTime</code> 竟然没有跟着改变（仍然是一个很小的数）！这就验证了上面的假设了，因为 <code>currentTime</code> 没有及时更新，而它又影响着其它数据，所以导致进度条又跳回到之前的位置，而稍后 <code>currentTime</code> 更新了，所以时间又从 00:07 骤增到 02:11，此后才恢复正常。</p><p>不过，为什么在真机调试下就会有这个“延迟更新”的问题呢？一开始我还猜想这是因为 <code>seek</code> 是异步的，<code>onTimeUpdate</code> 抢先它执行了，但经过测试发现它其实是同步的。所以，或许是因为真机调试下有延迟？这个先不管了，现在我们先看一下怎么解决这个 bug。</p><h4 id="解决方案-2"><a class="markdownIt-Anchor" href="#解决方案-2"></a> 解决方案</h4><p>问题的根源在于，我们在 <code>onTimeUpdate</code> 中是拿 <code>currentTime</code> 作为标准去进行数据修改的，并且认定 <code>currentTime</code> 是正确的数据，但其实，由于延迟更新的问题，这个数据有时候是错误的。所以我们可以做一个判断，一旦发现数据是错误的（没更新过来），我们就改用 <code>progress</code> 作为标准去进行数据修改（<code>progress</code> 不会出错）</p><p>PS：为什么不统一以 <code>progress</code> 作为标准呢？因为在不拖拽的情况下，<code>progress</code> 是基于 <code>currentTime</code> 进行计算的，所以正常情况还是得用 <code>currentTime</code>）</p><p>如何判断数据是错误的呢？这里用了一个比较笨+不优雅的方法：在调用 <code>onTimeUpdate</code> 的时候，拿到实际的当前秒数以及基于 <code>progress</code> 计算的理想的当前秒数。经过测试发现，正常情况下这两者的偏差不会大于2，而在不正常的情况下（比如截图红圈部分），这两者相差会很大，彼此的差距大概就是我们拖动进度条前后的差距。</p><p>这样，我们就可以把代码改成：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">backgroundAudioManager<span class="token punctuation">.</span><span class="token function">onTimeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 不拖拽的时候才setData</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isMoving<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         
        <span class="token keyword">let</span> currentTime <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>backgroundAudioManager<span class="token punctuation">.</span>currentTime <span class="token operator">-</span> totalSec <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>progress<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'同步'</span><span class="token punctuation">)</span>
            currentTime <span class="token operator">=</span> backgroundAudioManager<span class="token punctuation">.</span>currentTime
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'不同步'</span><span class="token punctuation">)</span>
            currentTime <span class="token operator">=</span> totalSec <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>progress<span class="token operator">/</span><span class="token number">100</span>     
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 获取当前激活时刻</span>
        <span class="token keyword">let</span> sec <span class="token operator">=</span> currentTime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">// 设置movableview进度</span>
        <span class="token keyword">let</span> movableDist <span class="token operator">=</span> <span class="token punctuation">(</span>movableAreaWidth <span class="token operator">-</span> movableViewWidth<span class="token punctuation">)</span> <span class="token operator">*</span> currentTime <span class="token operator">/</span> totalSec
        <span class="token comment">// 设置progress-bar进度</span>
        <span class="token keyword">let</span> progress <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> currentTime <span class="token operator">/</span> totalSec
        <span class="token comment">// 赋值</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>compareSec <span class="token operator">!=</span> sec<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                movableDist<span class="token punctuation">,</span>
                progress<span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string">'showtime.currentTime'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeFormat</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            compareSec <span class="token operator">=</span> sec
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>理论上好像说得过去，实际效果如何呢？真机调试看一下：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85/5.gif" alt=""></p><p>因为我是录屏然后转成 GIF 的，帧数比较低，但是经过反复测试，确实没有进度条回跳的 bug 了。</p><p>到这里，bug 就算解决了。当然，可能还会有其它更好的解决方式，后续我会找个时间再看下能不能进行优化和改进，有思路的大佬也欢迎留言指点。小程序的坑着实不少，但是我觉得应该享受这种踩坑后又从坑里爬出来的感觉。最后要特别感谢群里的 @<strong>疯子</strong>大佬，多亏他的提醒，让我定位到问题的关键部位。</p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B9%8B%E6%97%85/6.png" style="zoom:67%"></div><div class="post-nav"><div class="post-nav-prev"><a href="/2020/07/19/F-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81/" rel="prev" title="微信小程序订阅消息推送"><i class="fa fa-angle-double-left"></i>&nbsp微信小程序订阅消息推送</a></div><div class="post-nav-next"><a href="/2020/07/04/Trs-%E8%B0%88%E4%B8%80%E8%B0%88JavaScript%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" rel="next" title="谈一谈JavaScript的内存模型">谈一谈JavaScript的内存模型&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E8%B0%83%E8%AF%95%E7%9A%84-bug"><span class="toc-text">模拟调试的 bug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91"><span class="toc-text">代码逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95%E7%9A%84-bug"><span class="toc-text">真机调试的 bug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%9B%B4%E6%96%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">延迟更新的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="toc-text">解决方案</span></a></li></ol></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=(t.substring(0,n),document.URL),s=new Date,l=document.getElementsByClassName("vnick vinput")[0].value||"Anonymous",i=(document.getElementsByClassName("vmail vinput")[0].value,document.getElementsByClassName("vlink vinput")[0].value,document.getElementsByClassName("veditor vinput")[0].value),o=e+"文章："+a+"\n\n昵称："+l+"\n\n留言："+i+"\n\n时间："+s.toLocaleString(),v=new XMLHttpRequest;v.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),v.setRequestHeader("Content-type","application/x-www-form-urlencoded"),v.send(title1+"&"+o)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/prism.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:150,height:300,vOffset:-120,hOffset:-5},mobile:{show:!1},react:{opacityDefault:1e3,opacityOnHover:1e3},log:!1})</script></body></html><!-- rebuild by neat -->