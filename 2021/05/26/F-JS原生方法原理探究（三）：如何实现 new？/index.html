<!-- build time:Sat Jan 01 2022 19:26:59 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">JS 原生方法原理探究（三）：如何实现 new 操作符？</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2021-05-26&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.3k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp5 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><span id="more"></span><p>这是JS 原生方法原理探究系列的第三篇文章。本文会介绍如何模拟实现 <code>new</code> 操作符。关于 <code>new</code> 的具体用法，MDN 已经描述得很清楚了，这里我们只做简单的介绍，具体的重点在于如何模拟实现。</p><h3 id="new-操作符的规范"><a class="markdownIt-Anchor" href="#new-操作符的规范"></a> new 操作符的规范</h3><blockquote><p>下面展示的所有规范都是 ES5 版本的，与现在最新的规范有些区别</p></blockquote><p>首先看一下根据<a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-11.2.2">规范</a>的描述， <code>new</code> 操作符做了什么事：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/7.jpg" alt=""></p><p>全是英文，不过没关系，我简单翻译一下：</p><p>我在使用 <code>new</code> 操作符的时候，后面跟着的构造函数可能带参数，也可能不带参数，如果不带参数的话，比如说 <code>new Fn()</code>，那么这里这个 <code>Fn</code> 就是一个 <code>NewExpression</code>；如果带参数，比如说 <code>new Fn(name,age)</code>，那么这里的 <code>Fn</code> 就是一个 <code>MemberExpression</code>。</p><p>这两种情况下使用 <code>new</code> 操作符所进行的操作有点点不同，这里拿带参数的情况说明一下：</p><ol><li>首先会对 <code>Fn</code> 这个 <code>MemberExpression</code> 求值，其结果是指向实际函数对象的一个引用，我们把这个引用作为 <code>ref</code></li><li>接着调用 <code>GetValue(ref)</code> 进行求值，得到实际的函数对象，把这个对象作为 <code>constructor</code></li><li>对 <code>Arguments</code> 也就是传进来的参数求值，得到一个参数列表，作为 <code>argList</code></li><li>如果 <code>constructor</code> 不是对象，则抛出类型错误</li><li>如果 <code>constructor</code> 没有实现内部的 <code>[[Constructor]]</code> 方法，也抛出类型错误</li><li>调用 <code>constructor</code> 的 <code>[[Constructor]]</code>方法，并将 <code>argList</code> 传入作为参数，返回调用结果</li></ol><p>从这些描述可以看出，更多的实现细节放在函数的 <code>[[Constructor]]</code> 方法里。那么这个方法具体是做什么用的呢？</p><h3 id="constructor-的规范"><a class="markdownIt-Anchor" href="#constructor-的规范"></a> <code>[[Constructor]]</code> 的规范</h3><p>在 JS 中，函数有两种调用方式，一种是正常调用，这将调用函数的内部方法 <code>[[Call]]</code>，还有一种是通过 new 调用，此时的函数作为一个构造函数，这将调用函数的另一个内部方法 <code>[[Consturct]]</code>。所以，要实现 <code>new</code> 操作的话，我们得先搞懂 <code>[[Construct]]</code> 内部方法做了什么事。</p><p>这里继续看<a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/">规范</a>是怎么说的：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E4%BD%A0%E7%9A%84%20new%20%E5%AE%9E%E7%8E%B0%E7%9C%9F%E7%9A%84%E6%98%AF%E5%AF%B9%E7%9A%84%E5%90%97%EF%BC%9F/5.jpg" alt=""></p><p>简单翻译一下：</p><p>当通过可能为空的参数列表调用函数 <code>F</code> 的内部方法 <code>[[Construct]]</code> 的时候，会执行如下步骤：</p><ol><li>让 <code>obj</code> 作为一个新创建的原生对象</li><li>按照规范指定的，为 <code>obj</code> 设置所有内部方法</li><li>将 <code>obj</code> 的内部属性 <code>[[Class]]</code> 设置为 <code>Object</code></li><li>传参 <code>prototype</code> 调用函数 <code>F</code> 的内部方法 <code>[[Get]]</code>，获取函数的原型对象，作为 <code>proto</code></li><li>如果 <code>proto</code> 是对象，则将 <code>obj</code> 的内部属性 <code>[[Prototype]]</code> 设置为 <code>proto</code></li><li>如果 <code>proto</code> 不是对象，则将 <code>obj</code> 的内部属性 <code>[[Prototype]]</code> 设置为标准内建的 <code>Object</code> 的原型对象</li><li>调用函数 <code>F</code> 的内部方法 <code>Call</code>， <code>obj</code> 作为调用时的 this 值，此前传给 <code>[[Construct]]</code> 的参数列表作为调用时的参数。将调用后得到的结果作为 <code>result</code></li><li>如果 <code>result</code> 是对象，则将其返回</li><li>否则，返回 <code>obj</code></li></ol><p>可以说，规范已经讲得很清楚了，简单地说，在 new 一个构造函数的时候，具体会做下面的事情：</p><ul><li>内部创建一个实例对象，并指定实例对象的原型：<ul><li>如果构造函数的原型是对象，则让实例的 <code>__proto__</code> 等于构造函数的 <code>prototype</code></li><li>如果构造函数的原型不是对象，则让实例的 <code>__proto__</code> 等于 <code>Object</code> 的 <code>prototype</code></li></ul></li><li>将实例对象绑定为构造函数中的 this，此前传递进来的参数作为参数，并执行一遍构造函数</li><li>如果构造函数返回了对象，则将其作为返回值，否则将实例对象作为返回值</li></ul><h3 id="代码实现"><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h3><p>ES3 版本的实现如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">myNew</span><span class="token punctuation">(</span><span class="token parameter">Fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Fn <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>Fn <span class="token operator">+</span> <span class="token string">'is not a constructor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    myNew<span class="token punctuation">.</span>target <span class="token operator">=</span> Fn
    <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token comment">// 检测构造函数原型是不是对象</span>
    instance<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">:</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype 
    <span class="token keyword">const</span> returnValue <span class="token operator">=</span> <span class="token function">Fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> returnValue <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> returnValue <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> returnValue <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> returnValue
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> instance
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ES6 版本的实现如下：</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">myNew</span><span class="token punctuation">(</span><span class="token parameter">Fn<span class="token punctuation">,</span><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Fn <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>Fn <span class="token operator">+</span> <span class="token string">'is not a constructor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    myNew<span class="token punctuation">.</span>target <span class="token operator">=</span> Fn
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token comment">// 检测构造函数原型是不是对象</span>
    instance<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">:</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype 
    <span class="token keyword">const</span> returnValue <span class="token operator">=</span> <span class="token function">Fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> returnValue <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">?</span> returnValue <span class="token operator">:</span> instance
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意几个要点：</p><ul><li>当函数是通过 new 调用的时候，<code>new.target</code> 会指向函数自身，这个“指向”的操作在代码里就是通过 <code>myNew.target = Fn</code> 体现的</li><li>为什么不直接使用 <code>const instance = Object.create(Fn.prototype)</code> 创建实例呢？根据<a target="_blank" rel="noopener" href="https://262.ecma-international.org/5.1/#sec-13.2.2">规范</a>，我们在实现 new 的时候，需要检测构造函数的原型是不是对象，如果不是对象，比如说是 null，那么实例的 <code>__proto__</code> 会指向 Object 的原型，而这里如果使用了 <code>Object.create</code>，则会导致实例的 <code>__proto__</code> 仍然指向 null。网上很多 <code>new</code> 的模拟实现直接使用了 <code>Object.create</code>，或者根本没有对构造函数的原型进行类型检查，这是不够严谨的</li><li>如果无法使用 <code>instanceof</code>，我们也可以改用 <code>typeof Fn.prototype === 'Object' &amp;&amp; Fn.prototype !== null</code> 进行判断</li></ul></div><div class="post-nav"><div class="post-nav-prev"><a href="/2021/05/26/F-JS%E5%8E%9F%E7%94%9F%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BB%A7%E6%89%BF%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9F/" rel="prev" title="JS 原生方法原理探究（四）：如何实现继承的几种方式？"><i class="fa fa-angle-double-left"></i>&nbspJS 原生方法原理探究（四）：如何实现继承的几种方式？</a></div><div class="post-nav-next"><a href="/2021/05/26/F-JS%E5%8E%9F%E7%94%9F%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%20Object.create()%EF%BC%9F/" rel="next" title="JS 原生方法原理探究（二）：如何实现 Object.create？">JS 原生方法原理探究（二）：如何实现 Object.create？&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#new-%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E8%A7%84%E8%8C%83"><span class="toc-text">new 操作符的规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructor-%E7%9A%84%E8%A7%84%E8%8C%83"><span class="toc-text">[[Constructor]] 的规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">代码实现</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=(t.substring(0,n),document.URL),s=new Date,l=document.getElementsByClassName("vnick vinput")[0].value||"Anonymous",i=(document.getElementsByClassName("vmail vinput")[0].value,document.getElementsByClassName("vlink vinput")[0].value,document.getElementsByClassName("veditor vinput")[0].value),o=e+"文章："+a+"\n\n昵称："+l+"\n\n留言："+i+"\n\n时间："+s.toLocaleString(),v=new XMLHttpRequest;v.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),v.setRequestHeader("Content-type","application/x-www-form-urlencoded"),v.send(title1+"&"+o)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2022</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/prism.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:150,height:300,vOffset:-120,hOffset:-5},mobile:{show:!1},react:{opacityDefault:1e3,opacityOnHover:1e3},log:!1})</script></body></html><!-- rebuild by neat -->