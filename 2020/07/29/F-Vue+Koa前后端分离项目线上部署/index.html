<!-- build time:Sun Sep 05 2021 14:32:51 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">Vue+Koa2 前后端分离项目线上部署</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2020-07-29&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp4.1k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp16 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d0.jpg"></div><span id="more"></span><p>昨天尝试部署一个 Vue+Koa2 的前后端分离项目，没想到因为前端项目部署的问题，卡了一整天，今天才终于找到了问题所在，成功解决。这篇文章主要谈谈：</p><ul><li>线上部署项目的相关事宜</li><li>如何用 Nginx 实现同端口多项目部署</li></ul><h3 id="项目结构说明">1. 项目结构说明</h3><p>服务器上的项目结构大概是这样的：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">在 <span class="ss">/home 路径下有两个如下的项目文件夹：</span>

<span class="ss">Vue-mall</span>
<span class="ss">MiniProgram-Admin</span>
<span class="ss">    </span><span class="sc">|</span><span class="ss">--client</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--css</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--js</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--images</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--index.html</span>
<span class="ss">    </span><span class="sc">|</span><span class="ss">--server</span></code></pre></div><p>其中，Vue-mall 是之前部署在根目录下的项目，也就是输入域名后默认访问的项目，这个我们不用动它；而 MiniProgram-Admin 就是本次需要部署的项目，包括一个 client 前端项目文件夹和一个 server 后端项目文件夹，我们希望达到的效果是，输入域名 + <code>/admin/</code> 后，可以访问这个项目。</p><h3 id="修改配置文件">2. 修改配置文件</h3><p>之前的项目是直接部署在根目录下的，也即 Nginx 配置文件的 <code>location /</code> 下，所以不需要改动前端项目的配置文件，直接打包上传即可；但这次不是部署在根目录下，所以我们要修改两个地方：打包路径和路由配置</p><h4 id="修改打包路径">2.1 修改打包路径</h4><blockquote><p>默认情况下，Vue CLI 会假设你的应用是被部署在一个域名的根路径上，例如 <code>https://www.my-app.com/</code>。如果应用被部署在一个子路径上，你就需要用这个选项指定这个子路径。例如，如果你的应用被部署在 <code>https://www.my-app.com/my-app/</code>，则设置 <code>publicPath</code> 为 <code>/my-app/</code>。</p><p>这个值也可以被设置为空字符串 (<code>''</code>) 或是相对路径 (<code>'./'</code>)，这样所有的资源都会被链接为相对路径，这样打出来的包可以被部署在任意路径.</p></blockquote><p><code>vue.config.js</code> 文件下的 <code>publicPath</code> 项，在 1. 开发环境 或者 2.生产环境但部署在根目录的情况下，直接使用默认的 <code>/</code> 即可，不需要特意去配置；但在生产环境且不是部署在根目录的情况下，则需要额外进行配置。</p><p>具体的路径配置是任意的，根据你自己的需要选择 —— 因为我们希望输入域名 + <code>/admin/</code> 后，就可以访问这个项目，所以配置了 <code>/admin/</code> 路径。这里要注意，<strong>虽然路径可以任选，但是必须和后面 Nginx 的路径配置一致，否则会报错</strong>。</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">publicPath<span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span> <span class="op">?</span> <span class="st">&#39;/admin/&#39;</span> : <span class="st">&#39;/&#39;</span><span class="op">,</span></code></pre></div><h4 id="修改路由配置">2.2 修改路由配置</h4><p>同样，我们也需要配置一下路由：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> createRouter <span class="op">=</span> () <span class="op">=&gt;</span> <span class="kw">new</span> <span class="at">Router</span>(<span class="op">&#123;</span>
  routes
  <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;history&#39;</span><span class="op">,</span> 
  <span class="dt">base</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span> <span class="op">?</span> <span class="st">&#39;/admin&#39;</span> : <span class="st">&#39;/&#39;</span><span class="op">,</span>
<span class="op">&#125;</span>)</code></pre></div><p>这里必须要使用 history 模式，同时和上面一样区分好项目环境。</p><h4 id="修改请求地址">2.3 修改请求地址</h4><p>之前都是本地开发，没有区分开发环境和生产环境下的请求地址，所以这里还得修改一下。</p><p>在项目的 <code>src</code> 文件夹下新建 <code>config.js</code> 文件，内容如下：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> host <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span> <span class="op">?</span>
            <span class="st">&#39;http://mydomain.com:3000&#39;</span>:<span class="st">&#39;http://localhost:3000&#39;</span>

<span class="kw">const</span> config <span class="op">=</span> <span class="op">&#123;</span>
  host
<span class="op">&#125;</span>

<span class="im">export</span> <span class="im">default</span> config</code></pre></div><p>之后在请求相关的 <code>api.js</code> 里再把 <code>config</code> 导入使用：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="im">import</span> config <span class="im">from</span> <span class="st">&#39;@/config&#39;</span>
<span class="kw">const</span> BASEURL <span class="op">=</span> <span class="va">config</span>.<span class="at">host</span>

<span class="im">export</span> <span class="kw">function</span> <span class="at">fetchData</span>()<span class="op">&#123;</span>
  <span class="cf">return</span> <span class="at">request</span>(<span class="op">&#123;</span>
    <span class="dt">method</span><span class="op">:</span><span class="st">&#39;get&#39;</span><span class="op">,</span>
    <span class="dt">url</span><span class="op">:</span><span class="vs">`</span><span class="sc">$&#123;</span>BASEURL<span class="sc">&#125;</span><span class="vs">/..../....`</span>
  <span class="op">&#125;</span>)
<span class="op">&#125;</span></code></pre></div><p>这样就可以根据开发环境和生产环境向不同的地址发送请求了。</p><h3 id="前端项目部署">3. 前端项目部署</h3><h4 id="文件结构一览">3.1 文件结构一览</h4><p>之后就可以 <code>npm run build</code> 打包了，打包后生成的静态资源结构是这样的：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">dist
  <span class="op">|--</span>css
  <span class="op">|--</span>js
  <span class="op">|--</span>images
  <span class="op">|--</span><span class="va">index</span>.<span class="at">html</span></code></pre></div><p>（当然，可能你的静态资源会出现在 <code>static</code> 文件夹里，这要看你是否配置了 <code>assetsDir: 'static'</code>）</p><p>打开 <code>index.html</code> 文件看一下，大概是这样的：</p><div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
<span class="kw">&lt;html&gt;</span>
<span class="kw">&lt;head&gt;</span>
  <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">utf-8</span><span class="kw">&gt;</span>
  <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">X-UA-Compatible</span><span class="ot"> content=</span><span class="st">&quot;IE=edge,chrome=1&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">viewport</span><span class="ot"> content=</span><span class="st">&quot;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">icon</span><span class="ot"> href=</span><span class="st">/admin/favicon.ico</span><span class="kw">&gt;</span>
  <span class="kw">&lt;title&gt;</span>Vue Admin<span class="kw">&lt;/title&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/css/app.6b18b5b0.css</span><span class="ot"> rel=</span><span class="st">preload</span><span class="ot"> as=</span><span class="st">style</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/css/chunk-elementUI.43fc3011.css</span><span class="ot"> rel=</span><span class="st">preload</span><span class="ot"> as=</span><span class="st">style</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/css/chunk-libs.5cf311f0.css</span><span class="ot"> rel=</span><span class="st">preload</span><span class="ot"> as=</span><span class="st">style</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/js/app.8d30b2c2.js</span><span class="ot"> rel=</span><span class="st">preload</span><span class="ot"> as=</span><span class="st">script</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/js/chunk-elementUI.cb459a4a.js</span><span class="ot"> rel=</span><span class="st">preload</span><span class="ot"> as=</span><span class="st">script</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/js/chunk-libs.b0da50a4.js</span><span class="ot"> rel=</span><span class="st">preload</span><span class="ot"> as=</span><span class="st">script</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/css/chunk-elementUI.43fc3011.css</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/css/chunk-libs.5cf311f0.css</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="kw">&gt;</span>
  <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">/admin/css/app.6b18b5b0.css</span><span class="ot"> rel=</span><span class="st">stylesheet</span><span class="kw">&gt;</span>
<span class="kw">&lt;/head&gt;</span>
<span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;noscript&gt;</span>
        <span class="kw">&lt;strong&gt;</span>
            We&#39;re sorry but Vue Admin Template doesn&#39;t work properly without JavaScript enabled. Please enable it to continue.
        <span class="kw">&lt;/strong&gt;</span>
    <span class="kw">&lt;/noscript&gt;</span>
  <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">app</span><span class="kw">&gt;&lt;/div&gt;</span>
  <span class="kw">&lt;script&gt;</span>............<span class="kw">&lt;/script&gt;</span>
  <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">/admin/js/chunk-elementUI.cb459a4a.js</span><span class="kw">&gt;&lt;/script&gt;</span>
  <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">/admin/js/chunk-libs.b0da50a4.js</span><span class="kw">&gt;&lt;/script&gt;</span>
  <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">/admin/js/app.8d30b2c2.js</span><span class="kw">&gt;&lt;/script&gt;</span>
<span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></code></pre></div><p>注意看这里的资源引用路径，都是以 <code>/admin/</code> 开头的，后面跟上的是静态资源文件夹的名字。</p><p>可能你会在本地开个服务器看看效果，但是呢，这时候的页面一定会是空白的，毕竟资源引用路径不对嘛，本地并没有 <code>admin</code> 文件夹。所以不用管本地预览效果了，直接上传到服务器即可。</p><h4 id="上传文件并修改-nginx-配置">3.2 上传文件并修改 Nginx 配置</h4><p>我这里使用 MobaXterm （顺便安利一下，这软件挺全能的，唯一缺点就是有点卡）将文件上传到服务器，最后的结构就像文章开头那样：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">在 <span class="ss">/home 路径下有两个如下的项目文件夹：</span>

<span class="ss">Vue-mall</span>
<span class="ss">MiniProgram-Admin</span>
<span class="ss">    </span><span class="sc">|</span><span class="ss">--client</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--css</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--js</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--images</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--index.html</span></code></pre></div><p>接着就是最关键的地方了，配置 Nginx 的文件。你可以直接在 <code>nginx.conf</code> 文件配置，也可以引入单独的 <code>.conf</code> 文件。但无论如何，一定要弄清自己引入了哪些 <code>.conf</code> 文件，防止发生配置被覆盖的问题。</p><p>为了方便项目管理，我这里引入了额外的 <code>MyProject.conf</code> 文件，配置好之后的内容如下：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"># <span class="va">MyProject</span>.<span class="at">conf</span>
server <span class="op">&#123;</span>
  listen <span class="dv">80</span><span class="op">;</span>
  server_name localhost<span class="op">;</span>
  
  location / <span class="op">&#123;</span>
    root  /home/vue<span class="op">-</span>mall/<span class="op">;</span>
    index <span class="va">index</span>.<span class="at">html</span> <span class="va">index</span>.<span class="at">htm</span><span class="op">;</span>
    try_files $uri $uri/ @fallback<span class="op">;</span>
  <span class="op">&#125;</span>
  location /admin/ <span class="op">&#123;</span>
    alias /home/MiniProgram<span class="op">-</span>Admin/client/<span class="op">;</span>
    try_files $uri $uri/ @fallback<span class="op">;</span>
  <span class="op">&#125;</span>
  location @fallback <span class="op">&#123;</span>
    root  /home/vue<span class="op">-</span>mall/<span class="op">;</span>
    index <span class="va">index</span>.<span class="at">html</span> <span class="va">index</span>.<span class="at">htm</span><span class="op">;</span>
  <span class="op">&#125;</span>
<span class="op">&#125;</span> </code></pre></div><p>下面详细介绍各个配置：</p><p><strong>1. <code>server</code>：</strong></p><p>所有配置都是写在 <code>server</code> 模块下的，并且通过配置 <code>listen 80</code> 监听 80 端口，<code>server_name</code> 主要用于配置基于名称的虚拟主机，就本项目而言，可以不写</p><p><strong>2. <code>location</code>：</strong></p><p>在 <code>server</code> 模块下有多个 <code>location</code> 块，一个 <code>location</code> 对应一个项目。可以看到，第一个块的路径是 <code>/</code>，这决定了我们输入域名后将访问该 <code>location</code> 块下的项目；同理，第二个块的路径是 <code>admin</code>，所以输入域名 + <code>/admin/</code> 之后，访问的是现在部署的这个项目，<strong>注意，正如前面所说的，这里的 location 路径务必和之前前端项目配置的路径保持一致</strong>；第三个块是做重定向用的，稍后再解释</p><p><strong>3. <code>location</code> 下的各个配置：</strong></p><ul><li><code>root</code> 和 <code>alias</code>：这两个指令后面都跟着路径，路径指示了<strong>对应项目的入口文件（通常是 <code>index.html</code>）的绝对路径</strong>，它们的区别是：</li><li>因为这里我们要在同端口部署多项目，所以给根目录的项目使用的是 <code>root</code> 指令，而给非根目录的项目使用的则是<code>alias</code> 指令。</li><li>直接输入域名访问的时候，会根据 root 路径 + location 路径来寻找入口文件；输入域名 + <code>/admin/</code> 访问的时候，会用整个 alias 路径去替换 location 路径，从而寻找入口文件</li><li><code>index</code>：说是寻找入口文件，不过怎么指定入口文件是哪一个呢？通常 Vue-Cli 打包后生成的入口文件都是 <code>index.html</code>，所以这里对应的配置就是 <code>index index.html index.htm;</code>。记住，不需要携带路径，因为它仅仅是指明入口文件的名称，并根据该名称去寻找</li><li><code>try_files</code>：前面的 <code>root</code>，<code>alias</code>，<code>index</code> 都只是指明了路径，那么具体是用哪个指令来完成“寻找文件”这个动作的呢？就是 <code>try_files</code>，顾名思义就是“尝试读取文件”，它作用的过程是这样的：</li><li>就像我们看到的，这个指令接受三个参数，其中 <code>$uri</code> 是用户访问的路径。假如用户输入域名 + <code>/admin/</code> 进行访问，那么 <code>$uri</code> 就会等于 <code>/admin/</code>，就会去 <code>/admin/</code> 下寻找资源，而 <code>/admin</code> 又是被 alias 路径替换的，因此就会去 alias 路径下寻找资源，最后就找到了这个路径下面的 <code>index.html</code> 入口文件。</li><li>如果按照这样找，找不到怎么办呢？那么就会用第二个选项 <code>$uri/</code> 尝试再次寻找，而如果还是找不到呢，就只能使用备选的 <code>@fallback</code> 啦，它表示重定向到这个 <code>fallback</code> 指向的页面，而 <code>fallback</code> 具体指向哪个页面，我们可以在下面通过 <code>location</code> 块进行配置。</li></ul><p>确保配置正确且成功引入之后，就可以重启 Nginx 了：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">nginx <span class="op">-</span>t   <span class="co">// 测试配置是否通过</span>
nginx <span class="op">-</span>s reload</code></pre></div><p>不出意外的话，通过域名 + <code>/admin/</code> 就能访问我们的项目了。当然，有可能打开之后遇到页面空白的情况，这种情况基本就是配置错误了，需要回过头再仔细检查一遍各种路径的配置。</p><p>这样，前端项目就部署好了，接下来部署后端项目</p><h3 id="后端项目部署">4. 后端项目部署</h3><h4 id="修改文件">4.1 修改文件</h4><p>后端项目的部署就比较简单了，基本不需要额外的配置。这里主要是解决跨域问题，其实我们用 Nginx 的话直接通过反向代理就可以解决跨域，但之前本地开发的时候，我是通过 <code>koa2-cors</code> 解决跨域的，因此还是继续用这个方案吧，安装模块后，在<code>app.js</code> 使用，大致配置如下：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"><span class="kw">const</span> cors <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;koa2-cors&#39;</span>)

<span class="va">app</span>.<span class="at">use</span>(<span class="at">cors</span>(<span class="op">&#123;</span>
  <span class="dt">origin</span><span class="op">:</span> <span class="kw">function</span>(ctx) <span class="op">&#123;</span> 
    <span class="kw">const</span> whiteList <span class="op">=</span> [<span class="st">&#39;http://mydomain.com&#39;</span>]   <span class="co">//可跨域白名单</span>
    <span class="kw">let</span> currentUrl <span class="op">=</span> <span class="va">ctx</span>.<span class="va">request</span>.<span class="at">origin</span>     
    <span class="kw">let</span> changeUrl <span class="op">=</span> <span class="va">currentUrl</span>.<span class="at">substring</span>(<span class="dv">0</span><span class="op">,</span><span class="va">currentUrl</span>.<span class="at">length</span> <span class="op">-</span> <span class="dv">5</span>)   
    <span class="cf">if</span>(<span class="va">whiteList</span>.<span class="at">includes</span>(changeUrl))<span class="op">&#123;</span>
        <span class="cf">return</span> changeUrl    
    <span class="op">&#125;</span>
    <span class="cf">return</span> <span class="st">&#39;http://localhost:9528&#39;</span> <span class="co">// 开发环境用的，默认允许本地端口跨域</span>
  <span class="op">&#125;,</span>
  <span class="dt">credentials</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">&#125;</span>))</code></pre></div><p>需要设置的是 <code>origin</code> 和 <code>credentials</code>。<code>origin</code> 可以是函数或者字符串，指示可信任的域名。这里的话我准备了一个白名单，前端发送请求的时候会判断域名是否在白名单里，不在的话就拒绝此次请求。最后，默认返回的是本地开发用的端口。</p><p>需要改动的就是这里，之后直接把后端项目文件夹上传到服务器即可（node_modules 就不要拖过去了，我们直接在服务器那边安装好），因此最后的结构是这样的：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">在 <span class="ss">/home 路径下有两个如下的项目文件夹：</span>

<span class="ss">Vue-mall</span>
<span class="ss">MiniProgram-Admin</span>
<span class="ss">    </span><span class="sc">|</span><span class="ss">--client</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--css</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--js</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--images</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--index.html</span>
<span class="ss">    </span><span class="sc">|</span><span class="ss">--server</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">--app.js</span>
<span class="ss">        </span><span class="sc">|</span><span class="ss">-- .........</span></code></pre></div><p>同时，还需要再次修改 Nginx 的配置文件，在开头添加：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">upstream <span class="va">koa</span>.<span class="at">server</span> <span class="op">&#123;</span>
  server <span class="dt">localhost</span><span class="op">:</span><span class="dv">3000</span><span class="op">;</span>
<span class="op">&#125;</span></code></pre></div><p>和本地一样，服务器监听的是 3000 端口。</p><h4 id="安装依赖">4.2 安装依赖</h4><p>接下来安装后端项目的依赖。但我的服务器并没有 node 环境，所以还要安装一下 node：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">apt install nodejs</code></pre></div><p>同时安装 npm：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">apt install npm</code></pre></div><p>最后安装项目依赖：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">cd /home/MiniProgram<span class="op">-</span>Admin/server
npm install</code></pre></div><p>安装速度可能很慢，换个源就好了。最后 <code>npm run server</code> （也可能是 <code>npm run dev</code>，看自己的配置）开启后端服务，访问域名 + 3000 端口，显示如下的页面就说明成功了：</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d3.png" style="zoom:67%"></p><p>你的页面内容可能不是这个，具体看你给 <code>ctx.body</code> 返回什么。</p><h4 id="node常驻后台运行">4.3 Node常驻后台运行</h4><p>最后还有一个问题，我们现在是通过 <code>npm run server</code> 开启后端服务的，一旦关闭终端或者断开 ssh 连接，后端服务就停止了。怎么才能让它常驻后台运行呢？</p><p>可以安装 forever 或者 pm2 解决这个问题，这里我用的是 pm2。</p><p>先安装 pm2：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">npm install pm2 <span class="op">-</span>g</code></pre></div><p>安装完 <code>pm2 -v</code> 查看一下，确认安装正确，接着启动 node 服务：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">cd /home/MiniProgram<span class="op">-</span>Admin/server
pm2 start npm <span class="op">--</span>name byNpm <span class="op">--</span> run server</code></pre></div><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d5.png"></div><p>这里通过 <code>--name</code> 参数可以自己指定一个项目名字，后面的 <code>run server</code> 对应此前给后端项目配置的 <code>npm</code> 启动指令。</p><p>当然，也可以通过直接指定文件的方式启动 node 服务：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">cd /home/MiniProgram<span class="op">-</span>Admin/server
pm2 start <span class="op">--</span>name byFile <span class="va">app</span>.<span class="at">js</span></code></pre></div><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d6.png"></div><p>可以看到这里有两个开启同一个 node 服务的项目。下面是一些日常会用到的 pm2 指令：</p><p>监听文件改动，重启服务器：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">pm2 start <span class="va">app</span>.<span class="at">js</span> <span class="op">--</span>watch</code></pre></div><p>终止某个项目：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">pm2 stop 项目名</code></pre></div><p>彻底删除某个项目：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">pm2 <span class="kw">delete</span> 项目名</code></pre></div><p>查看项目列表：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">pm2 list</code></pre></div><p>重启项目：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">pm2 restart 项目名</code></pre></div><p>当然，这个过程还可能会遇到端口冲突的问题，解决方法参考下面。</p><h3 id="错误说明">5. 错误说明</h3><h4 id="端口占用">5.1 端口占用</h4><p>在开启后端服务的时候，可能会遇到下面的报错：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d1.png"></div><p>这是因为 3000 端口被占用了，所以我们先找出占用端口的进程：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">netstat <span class="op">-</span>tunlp<span class="op">|</span>grep <span class="dv">3000</span></code></pre></div><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d4.png"></div><p>可以看到，这里占用端口的是之前没有正确关闭的 node 进程，找到进程号 17821，直接 kill 即可：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">kill <span class="op">-</span><span class="dv">9</span> <span class="dv">17821</span></code></pre></div><h4 id="无法访问端口">5.2 无法访问端口</h4><p>如果在访问 3000 端口的时候，页面显示无法连接，可能是因为服务器的安全组没有开放 3000 端口，去控制台看看，配置一下入口规则即可。</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d7.png"></div><h4 id="uuexpected-token-mime-类型错误">5.3 Uuexpected token &lt; / MIME 类型错误</h4><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d12.png"></div><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d10.png"></div><p>这两个报错都是因为数据返回格式不对。前面我们在 Nginx 的文件里配置过 <code>try_files</code> —— 如果找不到入口文件，就会使用 fallback，返回一个默认的 <code>index.html</code>（或者是 <code>404.html</code>），但是因为向服务端请求的是 css 和 js 文件，并且对于返回的资源也是按照 css 或者 js 去解析的，所以在遇到 <code>html</code> 文件的 <code>&lt;</code> 时就会出现解析出错的问题。</p><h4 id="排查方法">5.4 排查方法</h4><p>要学会多通过 network 和日志去进行排错。可以配置 Nginx 的文件，开启访问日志和错误日志，看看能不能从日志中找出什么问题。</p><p>在 <code>nginx.conf</code> 中配置：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"># <span class="va">nginx</span>.<span class="at">conf</span>
http <span class="op">&#123;</span>
    include  <span class="va">mime</span>.<span class="at">types</span><span class="op">;</span>
    default_type  application/octet<span class="op">-</span>stream<span class="op">;</span>
    log_format main <span class="st">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span> # 配置访问日志
                    <span class="st">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
                    <span class="st">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="op">;</span>
    .......
    .....
<span class="op">&#125;</span></code></pre></div><p>在 <code>MyProject.conf</code> 中配置：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript"># <span class="va">MyProject</span>.<span class="at">conf</span>
upstream <span class="va">koa</span>.<span class="at">server</span> <span class="op">&#123;</span>
  server <span class="dt">localhost</span><span class="op">:</span><span class="dv">3000</span><span class="op">;</span>
<span class="op">&#125;</span>
server <span class="op">&#123;</span>
  listen <span class="dv">80</span><span class="op">;</span>
  server_name localhost<span class="op">;</span>
  
  location / <span class="op">&#123;</span>
    .......
  <span class="op">&#125;</span>
  location /admin/ <span class="op">&#123;</span>
    .......
      
  <span class="op">&#125;</span>
  location @fallback <span class="op">&#123;</span>
    .....
  <span class="op">&#125;</span>
  access_log /ect/nginx/logs/<span class="va">access_</span>.<span class="at">log</span> <span class="at">main</span><span class="op">;</span>   # 开启访问日志  
  error_log  /etc/nginx/logs/<span class="va">error_</span>.<span class="at">log</span>  <span class="at">error</span><span class="op">;</span>  # 开启错误日志
<span class="op">&#125;</span> </code></pre></div><p>比如，在访问 <code>location /MiniProgram-Admin/</code> 的时候出现了问题，那么可以看一下错误日志：</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/Vue%2BKoa%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2/d13.png"></div><p>注意这句话：<code>rewrite or internal redirection cycle while internally redirecting to &quot;/MiniProgram-Admin/client/index.html&quot;</code></p><p>它所说的 <code>internally redirecting</code> 就是之前用 <code>try_files</code> 指令配置的重定向，而 <code>cycle</code> 指的是陷入了循环。那么为什么会陷入循环呢？之前不是已经配置好了，如果找不到入口文件，就将 <code>/MiniProgram-Admin/client/index.html</code> 作为入口文件吗？唯一的解释就是这个路径本身就是错的，因为找不到这个路径下的 <code>html</code> 文件，所以又再次发生了重定向，最后陷入了循环。经过检查，确实是路径的问题，这里应该用绝对路径，前面少了一个 <code>/home</code>。</p><p>当然，可以直接给个 404 的 fallback：</p><div class="sourceCode"><pre class="sourceCode js"><code class="sourceCode javascript">try_files $uri $uri/ <span class="op">=</span><span class="dv">404</span><span class="op">;</span></code></pre></div><h3 id="最后">6. 最后</h3><p>以上就是本文的全部内容了。总的来说还是踩了不少坑的，而且也不好排查。尤其是静态资源引用错误的问题卡了一整天，最后才发现是 Nginx 的路径配置有问题。所幸最后算是都顺利解决了，更重要的是在这个过程中学到了很多新的东西，感觉还是挺不错的。</p><p>参考：</p><p>https://www.nginx.cn/doc/standard/httpcore.html</p><p>https://cli.vuejs.org/zh/config/#publicpath</p><p>https://juejin.im/post/5ee59b0af265da76c4245e39</p><p>https://www.weipxiu.com/4019.html</p><p>https://segmentfault.com/a/1190000021906411</p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2020/08/12/Trs-%E5%85%B3%E4%BA%8E%20z-index%EF%BC%8C%E4%BD%A0%E5%8F%AF%E8%83%BD%E4%B8%80%E7%9B%B4%E5%AD%98%E5%9C%A8%E8%AF%AF%E5%8C%BA/" rel="prev" title="关于 z-index，你可能一直存在误区"><i class="fa fa-angle-double-left"></i>&nbsp关于 z-index，你可能一直存在误区</a></div><div class="post-nav-next"><a href="/2020/07/27/F-concurrently%E5%AE%9E%E7%8E%B0%E5%89%8D%E5%90%8E%E7%AB%AF%E8%BF%9E%E8%BD%BD%E5%90%AF%E5%8A%A8/" rel="next" title="concurrently 实现前后端连载启动">concurrently 实现前后端连载启动&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-text">1. 项目结构说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2. 修改配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%89%93%E5%8C%85%E8%B7%AF%E5%BE%84"><span class="toc-text">2.1 修改打包路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2 修改路由配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80"><span class="toc-text">2.3 修改请求地址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-text">3. 前端项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E8%A7%88"><span class="toc-text">3.1 文件结构一览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%B9%B6%E4%BF%AE%E6%94%B9-nginx-%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2 上传文件并修改 Nginx 配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-text">4. 后端项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6"><span class="toc-text">4.1 修改文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-text">4.2 安装依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#node%E5%B8%B8%E9%A9%BB%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C"><span class="toc-text">4.3 Node常驻后台运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E8%AF%B4%E6%98%8E"><span class="toc-text">5. 错误说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8"><span class="toc-text">5.1 端口占用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E7%AB%AF%E5%8F%A3"><span class="toc-text">5.2 无法访问端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uuexpected-token-mime-%E7%B1%BB%E5%9E%8B%E9%94%99%E8%AF%AF"><span class="toc-text">5.3 Uuexpected token &lt; &#x2F; MIME 类型错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95"><span class="toc-text">5.4 排查方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-text">6. 最后</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->