<!-- build time:Tue Apr 14 2020 15:20:22 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script><script src="/js/prism-line-numbers.min.js"></script><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><script src="/js/prism.js"></script>
<script src="/js/prism-line-numbers.min.js"></script></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">深入理解事件循环</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2019-03-05&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp3.1k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp11 mins&nbsp&nbsp&nbsp</span><div class="post-tags"><i class="fa fa-tags"></i> <a href="/tags/事件队列/">事件队列</a></div></div><div class="post-content"><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-1.png" alt=""></p><a id="more"></a><p>本篇博客讲的东西偏底层，较难理解。虽然有的地方不够精准和全面，但是我觉得对于理解js中的异步来说已经够了，所以没有再深究一些概念（比如浏览器在这个过程中充当的角色）。</p><h2 id="1-单线程"><a href="#1-单线程" class="headerlink" title="1.单线程"></a>1.单线程</h2><p>所谓的单线程，可以简单理解为做事情讲究先来后到，要做后面的事情，你得等前面的事情做完—–不管它需要多久。<br>既然如此，js引擎为何还要采取这种单线程的机制呢？<br>js主要是与用户互动，这个过程涉及到对DOM节点的操作，如果js是多线程的，一个在节点上添加内容，一个要对这个dom节点进行删除，到底是以哪个为准？所以这就是为什么js从一出现就秉承着单线程的运行机制。<br>另外还要注意：</p><blockquote><p>“为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质”</p></blockquote><h2 id="2-同步任务和异步任务"><a href="#2-同步任务和异步任务" class="headerlink" title="2.同步任务和异步任务"></a>2.同步任务和异步任务</h2><p>很显然，单线程会带来一个问题：就是代码执行的阻塞。比如：排在前面的任务如果耗时长，则后面的任务不得不一直等待它。 如果说耗时长是因为计算量大、cpu一直忙着计算的话倒也还好，可事实是——大部分时间浪费在了IO上（ajax从网络上获取数据），还有其他的如鼠标点击、setTimeout等等。因此这里提出了同步任务和异步任务的概念。</p><p>在js中，可以将同步和异步简单理解为执行顺序的问题。</p><h3 id="2-1同步（sync）："><a href="#2-1同步（sync）：" class="headerlink" title="2.1同步（sync）："></a>2.1同步（sync）：</h3><p>即上面所说的后面等待前面。同步对应了同步任务（synchronous），即可以按照正常顺序执行的任务，比如加载页面骨架等。</p><h3 id="2-2异步（async）："><a href="#2-2异步（async）：" class="headerlink" title="2.2异步（async）："></a>2.2异步（async）：</h3><p>即把耗时长的任务挂起，先执行耗时短的，再回过头执行耗时长的。<br>异步对应了异步任务（asynchronous），即不适合按照正常顺序执行的任务，主要包括：</p><ul><li>onclick等事件绑定—&gt; 当事件触发时，回调函数会被添加到任务队列中；</li><li>setTimeout / setInterval 等计时器—&gt; (时间延迟)当浏览器完成计时，回调函数会被添加到任务队列中；</li><li>AJAX请求—&gt;当网络请求完成返回时，回调函数会被添加到任务队列中</li></ul><h2 id="3-事件循环"><a href="#3-事件循环" class="headerlink" title="3.事件循环"></a>3.事件循环</h2><ul><li>事件循环又叫event loop，需要注意的是，事件循环<strong>不是</strong>单线程的js引擎提供的机制，而是来自于js引擎的运行环境（多线程的浏览器或node.js）。</li><li>事件循环是实现异步的一种机制。一个线程中只有一个事件循环，我们将这个循环的每一次循环执行过程称之为tick。 具体每一次循环是怎么执行的，后文会讲。</li></ul><h2 id="4-执行栈和任务队列"><a href="#4-执行栈和任务队列" class="headerlink" title="4.执行栈和任务队列"></a>4.执行栈和任务队列</h2><p>事件循环机制离不开执行栈和任务队列的相互配合。js中将<span style="background-color:#fffa7d">同步任务放到主线程上执行，形成“执行栈”；异步任务则放到任务队列中</span>。</p><p><strong>任务队列的分类标准之一：</strong></p><p>一个线程可以拥有多个任务队列。每一个任务队列都对应某一任务源，并包含了一堆来自该任务源的任务。任务源是什么？像setTimeout/Promise/DOM事件/AJAX等都是任务源，来自同类任务源的任务我们称它们是同源的，比如setTimeout与setInterval就是同源的。</p><p><strong>任务队列的分类标准之二：</strong></p><p>在ES6中，我们用另一种方式对任务队列进行分类。<br><span style="background-color:#fffa7d">宏任务</span>: 即macro-task，包括整体代码script，setTimeout，setInterval、AJAX、用户I\O 等。宏任务会对应地进入宏任务队列中；<br><span style="background-color:#fffa7d">微任务</span>: 即micro-task,包括Promise，process.nextTick(callback)(可以理解为node.js版的setTimeOut)。微任务会对应地进入微任务队列中。</p><h2 id="5-事件循环的具体实现过程？"><a href="#5-事件循环的具体实现过程？" class="headerlink" title="5.事件循环的具体实现过程？"></a>5.事件循环的具体实现过程？</h2><p>总的来说，事件循环的顺序，决定了js代码执行的顺序。</p><ul><li>首先进入<code>&lt;script&gt;</code>包裹的整体代码(这是第一个宏任务)，标志着第一次循环开始。在整体代码的执行过程中，同步任务照旧执行，异步任务分发到对应的任务队列中；</li><li>整体代码执行完，执行栈清空，开始读取任务队列；</li><li>读取所有微观任务队列 -&gt; 执行 -&gt;<br>第一次循环结束，开始第二次循环<br>读取一个宏观任务队列 -&gt; 执行 -&gt;<br>读取所有微观任务队列 -&gt; 执行 -&gt;<br>第二次循环结束，开始第三次循环<br>读取一个宏观任务队列……………..<br>………<br>………<br>队列清空，执行栈清空，事件循环正式结束。</li></ul><p>PS：读取任务时，会执行这些任务指定的回调函数,并且要注意：若回调函数中又有宏任务，则该宏任务会被安排到下一轮循环中。</p><h2 id="6-事件循环的例子"><a href="#6-事件循环的例子" class="headerlink" title="6.事件循环的例子"></a>6.事件循环的例子</h2><p>下面通过三个由易到难的例子来理解上面所说的过程。</p><p><strong>例1</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
<span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析：<br>跑一下代码，会发现控制台执行task()需要的时间远远超过3秒，这就说明我们有的人理解的”setTimeout的第二个参数指定了多长时间后执行回调函数”的说法是错误的。<br>让我们来分析一下这个过程：</p><ul><li><code>&lt;script&gt;</code>中的整段代码作为第一个宏任务，进入主线程。即开启第一次事件循环；</li><li>首先遇到了setTimeout，将其回调函数task()进入Event Table并注册,同时浏览器开始计时；</li><li>继续，遇到了sleep函数，这是同步任务，所以直接执行。但是速度很慢，非常慢，而浏览器计时仍在继续；</li><li>好了，3秒终于到了，计时事件setTimeout总算完成，可以把task()放入任务队列了;</li><li>但是主线程上的sleep太慢了，还没执行完，于是我们只好等着；</li><li>sleep终于执行完了，执行栈清空,第一次循环的宏任务结束；</li><li>读取微任务队列….不对，没有任何任务被分发到这个队列，于是第一次循环只好这样结束了；</li><li>第二次循环开始，读取宏任务队列，刚好，里面有一个setTimeout对应的task()回调函数，压栈、令其进入主线程执行；</li><li>执行栈清空了，任务队列也清空了，事件循环正式结束。</li></ul><p>现在，我们知道setTimeout的回调函数是一开始就注册进event table的，但是那时并未进入任务队列—-要经过一定的时间，而这个时间由第二个参数来指定。也就是说，第二个参数指定的是“多长时间后将回调函数放入到任务队列中”。<br>另外，即使回调函数已经进入队列，也得先等主线程的执行栈清空后才有可能轮到自己。<br>我们还经常遇到<code>setTimeout(fn,0)</code>(或者干脆没有指定第二个参数)这样的代码，这是不是意味着可以立即执行呢？<br>不是。setTimeout(fn,0)的含义是，指定某个任务在主线程最早可得的空闲时间执行，意思就是注册进event table的同时就将任务放入队列中，只要主线程执行栈内的同步任务全部执行完成，且此时没有微任务队列，那么该任务就会马上压栈并执行。</p><p><strong>例2</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析：</p><ul><li><code>&lt;script&gt;</code>中的整段代码作为第一个宏任务，进入主线程。即开启第一次事件循环；</li><li>遇到setTimeout，将其回调函数放入Event table中注册，然后分发到宏任务队列中（第二个参数不设定时，默认延迟为0）；</li><li>接下来遇到new Promise、Promise，立即执行，输出: promise 。将then函数分发到微任务队列中；</li><li>遇到console.log，立即执行，输出: console</li><li>整体代码作为第一个宏任务执行结束，此时去微任务队列中查看有哪些微任务，结果发现了then函数，然后将它推入主线程并执行，输出: then</li><li>第一轮事件循环结束，第二轮事件循环开始；</li><li>先从宏任务开始，去宏任务队列中查看有哪些宏任务，结果发现了setTimeout对应的回调函数，将它推入主线程并执行，输出：setTimeout</li><li>然后去微任务队列中查看是否有事件，结果没有；</li><li>此时第二轮事件循环结束；</li><li>执行栈清空了，任务队列也清空了，事件循环正式结束。</li></ul><p><strong>例3</strong></p><pre class="line-numbers language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析：</p><p>第一轮事件循环:</p><pre class="line-numbers language-html"><code class="language-html">a) 整段`<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span>`代码作为第一个宏任务进入主线程，即开启第一轮事件循环
b) 遇到console.log，立即执行。输出：1
c) 遇到setTimeout，将其回调函数放入Event table中注册，然后分发到宏任务队列中。
我们将其标记为setTimeout1
d) 遇到process.nextTick，其回调函数放入Event table中注册，然后被分发到微任务
队列中。记为process1
e) 遇到new Promise、Promise，立即执行；then回调函数放入Event table中注册，然后
被分发到微任务队列中。记为then1。
输出: 7
f) 遇到setTimeout，将其回调函数放入Event table中注册，然后分发到宏任务队列中。
我们将其标记为setTimeout2
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时第一轮事件循环宏任务结束，下表是第一轮事件循环宏任务结束时各任务队列的情况</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-2.png" alt=""></p><p>可以看到第一轮事件循环宏任务结束后微任务事件队列中还有两个事件待执行，因此这两个事件会被推入主线程，然后执行</p><pre class="line-numbers language-html"><code class="language-html">g)、执行process1。输出：6
h)、执行then1。输出：8
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>第一轮事件循环正式结束！</p><p>第二轮事件循环:</p><pre class="line-numbers language-html"><code class="language-html">a）、第二轮事件循环从宏任务setTimeout1开始。遇到console.log，立即执行。输出: 2
b）、遇到process.nextTick，其回调函数放入Event table中注册，然后被分发到微任务
队列中。记为process2
c）、遇到new Promise，立即执行；then回调函数放入Event table中注册，然后被分发到
微任务队列中。记为then2。输出: 5
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时第二轮事件循环宏任务结束，下表是第二轮事件循环宏任务结束时各任务队列的情况</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-3.png" alt=""></p><p>可以看到第二轮事件循环宏任务结束后微任务事件队列中还有两个事件待执行，因此这两个事件会被推入主线程，然后执行</p><pre class="line-numbers language-html"><code class="language-html">d)、执行process2。输出：3
e)、执行then2。输出：5
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>第二轮事件循环正式结束！</p><p>第三轮事件循环:</p><pre class="line-numbers language-html"><code class="language-html">a)、第三轮事件循环从宏任务setTimeout2开始。遇到console.log，立即执行。输出: 9
d)、遇到process.nextTick，其回调函数放入Event table中注册，然后被分发到微任务
队列中。记为process3
c)、遇到new Promise，立即执行；then回调函数放入Event table中注册，然后被分发到
微任务队列中。记为then3。输出: 11
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时第三轮事件循环宏任务结束，下表是第三轮事件循环宏任务结束时各任务队列的情况</p><p><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-4.png" alt=""></p><p>可以看到第二轮事件循环宏任务结束后微任务队列中还有两个事件待执行，因此这两个事件会被推入主线程，然后执行</p><pre class="line-numbers language-html"><code class="language-html">d)、执行process3。输出：10
e)、执行then3。输出：12
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>第二轮事件循环正式结束！<br>执行栈清空，任务队列清空，事件循环正式结束！</p><p>参考：<br><a href="https://segmentfault.com/a/1190000017970432" target="_blank" rel="noopener">https://segmentfault.com/a/1190000017970432</a><br><a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/10/event-loop.html</a></p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2019/03/08/F-DOM%20Core%20%E5%92%8CHTML%20DOM/" rel="prev" title="DOM Core 与 HTML-DOM"><i class="fa fa-angle-double-left"></i>&nbspDOM Core 与 HTML-DOM</a></div><div class="post-nav-next"><a href="/2019/03/04/F-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3%E9%97%AD%E5%8C%85/" rel="next" title="深入浅出理解闭包">深入浅出理解闭包&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-单线程"><span class="toc-text">1.单线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-同步任务和异步任务"><span class="toc-text">2.同步任务和异步任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1同步（sync）："><span class="toc-text">2.1同步（sync）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2异步（async）："><span class="toc-text">2.2异步（async）：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-事件循环"><span class="toc-text">3.事件循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-执行栈和任务队列"><span class="toc-text">4.执行栈和任务队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-事件循环的具体实现过程？"><span class="toc-text">5.事件循环的具体实现过程？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-事件循环的例子"><span class="toc-text">6.事件循环的例子</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"mm",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2020</span> My Blog</p><p class="a">Powered by <a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a> | Theme - <a href="https://github.com/Chorer/hexo-theme-PureBlue" target="_blank" rel="noopener">PureBlue</a></p></div></footer><script src="https://code.jquery.com/jquery-3.3.1.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->