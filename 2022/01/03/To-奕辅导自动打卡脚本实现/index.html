<!-- build time:Sun Jan 15 2023 16:09:00 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">奕辅导自动打卡脚本实现</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2022-01-03&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.1k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp3 mins&nbsp&nbsp&nbsp</span><div class="post-tags"></div></div><div class="post-content"><span id="more"></span><p>在使用了一个学期的自动打卡之后，学校突然宣布停用原来的“我在校园”小程序（好像是合作期到了），改用“奕辅导”小程序。虽说程序改了，但是实现自动打卡的原理基本是不变的，所以这几天有空研究了一下这个新的小程序。</p><p>首先还是通过 Fiddler 抓包小程序的请求并进行分析，这个就不赘述了。打卡过程基本可以归纳为如下：</p><ul><li>用户通过微信登录小程序，小程序调用 <code>wx.login</code> 获取 jsCode，再将其作为参数发送请求 1，获取用户的 accessToken。其有效期为一星期左右。</li><li>将 accessToken 作为参数，发送请求 2，获取用户今日打卡状态以及一个很重要的问卷 id（每个用户、每一天都有自己的一个问卷id）</li><li>将问卷 id 拼接到 url 中，发送请求 3，获取今日问卷</li><li>创建 json 格式的问卷答案，发送请求 4，提交问卷（完成打卡）</li></ul><p>知道了大致流程之后，接下来就很简单了，写脚本模拟这个过程即可。</p><p>之前的小程序我是用 Python 写的，但语法始终用不习惯，这回就改用 JS 写了。请求头、请求参数和接口地址都是知道的，由于一天只需打卡一次，少了早中晚的时间段判断，所以逻辑上也比“我在校园”小程序简单得多。需要注意的就是创建问卷答案这一块，其实这里提交的 json 内容可以是固定的，毕竟每天的问卷内容不大可能更改，但由于中间（大概是 1 号的时候）确实修改了一次，所以谨慎起见还是要检验一下。问卷大概有 8 个子问题，每个子问题有一个 id，每天打卡的时候会先获取所有子问题的 id，与准备提交的 json 中的子问题 id 做比对，确认是完全一样之后才会提交问卷。</p><p>既然是自动打卡，肯定少不了 token 过期的问题。从请求返回的字段来看，accessToken 的有效期大概一星期，但实际上解包小程序之后发现只有六天。过期了怎么办呢？目前来说只有重新抓包，无法自动获取新的 token，因为这个 token 是发送带 jsCode 参数的请求获取的，jsCode 只有调用 <code>wx.login</code> 才能拿到，且是一次性的，脚本无法模拟这个过程。看了小程序源码之后发现似乎还提供了账密登录的方式，但小程序中未发现相关入口，应该是还在开发中的功能，或许后续可以作为一个实现自动登录、自动获取 token 的突破口。</p><p>顺便也记录一下小程序反编译的步骤（虽然反编译完没有特别大的收获）：</p><p><strong>1. 获取原始包</strong></p><p>首先要拿到小程序的包，一开始用的安卓模拟器去拿，半天没搞定，还贼麻烦，后面发现 PC 微信不也有小程序的包吗？于是直接 PC 微信文件夹里面拿就行了。具体地址是在：<code>wechat files/applet/wx+字母数字/数字/__APP__.wxapkg</code>。可能 applet 文件夹中有很多个小程序文件夹，可以先清空一遍再打开小程序，就会自动重新生成文件夹了。当然也可以按日期排个序，排在最前面的就是了。</p><p><strong>2. 解密原始包</strong></p><p><code>__APP__.wxapkg</code> 是加密的，不能直接解包，所以先用 UnpackMiniApp 解密。这时候会生成一个 wxapp 文件夹，里面有一个以小程序 id 命名的新的 wxapkg 文件</p><p><strong>3. 解包</strong></p><p>使用 wxappUnpacker 解包 wxapkg 文件。在 wxappUnpacker 文件夹下运行 <code>node wuWxapkg.js wxapkg所在路径</code> 即可。最终会在 wxapp 文件夹中输出小程序的源码文件夹。</p><p><strong>4. 导入开发者工具</strong></p><p>打开微信开发者工具，选择导入项目，选择对应文件夹，选择测试号。</p><p>最后是脚本的<a target="_blank" rel="noopener" href="https://github.com/Chorer/YiFuDaoChecker-cloudFunction">地址</a>，有需要的自取。</p></div><div class="post-nav"><div class="post-nav-prev"><a href="/2022/05/19/A-%E5%AE%89%E5%8D%937.0%E7%B3%BB%E7%BB%9F%E6%8A%93%E5%8C%85%E6%96%B9%E6%A1%88/" rel="prev" title="安卓7.0+系统抓包方案"><i class="fa fa-angle-double-left"></i>&nbsp安卓7.0+系统抓包方案</a></div><div class="post-nav-next"><a href="/2021/12/24/T-Chor%20%E7%9A%84%202021%20%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" rel="next" title="Chor 的 2021 年终总结">Chor 的 2021 年终总结&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>function send_valine_Server(){var e="desp=",t=document.title,n=t.indexOf("|"),a=(t.substring(0,n),document.URL),s=new Date,l=document.getElementsByClassName("vnick vinput")[0].value||"Anonymous",i=(document.getElementsByClassName("vmail vinput")[0].value,document.getElementsByClassName("vlink vinput")[0].value,document.getElementsByClassName("veditor vinput")[0].value),o=e+"文章："+a+"\n\n昵称："+l+"\n\n留言："+i+"\n\n时间："+s.toLocaleString(),v=new XMLHttpRequest;v.open("POST","https://sc.ftqq.com/"+SCKEY_Server+".send",!0),v.setRequestHeader("Content-type","application/x-www-form-urlencoded"),v.send(title1+"&"+o)}new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0});var title1="text=你的博客有新的评论",SCKEY_Server="SCT99005TwWJDrDKdBwQGK0YmcPRAsr4B",ValineButton=document.getElementsByClassName("vsubmit vbtn")[0];ValineButton.onclick=send_valine_Server</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2023</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/prism.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/tororo.model.json"},display:{position:"left",width:150,height:300,vOffset:-120,hOffset:-5},mobile:{show:!1},react:{opacityDefault:1e3,opacityOnHover:1e3},log:!1})</script></body></html><!-- rebuild by neat -->