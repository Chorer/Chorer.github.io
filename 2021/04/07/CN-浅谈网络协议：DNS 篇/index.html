<!-- build time:Sun Sep 05 2021 18:35:15 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scaleable=0" name="viewport"><title>Focus on FE learning</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/third%20party/prism.css"><link rel="stylesheet" href="/css/third%20party/jquery.fancybox.css"><link rel="stylesheet" href="/css/third%20party/pace-theme-flash.css"><link rel="icon" href="/images/kour.gif"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body><header class="header"><div class="header_top"><span class="theme"><a href="/">Chor's blog</a></span><nav class="navbar"><ul class="menu"><li class="menu-item"><i class="fa fa-home"></i> <a href="/" class="menu-item-link">首页</a></li><li class="menu-item"><i class="fa fa-folder-open"></i> <a href="/categories" class="menu-item-link">分类</a></li><li class="menu-item"><i class="fa fa-archive"></i> <a href="/archives" class="menu-item-link">归档</a></li><li class="menu-item"><i class="fa fa-tags"></i> <a href="/tags" class="menu-item-link">标签</a></li><li class="menu-item"><i class="fa fa-user"></i> <a href="/about" class="menu-item-link">关于</a></li></ul></nav></div><i id="homelink" data-link="https://chorer.github.io/"></i><div class="header_bottom"><div class="blog-title"><a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue" class="logo">Focus on FE learning</a><div class="descrs"><div class="descr">个人博客</div><div class="descr">" Do what you love,Love what you do "</div></div><div class="blog-down"><a href="javascript:void(0);"><i class="fa fa-angle-double-down fa-2x"></i></a></div></div></div></header><main class="main"><section class="posts"><article class="post_full"><h1 class="post-title"><div class="post-title-link">浅谈网络协议：DNS 篇</div></h1><div class="post-info"><div class="post-date"><i class="fa fa-calendar"></i>&nbsp2021-04-07&nbsp&nbsp&nbsp</div><span class="post-words"><i class="fa fa-pencil-square-o"></i>&nbsp1.8k&nbspwords&nbsp&nbsp </span><span class="post-time"><i class="fa fa-clock-o"></i>&nbsp6 mins&nbsp&nbsp&nbsp</span><div class="post-tags"><i class="fa fa-tags"></i> <a href="/tags/DNS/">DNS</a></div></div><div class="post-content"><div class="figure"><embed src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E6%B5%85%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/%E6%B5%85%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE-1.webp"></div><span id="more"></span><h3 id="dns-的记录">DNS 的记录</h3><p>DNS 中所说的记录，指的是域名和 IP 的对应关系。根据使用场景，有不同类型的记录：</p><ul><li><p>A记录：地址记录。如果一个域名配置了 A 记录，DNS 就会把域名解析成 A 记录指定的 IP 地址。</p></li><li>CNAME 记录：规范名称记录。如果一个域名配置了 CNAME 记录，DNS 就会把域名解析成 CNAME 记录指定的另外一个域名。A 记录和 CNAME 记录是互斥的，不能共存</li><li>NS 记录：域名服务器记录。返回保存下一级域名信息的服务器地址，它指定该域名应该由哪一台 DNS 服务器进行解析。</li><li>MX 记录：邮件记录。返回接收电子邮件的服务器地址。</li><li><p>PTR 记录：逆向查询记录。只用于从IP地址查询域名。</p></li></ul><h3 id="dns-的工作机制未引入-cdn">DNS 的工作机制（未引入 CDN）</h3><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E5%85%B3%E4%BA%8E%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/4.png"></div><p>我们在浏览器中直接输入的是域名，但是浏览器必须知道服务器的 ip 地址，才能建立 tcp 连接并进而发送 http 请求。那么，如何根据服务器域名查找服务器的 ip 地址呢？</p><ol style="list-style-type:decimal"><li>浏览器地址栏中输入 https://join.qq.com，按下回车</li><li>浏览器从 url 中提取出域名 join.qq.com，查找浏览器缓存中（ <a href="chrome://net-internals/#dns" class="uri">chrome://net-internals/#dns</a>）是否存在该域名到 ip 地址的映射。若没有，进入下一步</li><li>查找操作系统缓存中是否存在该域名到 ip 地址的映射（命令行下 ipconfig/displaydns）。若没有，进入下一步</li><li>查找本机的 host 文件是否存在该域名到 ip 地址的映射。若没有，进入下一步</li><li>向本地 dns 发送查询请求，看本地 dns 是否缓存了该域名到 ip 地址的映射。若没有，进入下一步，开始进行域名的迭代解析</li><li>本地 dns 将域名发送给根dns，根dns 发现域名中包含 com，于是返回负责解析 com 的顶级dns的 ip 地址</li><li>本地 dns 将域名发送给顶级dns，顶级dns 发现域名中包含 qq.com，于是返回负责解析 <a target="_blank" rel="noopener" href="http://qq.com/">qq.com</a> 的权威dns的 ip 地址</li><li>本地 dns 将域名发送给权威dns，权威dns 发现域名中包含 join.qq.com，于是查找 A 记录，发现有一条 A 记录保存着 <a target="_blank" rel="noopener" href="http://join.qq.com/">join.qq.com</a> 到 ip 地址的映射，于是返回这个 ip 地址给本地 dns</li><li>本地 dns 将这个 ip 地址回传给浏览器</li><li>自此，浏览器已经拿到了服务器的 ip 地址，于是通过三次握手与服务器建立 tcp 连接，接着发送 http 请求</li></ol><p>PS：顶级 dns 解析的是 .com，权威 dns 解析的是 join.qq.com，那么一开始根 dns 解析的是什么呢？其实它解析的是 .root，.root 是所有域名共有的后缀，即 join.qq.com实际上是 join.qq.com.root，不过一般都是省略不写的。</p><h3 id="dns-的工作机制引入-cdn">DNS 的工作机制（引入 CDN）</h3><p>远距离通信时，通信效率是非常低的，所以一般会使用 CDN —— 在全球多个节点架设代理服务器，客户端就近向代理服务器（而不是源服务器）发送请求。</p><p>关于 CDN，有一些概念要了解一下：</p><ul><li>命中和回源：当 CDN 网络中的节点服务器刚好缓存了客户端所需要的资源，并且没有过期时，则称为命中缓存；否则，节点服务器还是需要转发请求到源服务器，回到源服务器请求资源，这个叫做回源。</li></ul><p>命中和回源各自对应着命中率和回源率，这是衡量 CDN 质量的两个指标。显然，好的 CDN 应该具有较高的命中率，具有较低的回源率。</p><ul><li><p>CDN 的分类：</p></li><li>按照拓扑结构划分：一个是分散式 CDN，即在全球部署尽可能多的代理服务器；另一种是整合式 CDN，只在主要的数据中心有少量节点，但节点性能更强大，包括网络、吞吐量以及抗 DDoS 的能力。</li><li><p>按照内容分发方式划分：一个是 Push CDN，一个是 Pull CDN。前者是由内容服务器提前把内容 push 到 CDN 缓存起来；后者则是在用户访问内容时 CDN 才去 pull 目标资源并缓存起来</p></li></ul><p>由于引入 CDN 之后，我们不再是向源服务器发送请求，所以需要的不再是源服务器的 ip 地址了，因此，DNS 的解析过程也发生了变化。</p><div class="figure"><img src="https://myblog-1258623898.cos.ap-chengdu.myqcloud.com/%E5%85%B3%E4%BA%8E%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/5.png"></div><p>首先，前面的步骤还是一样的：</p><ol style="list-style-type:decimal"><li>浏览器地址栏中输入 <a target="_blank" rel="noopener" href="https://join.qq.com/">https://join.qq.com</a>，按下回车</li><li>浏览器从 url 中提取出域名 <a target="_blank" rel="noopener" href="http://join.qq.com/">join.qq.com</a>，查找浏览器缓存中（ <a href="chrome://net-internals/#dns" class="uri">chrome://net-internals/#dns</a>）是否存在该域名到 ip 地址的映射。若没有，进入下一步</li><li>查找本机缓存中是否存在该域名到 ip 地址的映射（命令行下 ipconfig/displaydns）。若没有，进入下一步</li><li>查找本机的 host 文件是否存在该域名到 ip 地址的映射。若没有，进入下一步</li><li>向本地 dns 发送查询请求，看本地 dns 是否缓存了该域名到 ip 地址的映射。若没有，进入下一步，开始进行域名的迭代解析</li><li>本地 dns 将域名发送给根dns，根dns 发现域名中包含 com，于是返回负责解析 com 的顶级dns的 ip 地址</li><li>本地 dns 将域名发送给顶级dns，顶级dns 发现域名中包含 <a target="_blank" rel="noopener" href="http://qq.com/">qq.com</a>，于是返回负责解析 <a target="_blank" rel="noopener" href="http://qq.com/">qq.com</a> 的权威dns的 ip 地址</li></ol><p>从第八步开始，发生了变化：</p><ol start="8" style="list-style-type:decimal"><li>本地 dns 将域名发送给权威dns，权威dns 发现域名中包含 <a target="_blank" rel="noopener" href="http://join.qq.com/">join.qq.com</a>，于是查找 CNAME 记录和它对应的 A 记录。CNAME 记录的 name 是域名，value 是域名的一个别名，指示着一个全局负载均衡系统（GSLB），而 A 记录的 name 则是这个别名，value 是这个 GSLB 的 ip 地址。权威 dns 最终将这个 ip 地址返回给本地 dns</li><li>本地 dns 向 GSLB 发送请求。GSLB 根据本地 dns 的 ip 地址推测其地理位置，找出这个位置里最佳的本地负载均衡系统（SLB），并将 SLB 的 ip 地址返回给本地 dns</li><li>本地 dns 将这个 ip 地址回传给浏览器</li><li>浏览器向 SLB 发送请求。SLB 综合各种因素（距离、负载情况、响应速度、健康程度等），找出最佳的代理服务器节点，并返回这个节点的 ip 地址</li><li>浏览器向这个节点发送请求</li><li>节点判断自己的缓存中是否有浏览器请求的资源，若有的话是否已经过期，若存在且不过期，则命中；否则需要回源</li></ol><h3 id="dns-优化方案">DNS 优化方案</h3><ol style="list-style-type:decimal"><li>减少 DNS 的请求次数</li><li>DNS 预解析：</li></ol><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x-dns-prefetch-control<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//www.img.com<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//www.api.com<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//www.test.com<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div><div class="post-nav"><div class="post-nav-prev"><a href="/2021/04/07/CN-%E6%B5%85%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%EF%BC%9AHTTP%E7%AF%87/" rel="prev" title="浅谈网络协议：HTTP 篇"><i class="fa fa-angle-double-left"></i>&nbsp浅谈网络协议：HTTP 篇</a></div><div class="post-nav-next"><a href="/2021/02/17/F-Tailwind%20CSS%20%EF%BC%88%E5%8F%AF%E8%83%BD%EF%BC%89%E6%98%AF%E5%90%8D%E8%BF%87%E5%85%B6%E5%AE%9E%E7%9A%84/" rel="next" title="Tailwind CSS （可能）是名过其实的">Tailwind CSS （可能）是名过其实的&nbsp<i class="fa fa-angle-double-right"></i></a></div><div class="clear"></div></div></article><div class="post-toc"><div class="toc-top">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="toc-text">DNS 的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6%E6%9C%AA%E5%BC%95%E5%85%A5-cdn"><span class="toc-text">DNS 的工作机制（未引入 CDN）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6%E5%BC%95%E5%85%A5-cdn"><span class="toc-text">DNS 的工作机制（引入 CDN）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-text">DNS 优化方案</span></a></li></ol></div><div id="vcomments"></div><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"c9Ume1Givsusy6VyqV87iT2z-gzGzoHsz",appKey:"5F7jhJfENet59xDteaKqobSK",notify:!1,verify:!1,placeholder:"Just talk here......",avatar:"retro",pageSize:10,visitor:!0})</script></section></main><script>var user=[1,2,3,4]</script><footer class="footer"><div class="footer-info"><p>Copyright © 2018 - <span>2021</span> My Blog</p><p class="a">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | Theme - <a target="_blank" rel="noopener" href="https://github.com/Chorer/hexo-theme-PureBlue">PureBlue</a></p></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script><script src="/js/navbar.js"></script><script src="/js/pace.min.js"></script><script src="/js/code.js"></script><script src="/js/load.js"></script><script src="/js/search.js"></script><script src="/js/post-except.js"></script><script src="/js/jquery.fancybox.js"></script><script src="/js/jquery.fancyboxStart.js"></script><script src="/js/toc.js"></script><script src="/js/jquery.toTop.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script><script src="/js/IndexToTop.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cd8f8959eacf92e"></script></body></html><!-- rebuild by neat -->